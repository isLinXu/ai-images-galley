<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI智能相册系统</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Inter', sans-serif;
        }
        
        :root {
            --primary-color: #3B82F6;
            --secondary-color: #10B981;
            --accent-color: #F59E0B;
            --background-color: rgba(255, 255, 255, 0.95);
            --surface-color: rgba(255, 255, 255, 0.9);
            --text-color: #1F2937;
            --text-secondary: #6B7280;
            --border-color: #E5E7EB;
            --shadow-color: rgba(0, 0, 0, 0.1);
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text-color);
        }

        .glass-effect {
            backdrop-filter: blur(10px);
            background: var(--surface-color);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .text-with-shadow {
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .high-contrast-text {
            color: #000 !important;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
        }

        .high-contrast-text-light {
            color: #fff !important;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }

        .ai-badge {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .confidence-bar {
            background: linear-gradient(90deg, #10B981 0%, #F59E0B 50%, #EF4444 100%);
            height: 4px;
            border-radius: 2px;
            overflow: hidden;
        }

        .tag-item {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: white;
            font-weight: 500;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .image-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid transparent;
        }

        .image-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            border-color: var(--primary-color);
        }

        .ai-analysis-preview {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.9), rgba(16, 185, 129, 0.9));
            backdrop-filter: blur(8px);
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .modal-overlay {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
        }

        .theme-btn {
            background: var(--surface-color);
            border: 2px solid var(--border-color);
            color: var(--text-color);
            font-weight: 600;
            transition: all 0.2s;
        }

        .theme-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .admin-btn {
            background: linear-gradient(45deg, #EF4444, #F59E0B);
            color: white;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid white;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .gradient-text {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
        }

        /* 高对比度主题 */
        .dark-theme {
            --background-color: rgba(17, 24, 39, 0.95);
            --surface-color: rgba(31, 41, 55, 0.9);
            --text-color: #F9FAFB;
            --text-secondary: #D1D5DB;
            --border-color: #374151;
        }

        .dark-theme .high-contrast-text {
            color: #F9FAFB !important;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .grid-responsive {
                grid-template-columns: 1fr;
            }
            
            .text-responsive {
                font-size: 0.875rem;
            }
        }

        @media (min-width: 768px) {
            .grid-responsive {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 1024px) {
            .grid-responsive {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (min-width: 1280px) {
            .grid-responsive {
                grid-template-columns: repeat(4, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- 主导航栏 -->
    <nav class="glass-effect sticky top-0 z-50 border-b border-white/20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-4">
                    <h1 class="text-2xl font-bold gradient-text">
                        <i class="fas fa-brain mr-2"></i>AI智能相册
                    </h1>
                    <span class="ai-badge px-3 py-1 rounded-full text-sm">
                        <i class="fas fa-robot mr-1"></i>智能分析
                    </span>
                </div>
                
                <div class="flex items-center space-x-3">
                    <!-- 主题切换按钮 -->
                    <button id="theme-toggle" class="theme-btn px-4 py-2 rounded-lg">
                        <i class="fas fa-palette mr-2"></i>主题
                    </button>
                    
                    <!-- 用户状态 -->
                    <div id="user-status" class="flex items-center space-x-2">
                        <span class="high-contrast-text font-medium">游客模式</span>
                        <button id="admin-login-btn" class="theme-btn px-4 py-2 rounded-lg">
                            <i class="fas fa-sign-in-alt mr-2"></i>管理员登录
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- 功能导航 -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <div class="glass-effect rounded-xl p-4">
            <div class="flex flex-wrap gap-3 justify-center">
                <button onclick="showTab('gallery')" class="tab-btn theme-btn px-6 py-3 rounded-lg active">
                    <i class="fas fa-images mr-2"></i>图片浏览
                </button>
                <button onclick="showTab('ai-analysis')" class="tab-btn theme-btn px-6 py-3 rounded-lg">
                    <i class="fas fa-brain mr-2"></i>AI分析
                </button>
                <button onclick="showTab('galleries')" class="tab-btn theme-btn px-6 py-3 rounded-lg">
                    <i class="fas fa-folder mr-2"></i>画廊管理
                </button>
                <button onclick="showTab('upload')" class="tab-btn admin-only theme-btn px-6 py-3 rounded-lg" style="display: none;">
                    <i class="fas fa-upload mr-2"></i>上传管理
                </button>
                <button onclick="showTab('settings')" class="tab-btn theme-btn px-6 py-3 rounded-lg">
                    <i class="fas fa-cog mr-2"></i>设置
                </button>
            </div>
        </div>
    </div>

    <!-- 主内容区域 -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-8">
        <!-- 图片浏览标签页 -->
        <div id="gallery-tab" class="tab-content">
            <!-- 搜索和过滤 -->
            <div class="glass-effect rounded-xl p-6 mb-6">
                <div class="flex flex-col lg:flex-row gap-4">
                    <div class="flex-1">
                        <input type="text" id="search-input" placeholder="🔍 搜索图片、标签或描述..." 
                               class="w-full px-4 py-3 rounded-lg border-2 border-gray-200 focus:border-blue-500 focus:outline-none high-contrast-text bg-white/90">
                    </div>
                    <div class="flex gap-3">
                        <select id="tag-filter" class="px-4 py-3 rounded-lg border-2 border-gray-200 focus:border-blue-500 focus:outline-none high-contrast-text bg-white/90">
                            <option value="">所有标签</option>
                        </select>
                        <select id="sort-option" class="px-4 py-3 rounded-lg border-2 border-gray-200 focus:border-blue-500 focus:outline-none high-contrast-text bg-white/90">
                            <option value="newest">最新</option>
                            <option value="oldest">最旧</option>
                            <option value="name">名称</option>
                            <option value="ai-score">AI评分</option>
                        </select>
                        <button onclick="refreshGallery()" class="theme-btn px-6 py-3 rounded-lg">
                            <i class="fas fa-sync-alt mr-2"></i>刷新
                        </button>
                    </div>
                </div>
            </div>

            <!-- 加载状态 -->
            <div id="loading-indicator" class="glass-effect rounded-xl p-8 text-center">
                <div class="loading-spinner mx-auto mb-4"></div>
                <p class="high-contrast-text text-lg font-medium">正在加载图片和AI分析...</p>
            </div>

            <!-- 图片网格 -->
            <div id="images-grid" class="grid grid-responsive gap-6" style="display: none;">
                <!-- 图片卡片将在这里动态生成 -->
            </div>

            <!-- 无图片提示 -->
            <div id="no-images" class="glass-effect rounded-xl p-12 text-center" style="display: none;">
                <i class="fas fa-images text-6xl text-gray-400 mb-4"></i>
                <h3 class="high-contrast-text text-xl font-semibold mb-2">暂无图片</h3>
                <p class="high-contrast-text opacity-75">请将图片添加到 images 文件夹或通过管理员上传</p>
            </div>
        </div>

        <!-- AI分析标签页 -->
        <div id="ai-analysis-tab" class="tab-content hidden">
            <div class="glass-effect rounded-xl p-6">
                <h2 class="text-2xl font-bold high-contrast-text mb-6">
                    <i class="fas fa-brain mr-3"></i>AI分析统计
                </h2>
                
                <div class="grid md:grid-cols-3 gap-6 mb-8">
                    <div class="glass-effect rounded-xl p-6 text-center">
                        <i class="fas fa-eye text-4xl text-blue-500 mb-3"></i>
                        <h3 class="high-contrast-text text-lg font-semibold">检测到的物体</h3>
                        <p id="objects-count" class="text-3xl font-bold text-blue-500">0</p>
                    </div>
                    <div class="glass-effect rounded-xl p-6 text-center">
                        <i class="fas fa-landscape text-4xl text-green-500 mb-3"></i>
                        <h3 class="high-contrast-text text-lg font-semibold">场景类型</h3>
                        <p id="scenes-count" class="text-3xl font-bold text-green-500">0</p>
                    </div>
                    <div class="glass-effect rounded-xl p-6 text-center">
                        <i class="fas fa-tags text-4xl text-yellow-500 mb-3"></i>
                        <h3 class="high-contrast-text text-lg font-semibold">自动标签</h3>
                        <p id="tags-count" class="text-3xl font-bold text-yellow-500">0</p>
                    </div>
                </div>

                <div id="ai-analysis-details" class="space-y-6">
                    <!-- AI分析详情将在这里显示 -->
                </div>
            </div>
        </div>

        <!-- 其他标签页内容 -->
        <div id="galleries-tab" class="tab-content hidden">
            <div class="glass-effect rounded-xl p-6">
                <h2 class="text-2xl font-bold high-contrast-text mb-6">
                    <i class="fas fa-folder mr-3"></i>画廊管理
                </h2>
                <p class="high-contrast-text">画廊管理功能开发中...</p>
            </div>
        </div>

        <div id="upload-tab" class="tab-content hidden">
            <div class="glass-effect rounded-xl p-6">
                <h2 class="text-2xl font-bold high-contrast-text mb-6">
                    <i class="fas fa-upload mr-3"></i>上传管理
                </h2>
                <p class="high-contrast-text">上传管理功能开发中...</p>
            </div>
        </div>

        <div id="settings-tab" class="tab-content hidden">
            <div class="glass-effect rounded-xl p-6">
                <h2 class="text-2xl font-bold high-contrast-text mb-6">
                    <i class="fas fa-cog mr-3"></i>系统设置
                </h2>
                <div class="space-y-6">
                    <!-- 主题设置 -->
                    <div>
                        <h3 class="high-contrast-text text-lg font-semibold mb-4">主题设置</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="theme-options">
                            <!-- 主题选项将在这里生成 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 图片详情模态框 -->
    <div id="image-detail-modal" class="fixed inset-0 modal-overlay z-50 hidden flex items-center justify-center p-4">
        <div class="glass-effect rounded-2xl max-w-6xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="modal-title" class="text-2xl font-bold high-contrast-text">图片详情</h2>
                    <button onclick="closeImageModal()" class="text-gray-500 hover:text-gray-700 text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="grid lg:grid-cols-2 gap-8">
                    <!-- 左侧：图片显示 -->
                    <div>
                        <img id="modal-image" class="w-full h-auto rounded-xl shadow-lg" alt="">
                        <div class="mt-4 text-center">
                            <button onclick="downloadCurrentImage()" class="theme-btn px-6 py-3 rounded-lg mr-3">
                                <i class="fas fa-download mr-2"></i>下载
                            </button>
                            <button onclick="shareCurrentImage()" class="theme-btn px-6 py-3 rounded-lg">
                                <i class="fas fa-share mr-2"></i>分享
                            </button>
                        </div>
                    </div>
                    
                    <!-- 右侧：详细信息 -->
                    <div class="space-y-6">
                        <!-- AI分析结果 -->
                        <div>
                            <h3 class="high-contrast-text text-lg font-semibold mb-4">
                                <i class="fas fa-brain mr-2"></i>AI分析结果
                            </h3>
                            <div id="modal-ai-analysis" class="space-y-4">
                                <!-- AI分析结果将在这里显示 -->
                            </div>
                        </div>
                        
                        <!-- 标签 -->
                        <div>
                            <h3 class="high-contrast-text text-lg font-semibold mb-4">
                                <i class="fas fa-tags mr-2"></i>标签
                            </h3>
                            <div id="modal-tags" class="flex flex-wrap gap-2 mb-4">
                                <!-- 标签将在这里显示 -->
                            </div>
                            <div class="admin-only" style="display: none;">
                                <input type="text" id="new-tag-input" placeholder="添加新标签..." 
                                       class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:border-blue-500 focus:outline-none high-contrast-text bg-white/90"
                                       onkeypress="handleTagInput(event)">
                            </div>
                        </div>
                        
                        <!-- 描述 -->
                        <div>
                            <h3 class="high-contrast-text text-lg font-semibold mb-4">
                                <i class="fas fa-align-left mr-2"></i>描述
                            </h3>
                            <textarea id="modal-description" rows="4" placeholder="图片描述..." 
                                      class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:border-blue-500 focus:outline-none high-contrast-text bg-white/90 resize-none"
                                      readonly></textarea>
                            <div class="admin-only mt-2" style="display: none;">
                                <button onclick="saveImageDescription()" class="admin-btn px-4 py-2 rounded-lg">
                                    <i class="fas fa-save mr-2"></i>保存描述
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 管理员登录模态框 -->
    <div id="admin-login-modal" class="fixed inset-0 modal-overlay z-50 hidden flex items-center justify-center p-4">
        <div class="glass-effect rounded-2xl max-w-md w-full p-6">
            <h2 class="text-2xl font-bold high-contrast-text mb-6 text-center">
                <i class="fas fa-key mr-2"></i>管理员登录
            </h2>
            <form onsubmit="handleAdminLogin(event)">
                <div class="mb-4">
                    <label class="block high-contrast-text text-sm font-semibold mb-2">GitHub Personal Access Token:</label>
                    <input type="password" id="github-token" placeholder="输入您的GitHub Token..." 
                           class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:border-blue-500 focus:outline-none high-contrast-text bg-white/90"
                           required>
                </div>
                <div class="flex gap-3">
                    <button type="submit" class="flex-1 admin-btn px-6 py-3 rounded-lg font-semibold">
                        <i class="fas fa-sign-in-alt mr-2"></i>登录
                    </button>
                    <button type="button" onclick="closeAdminModal()" class="flex-1 theme-btn px-6 py-3 rounded-lg">
                        取消
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // 全局变量
        let currentImages = [];
        let isAdmin = false;
        let currentImageIndex = 0;
        let aiAnalysisResults = new Map();
        let themeSettings = {
            background: 'default',
            uiTheme: 'light'
        };

        // AI分析引擎
        class AIAnalysisEngine {
            async analyzeImage(imageFile, imageElement) {
                console.log('🤖 开始AI分析:', imageFile?.name || 'unknown');
                
                try {
                    const analysisResults = {
                        objects: await this.detectObjects(imageElement),
                        scenes: await this.classifyScene(imageElement),
                        emotions: await this.analyzeEmotions(imageElement),
                        colors: await this.extractColors(imageElement),
                        smartTags: [],
                        confidence: 0,
                        timestamp: Date.now()
                    };
                    
                    analysisResults.smartTags = this.generateSmartTags(analysisResults);
                    analysisResults.confidence = this.calculateOverallConfidence(analysisResults);
                    
                    console.log('✅ AI分析完成:', analysisResults);
                    return analysisResults;
                } catch (error) {
                    console.error('AI分析失败:', error);
                    return this.getDefaultAnalysis();
                }
            }

            async detectObjects(imageElement) {
                if (!imageElement) return [];
                
                try {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = imageElement.naturalWidth || 400;
                    canvas.height = imageElement.naturalHeight || 300;
                    ctx.drawImage(imageElement, 0, 0);
                    
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const brightness = this.calculateBrightness(imageData);
                    const colorDistribution = this.analyzeColorDistribution(imageData);
                    
                    const detectedObjects = [];
                    
                    if (brightness > 150) {
                        detectedObjects.push({ label: '明亮场景', confidence: 0.85, category: 'environment' });
                        detectedObjects.push({ label: '户外', confidence: 0.75, category: 'location' });
                    } else if (brightness < 80) {
                        detectedObjects.push({ label: '室内', confidence: 0.80, category: 'location' });
                        detectedObjects.push({ label: '夜景', confidence: 0.70, category: 'time' });
                    }
                    
                    if (colorDistribution.green > 0.3) {
                        detectedObjects.push({ label: '植物', confidence: 0.82, category: 'nature' });
                        detectedObjects.push({ label: '自然', confidence: 0.78, category: 'scene' });
                    }
                    
                    if (colorDistribution.blue > 0.25) {
                        detectedObjects.push({ label: '天空', confidence: 0.85, category: 'nature' });
                        detectedObjects.push({ label: '水体', confidence: 0.65, category: 'nature' });
                    }
                    
                    if (colorDistribution.skin > 0.15) {
                        detectedObjects.push({ label: '人物', confidence: 0.88, category: 'person' });
                        detectedObjects.push({ label: '肖像', confidence: 0.72, category: 'style' });
                    }
                    
                    return detectedObjects;
                } catch (error) {
                    return [{ label: '未知物体', confidence: 0.5, category: 'unknown' }];
                }
            }

            async classifyScene(imageElement) {
                if (!imageElement) return [];
                
                const scenes = [];
                try {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = imageElement.naturalWidth || 400;
                    canvas.height = imageElement.naturalHeight || 300;
                    ctx.drawImage(imageElement, 0, 0);
                    
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const brightness = this.calculateBrightness(imageData);
                    const contrast = this.calculateContrast(imageData);
                    const colorComplexity = this.calculateColorComplexity(imageData);
                    
                    if (brightness > 140 && colorComplexity > 0.6) {
                        scenes.push({ label: '户外风景', confidence: 0.87 });
                        scenes.push({ label: '自然景观', confidence: 0.82 });
                    }
                    
                    if (contrast > 50 && brightness < 100) {
                        scenes.push({ label: '室内拍摄', confidence: 0.78 });
                        scenes.push({ label: '人工照明', confidence: 0.70 });
                    }
                    
                    if (colorComplexity < 0.3) {
                        scenes.push({ label: '简约风格', confidence: 0.75 });
                    }
                    
                    return scenes;
                } catch (error) {
                    return [{ label: '未知场景', confidence: 0.50 }];
                }
            }

            async analyzeEmotions(imageElement) {
                if (!imageElement) return [];
                
                try {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = imageElement.naturalWidth || 400;
                    canvas.height = imageElement.naturalHeight || 300;
                    ctx.drawImage(imageElement, 0, 0);
                    
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const colorTone = this.analyzeColorTone(imageData);
                    const brightness = this.calculateBrightness(imageData);
                    
                    const emotions = [];
                    
                    if (colorTone.warm > 0.6 && brightness > 120) {
                        emotions.push({ label: '快乐', confidence: 0.82, color: '#FFD700' });
                        emotions.push({ label: '温暖', confidence: 0.78, color: '#FF6B35' });
                    }
                    
                    if (colorTone.cool > 0.6) {
                        emotions.push({ label: '平静', confidence: 0.75, color: '#4A90E2' });
                        emotions.push({ label: '宁静', confidence: 0.70, color: '#5DADE2' });
                    }
                    
                    if (brightness < 80) {
                        emotions.push({ label: '神秘', confidence: 0.68, color: '#6C5CE7' });
                    }
                    
                    return emotions;
                } catch (error) {
                    return [{ label: '中性', confidence: 0.60, color: '#95A5A6' }];
                }
            }

            async extractColors(imageElement) {
                if (!imageElement) return [];
                
                try {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = imageElement.naturalWidth || 400;
                    canvas.height = imageElement.naturalHeight || 300;
                    ctx.drawImage(imageElement, 0, 0);
                    
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;
                    const colorCounts = {};
                    
                    for (let i = 0; i < data.length; i += 16) {
                        const r = Math.round(data[i] / 32) * 32;
                        const g = Math.round(data[i + 1] / 32) * 32;
                        const b = Math.round(data[i + 2] / 32) * 32;
                        const key = `${r},${g},${b}`;
                        
                        colorCounts[key] = (colorCounts[key] || 0) + 1;
                    }
                    
                    const dominantColors = Object.entries(colorCounts)
                        .sort(([,a], [,b]) => b - a)
                        .slice(0, 5)
                        .map(([rgb, count]) => {
                            const [r, g, b] = rgb.split(',').map(Number);
                            return {
                                rgb: `rgb(${r},${g},${b})`,
                                hex: this.rgbToHex(r, g, b),
                                count: count,
                                percentage: Math.round((count / (data.length / 4)) * 100),
                                name: this.getColorName(r, g, b),
                                brightness: Math.round((r + g + b) / 3)
                            };
                        });
                    
                    return dominantColors;
                } catch (error) {
                    return [];
                }
            }

            generateSmartTags(analysisResults) {
                const tags = new Set();
                
                analysisResults.objects.forEach(obj => {
                    if (obj.confidence > 0.65) {
                        tags.add(obj.label);
                    }
                });
                
                analysisResults.scenes.forEach(scene => {
                    if (scene.confidence > 0.70) {
                        tags.add(scene.label);
                    }
                });
                
                if (analysisResults.emotions.length > 0) {
                    const dominantEmotion = analysisResults.emotions[0];
                    if (dominantEmotion.confidence > 0.60) {
                        tags.add(dominantEmotion.label);
                    }
                }
                
                if (analysisResults.colors.length > 0) {
                    const dominantColor = analysisResults.colors[0];
                    tags.add(dominantColor.name);
                }
                
                return Array.from(tags);
            }

            // 辅助函数
            calculateBrightness(imageData) {
                const data = imageData.data;
                let sum = 0;
                for (let i = 0; i < data.length; i += 4) {
                    sum += (data[i] + data[i + 1] + data[i + 2]) / 3;
                }
                return sum / (data.length / 4);
            }

            calculateContrast(imageData) {
                const data = imageData.data;
                const values = [];
                for (let i = 0; i < data.length; i += 4) {
                    values.push((data[i] + data[i + 1] + data[i + 2]) / 3);
                }
                
                const mean = values.reduce((a, b) => a + b) / values.length;
                const variance = values.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / values.length;
                return Math.sqrt(variance);
            }

            calculateColorComplexity(imageData) {
                const data = imageData.data;
                const colors = new Set();
                for (let i = 0; i < data.length; i += 16) {
                    const r = Math.round(data[i] / 64) * 64;
                    const g = Math.round(data[i + 1] / 64) * 64;
                    const b = Math.round(data[i + 2] / 64) * 64;
                    colors.add(`${r},${g},${b}`);
                }
                return colors.size / 64; // 归一化
            }

            analyzeColorDistribution(imageData) {
                const data = imageData.data;
                let green = 0, blue = 0, skin = 0, total = 0;
                
                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];
                    
                    if (g > r && g > b && g > 100) green++;
                    if (b > r && b > g && b > 100) blue++;
                    if (r > 95 && g > 40 && b > 20 && r > g && r > b) skin++;
                    total++;
                }
                
                return {
                    green: green / total,
                    blue: blue / total,
                    skin: skin / total
                };
            }

            analyzeColorTone(imageData) {
                const data = imageData.data;
                let warm = 0, cool = 0, vibrant = 0, total = 0;
                
                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];
                    
                    if (r > b) warm++;
                    if (b > r) cool++;
                    if (Math.max(r, g, b) - Math.min(r, g, b) > 100) vibrant++;
                    total++;
                }
                
                return {
                    warm: warm / total,
                    cool: cool / total,
                    vibrant: vibrant / total
                };
            }

            rgbToHex(r, g, b) {
                return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
            }

            getColorName(r, g, b) {
                const colorNames = {
                    red: [255, 0, 0],
                    green: [0, 255, 0],
                    blue: [0, 0, 255],
                    yellow: [255, 255, 0],
                    purple: [128, 0, 128],
                    orange: [255, 165, 0],
                    pink: [255, 192, 203],
                    brown: [165, 42, 42],
                    black: [0, 0, 0],
                    white: [255, 255, 255],
                    gray: [128, 128, 128]
                };
                
                let closestColor = 'unknown';
                let minDistance = Infinity;
                
                for (const [name, [cr, cg, cb]] of Object.entries(colorNames)) {
                    const distance = Math.sqrt(Math.pow(r - cr, 2) + Math.pow(g - cg, 2) + Math.pow(b - cb, 2));
                    if (distance < minDistance) {
                        minDistance = distance;
                        closestColor = name;
                    }
                }
                
                return closestColor;
            }

            calculateOverallConfidence(results) {
                const confidences = [
                    ...results.objects.map(o => o.confidence),
                    ...results.scenes.map(s => s.confidence),
                    ...results.emotions.map(e => e.confidence)
                ];
                
                return confidences.length > 0 ? 
                    confidences.reduce((a, b) => a + b) / confidences.length : 0;
            }

            getDefaultAnalysis() {
                return {
                    objects: [{ label: '未知物体', confidence: 0.5, category: 'unknown' }],
                    scenes: [{ label: '未知场景', confidence: 0.5 }],
                    emotions: [{ label: '中性', confidence: 0.5, color: '#95A5A6' }],
                    colors: [],
                    smartTags: ['图片'],
                    confidence: 0.5,
                    timestamp: Date.now()
                };
            }
        }

        // 图片加载器
        class ImageLoader {
            constructor() {
                this.aiEngine = new AIAnalysisEngine();
            }

            async loadAllImages() {
                console.log('🔍 开始扫描图片...');
                
                const strategies = [
                    this.loadFromGitHubAPI(),
                    this.loadFromDirectoryIndex(),
                    this.loadWithProbing(),
                    this.loadExampleImages()
                ];
                
                const results = await Promise.allSettled(strategies);
                let allImages = [];
                
                results.forEach((result, index) => {
                    if (result.status === 'fulfilled' && result.value.length > 0) {
                        console.log(`策略 ${index + 1} 加载了 ${result.value.length} 张图片`);
                        allImages = allImages.concat(result.value);
                    }
                });
                
                // 去重
                const uniqueImages = this.removeDuplicates(allImages);
                console.log(`总共加载了 ${uniqueImages.length} 张图片`);
                
                // 自动进行AI分析
                await this.performAIAnalysis(uniqueImages);
                
                return uniqueImages;
            }

            async loadFromGitHubAPI() {
                try {
                    const response = await fetch('https://api.github.com/repos/isLinXu/ai-images-galley/contents/images');
                    if (!response.ok) throw new Error('GitHub API请求失败');
                    
                    const files = await response.json();
                    const imageFiles = files.filter(file => 
                        file.type === 'file' && 
                        /\.(jpg|jpeg|png|gif|webp|bmp|svg)$/i.test(file.name)
                    );
                    
                    return imageFiles.map(file => ({
                        id: file.sha,
                        name: file.name,
                        url: `images/${file.name}`,
                        downloadUrl: file.download_url,
                        size: file.size,
                        loadMethod: 'GitHub API'
                    }));
                } catch (error) {
                    console.log('GitHub API加载失败，尝试其他方法');
                    return [];
                }
            }

            async loadFromDirectoryIndex() {
                try {
                    const response = await fetch('images/');
                    if (!response.ok) throw new Error('目录索引不可用');
                    
                    const html = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const links = doc.querySelectorAll('a[href]');
                    
                    const imageFiles = [];
                    links.forEach(link => {
                        const href = link.getAttribute('href');
                        if (href && /\.(jpg|jpeg|png|gif|webp|bmp|svg)$/i.test(href)) {
                            imageFiles.push({
                                id: href,
                                name: href,
                                url: `images/${href}`,
                                loadMethod: 'Directory Index'
                            });
                        }
                    });
                    
                    return imageFiles;
                } catch (error) {
                    console.log('目录索引加载失败');
                    return [];
                }
            }

            async loadWithProbing() {
                const commonNames = [
                    'photo1.jpg', 'photo2.jpg', 'photo3.jpg', 'photo4.jpg', 'photo5.jpg',
                    'image1.png', 'image2.png', 'image3.png', 'image4.png', 'image5.png',
                    'pic1.jpg', 'pic2.jpg', 'pic3.jpg',
                    'test.jpg', 'sample.png', 'demo.jpg'
                ];
                
                const validImages = [];
                
                for (let i = 0; i < commonNames.length; i += 3) {
                    const batch = commonNames.slice(i, i + 3);
                    const results = await Promise.all(
                        batch.map(name => this.checkImageExists(name))
                    );
                    
                    results.forEach(result => {
                        if (result) validImages.push(result);
                    });
                }
                
                return validImages;
            }

            async loadExampleImages() {
                // 使用一些在线示例图片作为演示
                const exampleImages = [
                    {
                        id: 'example1',
                        name: '示例图片1.jpg',
                        url: 'https://picsum.photos/400/300?random=1',
                        loadMethod: '在线示例'
                    },
                    {
                        id: 'example2',
                        name: '示例图片2.jpg',
                        url: 'https://picsum.photos/400/300?random=2',
                        loadMethod: '在线示例'
                    },
                    {
                        id: 'example3',
                        name: '示例图片3.jpg',
                        url: 'https://picsum.photos/400/300?random=3',
                        loadMethod: '在线示例'
                    },
                    {
                        id: 'example4',
                        name: '示例图片4.jpg',
                        url: 'https://picsum.photos/400/300?random=4',
                        loadMethod: '在线示例'
                    }
                ];
                
                return exampleImages;
            }

            async checkImageExists(filename) {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => resolve({
                        id: filename,
                        name: filename,
                        url: `images/${filename}`,
                        loadMethod: '文件探测'
                    });
                    img.onerror = () => resolve(null);
                    img.src = `images/${filename}`;
                });
            }

            removeDuplicates(images) {
                const seen = new Set();
                return images.filter(img => {
                    if (seen.has(img.name)) return false;
                    seen.add(img.name);
                    return true;
                });
            }

            async performAIAnalysis(images) {
                console.log('🤖 开始批量AI分析...');
                
                for (const image of images) {
                    try {
                        // 创建图片元素进行分析
                        const imgElement = new Image();
                        imgElement.crossOrigin = 'anonymous';
                        
                        await new Promise((resolve, reject) => {
                            imgElement.onload = resolve;
                            imgElement.onerror = reject;
                            imgElement.src = image.url;
                        });
                        
                        // 进行AI分析
                        const analysis = await this.aiEngine.analyzeImage(null, imgElement);
                        aiAnalysisResults.set(image.id, analysis);
                        
                        console.log(`✅ ${image.name} AI分析完成`);
                    } catch (error) {
                        console.warn(`⚠️ ${image.name} AI分析失败:`, error);
                        // 设置默认分析结果
                        aiAnalysisResults.set(image.id, this.aiEngine.getDefaultAnalysis());
                    }
                }
                
                console.log(`🎉 批量AI分析完成，共分析 ${images.length} 张图片`);
            }
        }

        // 初始化应用
        const imageLoader = new ImageLoader();

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 初始化AI智能相册...');
            
            // 检查管理员状态
            checkAdminStatus();
            
            // 初始化主题
            initializeThemes();
            
            // 加载图片
            await loadImages();
            
            // 绑定事件
            bindEvents();
            
            console.log('✅ 初始化完成');
        });

        // 检查管理员状态
        function checkAdminStatus() {
            const token = localStorage.getItem('github_token');
            const adminStatus = localStorage.getItem('admin_status');
            
            if (token && adminStatus === 'true') {
                setAdminMode(true);
            } else {
                setGuestMode();
            }
        }

        // 设置管理员模式
        function setAdminMode(admin) {
            isAdmin = admin;
            
            const adminElements = document.querySelectorAll('.admin-only');
            const userStatus = document.getElementById('user-status');
            
            adminElements.forEach(el => {
                el.style.display = admin ? 'block' : 'none';
            });
            
            if (admin) {
                userStatus.innerHTML = `
                    <span class="high-contrast-text font-medium">管理员模式</span>
                    <button onclick="logout()" class="admin-btn px-4 py-2 rounded-lg">
                        <i class="fas fa-sign-out-alt mr-2"></i>退出登录
                    </button>
                `;
            } else {
                userStatus.innerHTML = `
                    <span class="high-contrast-text font-medium">游客模式</span>
                    <button onclick="showAdminLogin()" class="theme-btn px-4 py-2 rounded-lg">
                        <i class="fas fa-sign-in-alt mr-2"></i>管理员登录
                    </button>
                `;
            }
        }

        // 设置游客模式
        function setGuestMode() {
            setAdminMode(false);
        }

        // 显示管理员登录
        function showAdminLogin() {
            document.getElementById('admin-login-modal').classList.remove('hidden');
        }

        // 关闭管理员登录模态框
        function closeAdminModal() {
            document.getElementById('admin-login-modal').classList.add('hidden');
            document.getElementById('github-token').value = '';
        }

        // 处理管理员登录
        async function handleAdminLogin(event) {
            event.preventDefault();
            
            const token = document.getElementById('github-token').value.trim();
            if (!token) {
                alert('请输入GitHub Token');
                return;
            }
            
            try {
                // 验证Token
                const response = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    localStorage.setItem('github_token', token);
                    localStorage.setItem('admin_status', 'true');
                    setAdminMode(true);
                    closeAdminModal();
                    alert('✅ 管理员登录成功！');
                } else {
                    alert('❌ GitHub Token验证失败，请检查Token是否正确');
                }
            } catch (error) {
                alert('❌ 网络错误，请稍后重试');
                console.error('登录失败:', error);
            }
        }

        // 退出登录
        function logout() {
            localStorage.removeItem('github_token');
            localStorage.removeItem('admin_status');
            setGuestMode();
            alert('已退出管理员模式');
        }

        // 加载图片
        async function loadImages() {
            const loadingIndicator = document.getElementById('loading-indicator');
            const imagesGrid = document.getElementById('images-grid');
            const noImages = document.getElementById('no-images');
            
            loadingIndicator.style.display = 'block';
            imagesGrid.style.display = 'none';
            noImages.style.display = 'none';
            
            try {
                currentImages = await imageLoader.loadAllImages();
                
                if (currentImages.length > 0) {
                    renderImages(currentImages);
                    updateAIStatistics();
                    imagesGrid.style.display = 'grid';
                } else {
                    noImages.style.display = 'block';
                }
            } catch (error) {
                console.error('加载图片失败:', error);
                noImages.style.display = 'block';
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }

        // 渲染图片
        function renderImages(images) {
            const grid = document.getElementById('images-grid');
            grid.innerHTML = '';
            
            images.forEach((image, index) => {
                const imageCard = createImageCard(image, index);
                grid.appendChild(imageCard);
            });
        }

        // 创建图片卡片
        function createImageCard(image, index) {
            const card = document.createElement('div');
            card.className = 'image-card glass-effect rounded-xl overflow-hidden cursor-pointer';
            card.onclick = () => openImageModal(index);
            
            const analysis = aiAnalysisResults.get(image.id);
            
            card.innerHTML = `
                <div class="relative">
                    <img src="${image.url}" alt="${image.name}" 
                         class="w-full h-48 object-cover"
                         onerror="this.src='https://via.placeholder.com/400x300?text=图片加载失败'">
                    
                    <!-- AI分析预览 -->
                    <div class="ai-analysis-preview absolute top-2 right-2 px-3 py-1 rounded-lg text-xs">
                        <i class="fas fa-brain mr-1"></i>
                        AI: ${analysis ? Math.round(analysis.confidence * 100) : 0}%
                    </div>
                    
                    <!-- 标签预览 -->
                    ${analysis && analysis.smartTags.length > 0 ? `
                        <div class="absolute bottom-2 left-2 right-2">
                            <div class="flex flex-wrap gap-1">
                                ${analysis.smartTags.slice(0, 3).map(tag => `
                                    <span class="tag-item px-2 py-1 rounded text-xs">${tag}</span>
                                `).join('')}
                                ${analysis.smartTags.length > 3 ? `
                                    <span class="tag-item px-2 py-1 rounded text-xs">+${analysis.smartTags.length - 3}</span>
                                ` : ''}
                            </div>
                        </div>
                    ` : ''}
                </div>
                
                <div class="p-4">
                    <h3 class="high-contrast-text font-semibold text-lg mb-2 truncate">${image.name}</h3>
                    <div class="flex items-center justify-between text-sm">
                        <span class="high-contrast-text opacity-75">${image.loadMethod}</span>
                        <div class="flex items-center space-x-2">
                            <button onclick="event.stopPropagation(); downloadImage('${image.url}', '${image.name}')" 
                                    class="text-blue-500 hover:text-blue-700">
                                <i class="fas fa-download"></i>
                            </button>
                            <button onclick="event.stopPropagation(); shareImage('${image.id}')" 
                                    class="text-green-500 hover:text-green-700">
                                <i class="fas fa-share"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- AI分析简要信息 -->
                    ${analysis ? `
                        <div class="mt-3 pt-3 border-t border-gray-200">
                            <div class="text-xs high-contrast-text opacity-75 space-y-1">
                                ${analysis.objects.length > 0 ? `
                                    <div><i class="fas fa-eye mr-1"></i>物体: ${analysis.objects[0].label}</div>
                                ` : ''}
                                ${analysis.emotions.length > 0 ? `
                                    <div><i class="fas fa-heart mr-1"></i>情感: ${analysis.emotions[0].label}</div>
                                ` : ''}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            return card;
        }

        // 打开图片模态框
        function openImageModal(index) {
            currentImageIndex = index;
            const image = currentImages[index];
            const analysis = aiAnalysisResults.get(image.id);
            
            document.getElementById('modal-title').textContent = image.name;
            document.getElementById('modal-image').src = image.url;
            
            // 显示AI分析结果
            displayModalAIAnalysis(analysis);
            
            // 显示标签
            displayModalTags(analysis ? analysis.smartTags : []);
            
            // 显示描述
            const descriptionTextarea = document.getElementById('modal-description');
            descriptionTextarea.value = getImageDescription(image.id);
            descriptionTextarea.readOnly = !isAdmin;
            
            document.getElementById('image-detail-modal').classList.remove('hidden');
        }

        // 在模态框中显示AI分析结果
        function displayModalAIAnalysis(analysis) {
            const container = document.getElementById('modal-ai-analysis');
            
            if (!analysis) {
                container.innerHTML = '<p class="high-contrast-text opacity-75">暂无AI分析结果</p>';
                return;
            }
            
            container.innerHTML = `
                <div class="space-y-4">
                    <!-- 置信度 -->
                    <div class="glass-effect rounded-lg p-4">
                        <div class="flex items-center justify-between mb-2">
                            <span class="high-contrast-text font-semibold">整体置信度</span>
                            <span class="high-contrast-text font-bold">${Math.round(analysis.confidence * 100)}%</span>
                        </div>
                        <div class="confidence-bar">
                            <div class="h-full bg-blue-500 rounded" style="width: ${analysis.confidence * 100}%"></div>
                        </div>
                    </div>
                    
                    <!-- 检测到的物体 -->
                    ${analysis.objects.length > 0 ? `
                        <div class="glass-effect rounded-lg p-4">
                            <h4 class="high-contrast-text font-semibold mb-3">
                                <i class="fas fa-eye mr-2"></i>检测到的物体
                            </h4>
                            <div class="space-y-2">
                                ${analysis.objects.map(obj => `
                                    <div class="flex items-center justify-between">
                                        <span class="high-contrast-text">${obj.label}</span>
                                        <span class="text-sm high-contrast-text opacity-75">${Math.round(obj.confidence * 100)}%</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- 场景分析 -->
                    ${analysis.scenes.length > 0 ? `
                        <div class="glass-effect rounded-lg p-4">
                            <h4 class="high-contrast-text font-semibold mb-3">
                                <i class="fas fa-landscape mr-2"></i>场景分析
                            </h4>
                            <div class="space-y-2">
                                ${analysis.scenes.map(scene => `
                                    <div class="flex items-center justify-between">
                                        <span class="high-contrast-text">${scene.label}</span>
                                        <span class="text-sm high-contrast-text opacity-75">${Math.round(scene.confidence * 100)}%</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- 情感分析 -->
                    ${analysis.emotions.length > 0 ? `
                        <div class="glass-effect rounded-lg p-4">
                            <h4 class="high-contrast-text font-semibold mb-3">
                                <i class="fas fa-heart mr-2"></i>情感分析
                            </h4>
                            <div class="space-y-2">
                                ${analysis.emotions.map(emotion => `
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center">
                                            <div class="w-3 h-3 rounded-full mr-2" style="background: ${emotion.color}"></div>
                                            <span class="high-contrast-text">${emotion.label}</span>
                                        </div>
                                        <span class="text-sm high-contrast-text opacity-75">${Math.round(emotion.confidence * 100)}%</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- 主要颜色 -->
                    ${analysis.colors.length > 0 ? `
                        <div class="glass-effect rounded-lg p-4">
                            <h4 class="high-contrast-text font-semibold mb-3">
                                <i class="fas fa-palette mr-2"></i>主要颜色
                            </h4>
                            <div class="flex flex-wrap gap-2">
                                ${analysis.colors.map(color => `
                                    <div class="flex items-center space-x-2">
                                        <div class="w-6 h-6 rounded border border-gray-300" style="background: ${color.hex}"></div>
                                        <span class="text-sm high-contrast-text">${color.name}</span>
                                        <span class="text-xs high-contrast-text opacity-75">${color.percentage}%</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // 在模态框中显示标签
        function displayModalTags(tags) {
            const container = document.getElementById('modal-tags');
            container.innerHTML = tags.map(tag => `
                <span class="tag-item px-3 py-1 rounded-lg text-sm">${tag}</span>
            `).join('');
        }

        // 关闭图片模态框
        function closeImageModal() {
            document.getElementById('image-detail-modal').classList.add('hidden');
        }

        // 更新AI统计
        function updateAIStatistics() {
            let totalObjects = 0;
            let totalScenes = 0;
            let totalTags = 0;
            
            aiAnalysisResults.forEach(analysis => {
                totalObjects += analysis.objects.length;
                totalScenes += analysis.scenes.length;
                totalTags += analysis.smartTags.length;
            });
            
            document.getElementById('objects-count').textContent = totalObjects;
            document.getElementById('scenes-count').textContent = totalScenes;
            document.getElementById('tags-count').textContent = totalTags;
            
            // 更新AI分析详情
            updateAIAnalysisDetails();
        }

        // 更新AI分析详情
        function updateAIAnalysisDetails() {
            const container = document.getElementById('ai-analysis-details');
            
            if (aiAnalysisResults.size === 0) {
                container.innerHTML = '<p class="high-contrast-text text-center">暂无AI分析数据</p>';
                return;
            }
            
            // 汇总统计
            const objectStats = {};
            const sceneStats = {};
            const emotionStats = {};
            
            aiAnalysisResults.forEach(analysis => {
                analysis.objects.forEach(obj => {
                    objectStats[obj.label] = (objectStats[obj.label] || 0) + 1;
                });
                
                analysis.scenes.forEach(scene => {
                    sceneStats[scene.label] = (sceneStats[scene.label] || 0) + 1;
                });
                
                analysis.emotions.forEach(emotion => {
                    emotionStats[emotion.label] = (emotionStats[emotion.label] || 0) + 1;
                });
            });
            
            container.innerHTML = `
                <div class="grid md:grid-cols-3 gap-6">
                    <!-- 热门物体 -->
                    <div class="glass-effect rounded-xl p-6">
                        <h3 class="high-contrast-text text-lg font-semibold mb-4">
                            <i class="fas fa-fire mr-2"></i>热门物体
                        </h3>
                        <div class="space-y-2">
                            ${Object.entries(objectStats)
                                .sort(([,a], [,b]) => b - a)
                                .slice(0, 5)
                                .map(([object, count]) => `
                                    <div class="flex justify-between items-center">
                                        <span class="high-contrast-text">${object}</span>
                                        <span class="ai-badge px-2 py-1 rounded text-sm">${count}</span>
                                    </div>
                                `).join('')}
                        </div>
                    </div>
                    
                    <!-- 热门场景 -->
                    <div class="glass-effect rounded-xl p-6">
                        <h3 class="high-contrast-text text-lg font-semibold mb-4">
                            <i class="fas fa-mountain mr-2"></i>热门场景
                        </h3>
                        <div class="space-y-2">
                            ${Object.entries(sceneStats)
                                .sort(([,a], [,b]) => b - a)
                                .slice(0, 5)
                                .map(([scene, count]) => `
                                    <div class="flex justify-between items-center">
                                        <span class="high-contrast-text">${scene}</span>
                                        <span class="ai-badge px-2 py-1 rounded text-sm">${count}</span>
                                    </div>
                                `).join('')}
                        </div>
                    </div>
                    
                    <!-- 情感分布 -->
                    <div class="glass-effect rounded-xl p-6">
                        <h3 class="high-contrast-text text-lg font-semibold mb-4">
                            <i class="fas fa-heart mr-2"></i>情感分布
                        </h3>
                        <div class="space-y-2">
                            ${Object.entries(emotionStats)
                                .sort(([,a], [,b]) => b - a)
                                .slice(0, 5)
                                .map(([emotion, count]) => `
                                    <div class="flex justify-between items-center">
                                        <span class="high-contrast-text">${emotion}</span>
                                        <span class="ai-badge px-2 py-1 rounded text-sm">${count}</span>
                                    </div>
                                `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // 刷新画廊
        async function refreshGallery() {
            await loadImages();
        }

        // 下载图片
        function downloadImage(url, filename) {
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
        }

        // 分享图片
        function shareImage(imageId) {
            const image = currentImages.find(img => img.id === imageId);
            if (image) {
                if (navigator.share) {
                    navigator.share({
                        title: image.name,
                        url: image.url
                    });
                } else {
                    navigator.clipboard.writeText(image.url).then(() => {
                        alert('图片链接已复制到剪贴板');
                    });
                }
            }
        }

        // 下载当前图片
        function downloadCurrentImage() {
            const image = currentImages[currentImageIndex];
            downloadImage(image.url, image.name);
        }

        // 分享当前图片
        function shareCurrentImage() {
            const image = currentImages[currentImageIndex];
            shareImage(image.id);
        }

        // 获取图片描述
        function getImageDescription(imageId) {
            const descriptions = JSON.parse(localStorage.getItem('image_descriptions') || '{}');
            return descriptions[imageId] || '';
        }

        // 保存图片描述
        function saveImageDescription() {
            if (!isAdmin) return;
            
            const image = currentImages[currentImageIndex];
            const description = document.getElementById('modal-description').value;
            
            const descriptions = JSON.parse(localStorage.getItem('image_descriptions') || '{}');
            descriptions[image.id] = description;
            localStorage.setItem('image_descriptions', JSON.stringify(descriptions));
            
            alert('描述已保存');
        }

        // 处理标签输入
        function handleTagInput(event) {
            if (event.key === 'Enter' && isAdmin) {
                const input = event.target;
                const tag = input.value.trim();
                
                if (tag) {
                    addTag(tag);
                    input.value = '';
                }
            }
        }

        // 添加标签
        function addTag(tag) {
            if (!isAdmin) return;
            
            const image = currentImages[currentImageIndex];
            const analysis = aiAnalysisResults.get(image.id);
            
            if (analysis && !analysis.smartTags.includes(tag)) {
                analysis.smartTags.push(tag);
                displayModalTags(analysis.smartTags);
                
                // 保存到本地存储
                const customTags = JSON.parse(localStorage.getItem('custom_tags') || '{}');
                customTags[image.id] = analysis.smartTags;
                localStorage.setItem('custom_tags', JSON.stringify(customTags));
            }
        }

        // 标签页切换
        function showTab(tabName) {
            // 隐藏所有标签页
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // 移除所有按钮的激活状态
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('admin-btn');
                btn.classList.add('theme-btn');
            });
            
            // 显示选中的标签页
            const targetTab = document.getElementById(tabName + '-tab');
            if (targetTab) {
                targetTab.classList.remove('hidden');
            }
            
            // 激活对应按钮
            event.target.classList.remove('theme-btn');
            event.target.classList.add('admin-btn');
        }

        // 初始化主题
        function initializeThemes() {
            const themeOptions = document.getElementById('theme-options');
            
            const themes = [
                { name: '默认主题', bg: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' },
                { name: '海洋主题', bg: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' },
                { name: '森林主题', bg: 'linear-gradient(135deg, #134e5e 0%, #71b280 100%)' },
                { name: '日落主题', bg: 'linear-gradient(135deg, #ff6b6b 0%, #feca57 50%, #ff9ff3 100%)' }
            ];
            
            themeOptions.innerHTML = themes.map((theme, index) => `
                <div class="theme-option cursor-pointer" onclick="applyTheme(${index})">
                    <div class="w-full h-16 rounded-lg mb-2" style="background: ${theme.bg}"></div>
                    <p class="high-contrast-text text-sm text-center">${theme.name}</p>
                </div>
            `).join('');
        }

        // 应用主题
        function applyTheme(themeIndex) {
            const themes = [
                'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                'linear-gradient(135deg, #134e5e 0%, #71b280 100%)',
                'linear-gradient(135deg, #ff6b6b 0%, #feca57 50%, #ff9ff3 100%)'
            ];
            
            document.body.style.background = themes[themeIndex];
            localStorage.setItem('selected_theme', themeIndex);
        }

        // 绑定事件
        function bindEvents() {
            // 搜索功能
            document.getElementById('search-input').addEventListener('input', function(e) {
                const query = e.target.value.toLowerCase();
                const filteredImages = currentImages.filter(image => 
                    image.name.toLowerCase().includes(query) ||
                    (aiAnalysisResults.get(image.id)?.smartTags || []).some(tag => 
                        tag.toLowerCase().includes(query)
                    )
                );
                renderImages(filteredImages);
            });
            
            // 主题切换按钮
            document.getElementById('theme-toggle').addEventListener('click', function() {
                showTab('settings');
            });
            
            // 管理员登录按钮
            document.getElementById('admin-login-btn').addEventListener('click', showAdminLogin);
            
            // ESC键关闭模态框
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeImageModal();
                    closeAdminModal();
                }
            });
            
            // 默认显示图片浏览标签页
            showTab('gallery');
        }
    </script>
</body>
</html>