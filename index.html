<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI智能相册</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <style>
        .glass-effect {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .upload-area {
            border: 2px dashed #cbd5e0;
            transition: all 0.3s ease;
        }
        .upload-area.dragover {
            border-color: #4f46e5;
            background-color: #f0f9ff;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal.active {
            display: flex;
        }
        .tag-input {
            display: inline-block;
            padding: 4px 8px;
            margin: 2px;
            background: #e2e8f0;
            border-radius: 12px;
            font-size: 12px;
        }
        .tag-input.custom {
            background: #4f46e5;
            color: white;
        }
        .progress-bar {
            width: 0%;
            height: 4px;
            background: #4f46e5;
            transition: width 0.3s ease;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px;
            border-radius: 8px;
            z-index: 1001;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        .notification.show {
            transform: translateX(0);
        }
        .notification.success {
            background: #10b981;
            color: white;
        }
        .notification.error {
            background: #ef4444;
            color: white;
        }
        .image-card {
            transition: transform 0.3s ease;
        }
        .image-card:hover {
            transform: translateY(-8px);
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <!-- 通知组件 -->
    <div id="notification" class="notification">
        <div class="flex items-center">
            <i class="fas fa-check-circle mr-2"></i>
            <span id="notificationText"></span>
        </div>
    </div>

    <!-- 头部 -->
    <div class="container mx-auto px-4 py-6">
        <div class="glass-effect rounded-2xl p-6 mb-6">
            <div class="text-center">
                <h1 class="text-4xl font-bold text-white mb-2">
                    <i class="fas fa-camera-retro mr-3"></i>
                    GitHub智能相册
                </h1>
                <p class="text-white text-opacity-80 text-lg">修复版 - 完美支持GitHub API上传</p>
            </div>
        </div>

        <!-- 配置面板 -->
        <div class="glass-effect rounded-2xl p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-white bg-opacity-20 rounded-xl p-4">
                    <h3 class="text-white font-semibold mb-3">
                        <i class="fas fa-cog mr-2"></i>GitHub 配置
                    </h3>
                    <div class="space-y-2">
                        <input type="text" id="githubOwner" placeholder="GitHub用户名" 
                               class="w-full px-3 py-2 rounded-lg bg-white bg-opacity-20 text-white placeholder-gray-300 border border-white border-opacity-30">
                        <input type="text" id="githubRepo" placeholder="仓库名" 
                               class="w-full px-3 py-2 rounded-lg bg-white bg-opacity-20 text-white placeholder-gray-300 border border-white border-opacity-30">
                        <input type="password" id="githubToken" placeholder="Personal Access Token" 
                               class="w-full px-3 py-2 rounded-lg bg-white bg-opacity-20 text-white placeholder-gray-300 border border-white border-opacity-30">
                        <button onclick="configureGitHub()" 
                                class="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                            <i class="fas fa-save mr-2"></i>保存配置
                        </button>
                    </div>
                </div>
                
                <div class="bg-white bg-opacity-20 rounded-xl p-4">
                    <h3 class="text-white font-semibold mb-3">
                        <i class="fas fa-chart-bar mr-2"></i>相册统计
                    </h3>
                    <div class="space-y-2 text-white">
                        <div class="flex justify-between">
                            <span>总图片:</span>
                            <span id="totalImages">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span>已标记:</span>
                            <span id="taggedImages">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span>总标签:</span>
                            <span id="totalTags">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span>配置状态:</span>
                            <span id="configStatus">
                                <i class="fas fa-times-circle text-red-400"></i>
                            </span>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white bg-opacity-20 rounded-xl p-4">
                    <h3 class="text-white font-semibold mb-3">
                        <i class="fas fa-tools mr-2"></i>快速操作
                    </h3>
                    <div class="space-y-2">
                        <button onclick="testGitHubConnection()" 
                                class="w-full bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors">
                            <i class="fas fa-network-wired mr-2"></i>测试连接
                        </button>
                        <button onclick="loadGallery()" 
                                class="w-full bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition-colors">
                            <i class="fas fa-sync-alt mr-2"></i>刷新相册
                        </button>
                        <button onclick="exportData()" 
                                class="w-full bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg transition-colors">
                            <i class="fas fa-download mr-2"></i>导出数据
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 上传区域 -->
        <div class="glass-effect rounded-2xl p-6 mb-6">
            <div class="upload-area rounded-xl p-8 text-center" id="uploadArea">
                <div class="text-white text-opacity-80 mb-4">
                    <i class="fas fa-cloud-upload-alt text-6xl mb-4"></i>
                    <h3 class="text-2xl font-semibold mb-2">上传图片到GitHub</h3>
                    <p>点击选择文件或拖拽图片到此处</p>
                    <p class="text-sm mt-2">支持 JPG, PNG, GIF, WebP 格式，最大25MB</p>
                </div>
                <input type="file" id="fileInput" multiple accept="image/*" class="hidden">
                <button onclick="document.getElementById('fileInput').click()" 
                        class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg transition-colors">
                    <i class="fas fa-plus mr-2"></i>选择文件
                </button>
            </div>
            <div id="uploadProgress" class="mt-4 hidden">
                <div class="bg-white bg-opacity-20 rounded-lg p-4">
                    <div class="flex justify-between text-white mb-2">
                        <span>上传进度</span>
                        <span id="progressText">0%</span>
                    </div>
                    <div class="bg-white bg-opacity-20 rounded-full h-2">
                        <div class="progress-bar rounded-full h-2" id="progressBar"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 搜索和过滤 -->
        <div class="glass-effect rounded-2xl p-6 mb-6">
            <div class="flex flex-wrap gap-4 items-center">
                <div class="flex-1 min-w-64">
                    <input type="text" id="searchInput" placeholder="🔍 搜索图片、标签或描述..." 
                           class="w-full px-4 py-2 rounded-lg bg-white bg-opacity-20 text-white placeholder-gray-300 border border-white border-opacity-30">
                </div>
                <select id="sortSelect" class="px-4 py-2 rounded-lg bg-white bg-opacity-20 text-white border border-white border-opacity-30">
                    <option value="name">按名称排序</option>
                    <option value="date">按日期排序</option>
                    <option value="size">按大小排序</option>
                </select>
                <button onclick="clearSearch()" 
                        class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors">
                    <i class="fas fa-times mr-2"></i>清除
                </button>
            </div>
        </div>

        <!-- 图片画廊 -->
        <div class="glass-effect rounded-2xl p-6">
            <h2 class="text-2xl font-semibold text-white mb-4">
                <i class="fas fa-images mr-2"></i>图片画廊
            </h2>
            <div id="gallery" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <!-- 图片将在这里动态加载 -->
            </div>
            <div id="loadingSpinner" class="text-center py-8">
                <i class="fas fa-spinner fa-spin text-white text-3xl"></i>
                <p class="text-white mt-2">正在加载图片...</p>
            </div>
        </div>
    </div>

    <!-- 图片编辑模态框 -->
    <div id="imageModal" class="modal">
        <div class="flex items-center justify-center w-full h-full p-4">
            <div class="bg-white rounded-2xl max-w-4xl w-full max-h-full overflow-auto">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-2xl font-semibold">编辑图片信息</h3>
                        <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <img id="modalImage" class="w-full h-auto rounded-lg shadow-lg">
                            <div class="mt-4">
                                <h4 class="font-semibold mb-2">图片信息</h4>
                                <div class="text-sm text-gray-600">
                                    <p>文件名: <span id="modalFileName"></span></p>
                                    <p>上传时间: <span id="modalUploadTime"></span></p>
                                    <p>文件大小: <span id="modalFileSize"></span></p>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">自定义标签</label>
                                <div class="flex flex-wrap gap-2 mb-2" id="currentTags"></div>
                                <div class="flex gap-2">
                                    <input type="text" id="tagInput" placeholder="输入标签..." 
                                           class="flex-1 px-3 py-2 border border-gray-300 rounded-lg">
                                    <button onclick="addTag()" 
                                            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">图片描述</label>
                                <textarea id="descriptionInput" rows="4" placeholder="输入图片描述..." 
                                          class="w-full px-3 py-2 border border-gray-300 rounded-lg resize-none"></textarea>
                                <div class="text-sm text-gray-500 mt-1">
                                    字数: <span id="charCount">0</span>
                                </div>
                            </div>
                            
                            <div class="flex gap-2">
                                <button onclick="saveImageData()" 
                                        class="flex-1 bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg">
                                    <i class="fas fa-save mr-2"></i>保存
                                </button>
                                <button onclick="deleteImage()" 
                                        class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg">
                                    <i class="fas fa-trash mr-2"></i>删除
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let currentConfig = {
            owner: '',
            repo: '',
            token: '',
            branch: 'main'
        };
        let currentImages = [];
        let currentEditingImage = null;
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadConfig();
            setupEventListeners();
            loadGallery();
        });

        // 设置事件监听器
        function setupEventListeners() {
            // 文件上传
            const fileInput = document.getElementById('fileInput');
            const uploadArea = document.getElementById('uploadArea');
            
            fileInput.addEventListener('change', handleFileSelect);
            
            // 拖拽上传
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            uploadArea.addEventListener('drop', handleDrop);
            
            // 搜索
            document.getElementById('searchInput').addEventListener('input', handleSearch);
            document.getElementById('sortSelect').addEventListener('change', handleSort);
            
            // 标签输入
            document.getElementById('tagInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addTag();
                }
            });
            
            // 描述输入
            document.getElementById('descriptionInput').addEventListener('input', function(e) {
                document.getElementById('charCount').textContent = e.target.value.length;
            });
        }

        // 配置GitHub
        function configureGitHub() {
            const owner = document.getElementById('githubOwner').value.trim();
            const repo = document.getElementById('githubRepo').value.trim();
            const token = document.getElementById('githubToken').value.trim();
            
            if (!owner || !repo || !token) {
                showNotification('请填写完整的GitHub配置信息', 'error');
                return;
            }
            
            currentConfig = { owner, repo, token, branch: 'main' };
            localStorage.setItem('githubConfig', JSON.stringify(currentConfig));
            
            // 验证配置
            testGitHubConnection();
        }

        // 测试GitHub连接
        async function testGitHubConnection() {
            if (!currentConfig.token) {
                showNotification('请先配置GitHub信息', 'error');
                return;
            }
            
            try {
                showNotification('正在测试连接...', 'info');
                
                // 测试用户权限
                const userResponse = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${currentConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'User-Agent': 'GitHub-Gallery-App'
                    }
                });
                
                if (!userResponse.ok) {
                    throw new Error(`用户验证失败: ${userResponse.status} ${userResponse.statusText}`);
                }
                
                const userData = await userResponse.json();
                
                // 测试仓库访问
                const repoResponse = await fetch(`https://api.github.com/repos/${currentConfig.owner}/${currentConfig.repo}`, {
                    headers: {
                        'Authorization': `token ${currentConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'User-Agent': 'GitHub-Gallery-App'
                    }
                });
                
                if (!repoResponse.ok) {
                    throw new Error(`仓库访问失败: ${repoResponse.status} ${repoResponse.statusText}`);
                }
                
                const repoData = await repoResponse.json();
                
                // 测试写入权限
                const permissionsResponse = await fetch(`https://api.github.com/repos/${currentConfig.owner}/${currentConfig.repo}/collaborators/${userData.login}/permission`, {
                    headers: {
                        'Authorization': `token ${currentConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'User-Agent': 'GitHub-Gallery-App'
                    }
                });
                
                document.getElementById('configStatus').innerHTML = '<i class="fas fa-check-circle text-green-400"></i>';
                showNotification('GitHub连接测试成功！', 'success');
                
            } catch (error) {
                console.error('GitHub连接测试失败:', error);
                document.getElementById('configStatus').innerHTML = '<i class="fas fa-times-circle text-red-400"></i>';
                showNotification(`连接测试失败: ${error.message}`, 'error');
            }
        }

        // 加载配置
        function loadConfig() {
            const savedConfig = localStorage.getItem('githubConfig');
            if (savedConfig) {
                currentConfig = JSON.parse(savedConfig);
                document.getElementById('githubOwner').value = currentConfig.owner;
                document.getElementById('githubRepo').value = currentConfig.repo;
                document.getElementById('githubToken').value = currentConfig.token;
                
                if (currentConfig.token) {
                    testGitHubConnection();
                }
            }
        }

        // 处理文件选择
        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            handleFiles(files);
        }

        // 处理拖拽
        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');
        }

        function handleDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');
            
            const files = Array.from(event.dataTransfer.files);
            handleFiles(files);
        }

        // 处理文件
        function handleFiles(files) {
            const imageFiles = files.filter(file => file.type.startsWith('image/'));
            
            if (imageFiles.length === 0) {
                showNotification('请选择有效的图片文件', 'error');
                return;
            }
            
            if (imageFiles.length > 10) {
                showNotification('一次最多上传10张图片', 'error');
                return;
            }
            
            uploadFiles(imageFiles);
        }

        // 上传文件到GitHub
        async function uploadFiles(files) {
            if (!currentConfig.token) {
                showNotification('请先配置GitHub信息', 'error');
                return;
            }
            
            const progressContainer = document.getElementById('uploadProgress');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            progressContainer.classList.remove('hidden');
            
            let completed = 0;
            const total = files.length;
            
            for (const file of files) {
                try {
                    await uploadSingleFile(file);
                    completed++;
                    
                    const progress = (completed / total) * 100;
                    progressBar.style.width = progress + '%';
                    progressText.textContent = Math.round(progress) + '%';
                    
                } catch (error) {
                    console.error('上传失败:', error);
                    showNotification(`上传 ${file.name} 失败: ${error.message}`, 'error');
                }
            }
            
            progressContainer.classList.add('hidden');
            
            if (completed > 0) {
                showNotification(`成功上传 ${completed} 张图片`, 'success');
                loadGallery();
            }
        }

        // 上传单个文件
        async function uploadSingleFile(file) {
            // 生成唯一文件名
            const timestamp = new Date().getTime();
            const extension = file.name.split('.').pop();
            const fileName = `image_${timestamp}.${extension}`;
            
            // 转换为base64
            const base64Content = await fileToBase64(file);
            
            // 检查文件是否已存在
            let sha = null;
            try {
                const existingResponse = await fetch(`https://api.github.com/repos/${currentConfig.owner}/${currentConfig.repo}/contents/images/${fileName}`, {
                    headers: {
                        'Authorization': `token ${currentConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'User-Agent': 'GitHub-Gallery-App'
                    }
                });
                
                if (existingResponse.ok) {
                    const existingData = await existingResponse.json();
                    sha = existingData.sha;
                }
            } catch (error) {
                // 文件不存在，继续上传
            }
            
            // 上传文件
            const uploadData = {
                message: `Upload image: ${fileName}`,
                content: base64Content,
                branch: currentConfig.branch
            };
            
            if (sha) {
                uploadData.sha = sha;
            }
            
            const uploadResponse = await fetch(`https://api.github.com/repos/${currentConfig.owner}/${currentConfig.repo}/contents/images/${fileName}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${currentConfig.token}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'User-Agent': 'GitHub-Gallery-App',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(uploadData)
            });
            
            if (!uploadResponse.ok) {
                const errorData = await uploadResponse.json();
                throw new Error(`${uploadResponse.status}: ${errorData.message || uploadResponse.statusText}`);
            }
            
            return fileName;
        }

        // 文件转base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // 加载图片画廊
        async function loadGallery() {
            if (!currentConfig.token) {
                document.getElementById('loadingSpinner').innerHTML = '<p class="text-white">请先配置GitHub信息</p>';
                return;
            }
            
            try {
                const response = await fetch(`https://api.github.com/repos/${currentConfig.owner}/${currentConfig.repo}/contents/images`, {
                    headers: {
                        'Authorization': `token ${currentConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'User-Agent': 'GitHub-Gallery-App'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`API请求失败: ${response.status}`);
                }
                
                const files = await response.json();
                const imageFiles = files.filter(file => 
                    file.type === 'file' && /\.(jpg|jpeg|png|gif|webp)$/i.test(file.name)
                );
                
                currentImages = imageFiles;
                renderGallery(imageFiles);
                updateStats();
                
            } catch (error) {
                console.error('加载图片失败:', error);
                document.getElementById('loadingSpinner').innerHTML = '<p class="text-white text-red-400">加载失败: ' + error.message + '</p>';
            }
        }

        // 渲染图片画廊
        function renderGallery(images) {
            const gallery = document.getElementById('gallery');
            const loadingSpinner = document.getElementById('loadingSpinner');
            
            loadingSpinner.style.display = 'none';
            
            if (images.length === 0) {
                gallery.innerHTML = '<div class="col-span-full text-center text-white text-opacity-60 py-8"><i class="fas fa-images text-4xl mb-4"></i><p>暂无图片</p></div>';
                return;
            }
            
            gallery.innerHTML = images.map(image => `
                <div class="image-card bg-white rounded-xl shadow-lg overflow-hidden cursor-pointer" onclick="openImageModal('${image.name}', '${image.download_url}')">
                    <div class="aspect-w-16 aspect-h-12">
                        <img src="${image.download_url}" alt="${image.name}" class="w-full h-48 object-cover">
                    </div>
                    <div class="p-4">
                        <h3 class="font-semibold text-gray-800 truncate">${image.name}</h3>
                        <p class="text-sm text-gray-600 mt-1">大小: ${formatFileSize(image.size)}</p>
                        <div class="flex flex-wrap gap-1 mt-2" id="tags-${image.name}">
                            ${getImageTags(image.name).map(tag => `<span class="tag-input custom">${tag}</span>`).join('')}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // 打开图片编辑模态框
        function openImageModal(fileName, downloadUrl) {
            currentEditingImage = fileName;
            
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            const modalFileName = document.getElementById('modalFileName');
            const modalUploadTime = document.getElementById('modalUploadTime');
            const modalFileSize = document.getElementById('modalFileSize');
            const descriptionInput = document.getElementById('descriptionInput');
            const currentTags = document.getElementById('currentTags');
            
            // 设置图片信息
            modalImage.src = downloadUrl;
            modalFileName.textContent = fileName;
            modalUploadTime.textContent = '未知';
            modalFileSize.textContent = '未知';
            
            // 加载现有标签和描述
            const imageData = getImageData(fileName);
            descriptionInput.value = imageData.description || '';
            document.getElementById('charCount').textContent = descriptionInput.value.length;
            
            // 显示现有标签
            renderCurrentTags(imageData.tags || []);
            
            modal.classList.add('active');
        }

        // 关闭模态框
        function closeModal() {
            document.getElementById('imageModal').classList.remove('active');
            currentEditingImage = null;
        }

        // 渲染当前标签
        function renderCurrentTags(tags) {
            const container = document.getElementById('currentTags');
            container.innerHTML = tags.map(tag => `
                <span class="tag-input custom">
                    ${tag}
                    <button onclick="removeTag('${tag}')" class="ml-1 text-red-300 hover:text-red-100">
                        <i class="fas fa-times"></i>
                    </button>
                </span>
            `).join('');
        }

        // 添加标签
        function addTag() {
            const tagInput = document.getElementById('tagInput');
            const tagValue = tagInput.value.trim();
            
            if (!tagValue) return;
            
            const imageData = getImageData(currentEditingImage);
            if (!imageData.tags) imageData.tags = [];
            
            if (!imageData.tags.includes(tagValue)) {
                imageData.tags.push(tagValue);
                saveImageData();
                renderCurrentTags(imageData.tags);
            }
            
            tagInput.value = '';
        }

        // 删除标签
        function removeTag(tag) {
            const imageData = getImageData(currentEditingImage);
            if (imageData.tags) {
                imageData.tags = imageData.tags.filter(t => t !== tag);
                saveImageData();
                renderCurrentTags(imageData.tags);
            }
        }

        // 保存图片数据
        function saveImageData() {
            if (!currentEditingImage) return;
            
            const description = document.getElementById('descriptionInput').value;
            const imageData = getImageData(currentEditingImage);
            
            imageData.description = description;
            imageData.lastModified = new Date().toISOString();
            
            const allData = JSON.parse(localStorage.getItem('imageData') || '{}');
            allData[currentEditingImage] = imageData;
            localStorage.setItem('imageData', JSON.stringify(allData));
            
            // 更新画廊显示
            const tagsContainer = document.getElementById(`tags-${currentEditingImage}`);
            if (tagsContainer) {
                tagsContainer.innerHTML = imageData.tags.map(tag => `<span class="tag-input custom">${tag}</span>`).join('');
            }
            
            showNotification('图片信息已保存', 'success');
            updateStats();
        }

        // 删除图片
        async function deleteImage() {
            if (!currentEditingImage) return;
            
            if (!confirm('确定要删除这张图片吗？')) return;
            
            try {
                // 从GitHub删除文件
                const fileResponse = await fetch(`https://api.github.com/repos/${currentConfig.owner}/${currentConfig.repo}/contents/images/${currentEditingImage}`, {
                    headers: {
                        'Authorization': `token ${currentConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'User-Agent': 'GitHub-Gallery-App'
                    }
                });
                
                if (fileResponse.ok) {
                    const fileData = await fileResponse.json();
                    
                    const deleteResponse = await fetch(`https://api.github.com/repos/${currentConfig.owner}/${currentConfig.repo}/contents/images/${currentEditingImage}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `token ${currentConfig.token}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'User-Agent': 'GitHub-Gallery-App',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: `Delete image: ${currentEditingImage}`,
                            sha: fileData.sha,
                            branch: currentConfig.branch
                        })
                    });
                    
                    if (deleteResponse.ok) {
                        // 删除本地数据
                        const allData = JSON.parse(localStorage.getItem('imageData') || '{}');
                        delete allData[currentEditingImage];
                        localStorage.setItem('imageData', JSON.stringify(allData));
                        
                        closeModal();
                        loadGallery();
                        showNotification('图片已删除', 'success');
                    }
                }
            } catch (error) {
                console.error('删除失败:', error);
                showNotification('删除失败: ' + error.message, 'error');
            }
        }

        // 获取图片数据
        function getImageData(fileName) {
            const allData = JSON.parse(localStorage.getItem('imageData') || '{}');
            return allData[fileName] || { tags: [], description: '' };
        }

        // 获取图片标签
        function getImageTags(fileName) {
            const imageData = getImageData(fileName);
            return imageData.tags || [];
        }

        // 处理搜索
        function handleSearch() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filteredImages = currentImages.filter(image => {
                const imageData = getImageData(image.name);
                return image.name.toLowerCase().includes(searchTerm) ||
                       (imageData.description && imageData.description.toLowerCase().includes(searchTerm)) ||
                       (imageData.tags && imageData.tags.some(tag => tag.toLowerCase().includes(searchTerm)));
            });
            
            renderGallery(filteredImages);
        }

        // 处理排序
        function handleSort() {
            const sortBy = document.getElementById('sortSelect').value;
            const sortedImages = [...currentImages].sort((a, b) => {
                switch (sortBy) {
                    case 'name':
                        return a.name.localeCompare(b.name);
                    case 'size':
                        return b.size - a.size;
                    case 'date':
                        return new Date(b.last_modified || 0) - new Date(a.last_modified || 0);
                    default:
                        return 0;
                }
            });
            
            renderGallery(sortedImages);
        }

        // 清除搜索
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('sortSelect').value = 'name';
            renderGallery(currentImages);
        }

        // 更新统计信息
        function updateStats() {
            const allData = JSON.parse(localStorage.getItem('imageData') || '{}');
            const allTags = new Set();
            let taggedCount = 0;
            
            Object.values(allData).forEach(data => {
                if (data.tags && data.tags.length > 0) {
                    taggedCount++;
                    data.tags.forEach(tag => allTags.add(tag));
                }
            });
            
            document.getElementById('totalImages').textContent = currentImages.length;
            document.getElementById('taggedImages').textContent = taggedCount;
            document.getElementById('totalTags').textContent = allTags.size;
        }

        // 导出数据
        function exportData() {
            const allData = JSON.parse(localStorage.getItem('imageData') || '{}');
            const dataStr = JSON.stringify(allData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `gallery_data_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showNotification('数据已导出', 'success');
        }

        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // 显示通知
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            
            notification.className = `notification ${type}`;
            notificationText.textContent = message;
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // 模态框外部点击关闭
        document.getElementById('imageModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
    </script>
</body>
</html>