<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIæ™ºèƒ½ç›¸å†Œ</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <style>
        .glass-effect {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .upload-area {
            border: 2px dashed #cbd5e0;
            transition: all 0.3s ease;
        }
        .upload-area.dragover {
            border-color: #4f46e5;
            background-color: #f0f9ff;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal.active {
            display: flex;
        }
        .tag-input {
            display: inline-block;
            padding: 4px 8px;
            margin: 2px;
            background: #e2e8f0;
            border-radius: 12px;
            font-size: 12px;
        }
        .tag-input.custom {
            background: #4f46e5;
            color: white;
        }
        .progress-bar {
            width: 0%;
            height: 4px;
            background: #4f46e5;
            transition: width 0.3s ease;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px;
            border-radius: 8px;
            z-index: 1001;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        .notification.show {
            transform: translateX(0);
        }
        .notification.success {
            background: #10b981;
            color: white;
        }
        .notification.error {
            background: #ef4444;
            color: white;
        }
        .image-card {
            transition: transform 0.3s ease;
        }
        .image-card:hover {
            transform: translateY(-8px);
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <!-- é€šçŸ¥ç»„ä»¶ -->
    <div id="notification" class="notification">
        <div class="flex items-center">
            <i class="fas fa-check-circle mr-2"></i>
            <span id="notificationText"></span>
        </div>
    </div>

    <!-- å¤´éƒ¨ -->
    <div class="container mx-auto px-4 py-6">
        <div class="glass-effect rounded-2xl p-6 mb-6">
            <div class="text-center">
                <h1 class="text-4xl font-bold text-white mb-2">
                    <i class="fas fa-camera-retro mr-3"></i>
                    GitHubæ™ºèƒ½ç›¸å†Œ
                </h1>
                <p class="text-white text-opacity-80 text-lg">ä¿®å¤ç‰ˆ - å®Œç¾æ”¯æŒGitHub APIä¸Šä¼ </p>
            </div>
        </div>

        <!-- é…ç½®é¢æ¿ -->
        <div class="glass-effect rounded-2xl p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-white bg-opacity-20 rounded-xl p-4">
                    <h3 class="text-white font-semibold mb-3">
                        <i class="fas fa-cog mr-2"></i>GitHub é…ç½®
                    </h3>
                    <div class="space-y-2">
                        <input type="text" id="githubOwner" placeholder="GitHubç”¨æˆ·å" 
                               class="w-full px-3 py-2 rounded-lg bg-white bg-opacity-20 text-white placeholder-gray-300 border border-white border-opacity-30">
                        <input type="text" id="githubRepo" placeholder="ä»“åº“å" 
                               class="w-full px-3 py-2 rounded-lg bg-white bg-opacity-20 text-white placeholder-gray-300 border border-white border-opacity-30">
                        <input type="password" id="githubToken" placeholder="Personal Access Token" 
                               class="w-full px-3 py-2 rounded-lg bg-white bg-opacity-20 text-white placeholder-gray-300 border border-white border-opacity-30">
                        <button onclick="configureGitHub()" 
                                class="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                            <i class="fas fa-save mr-2"></i>ä¿å­˜é…ç½®
                        </button>
                    </div>
                </div>
                
                <div class="bg-white bg-opacity-20 rounded-xl p-4">
                    <h3 class="text-white font-semibold mb-3">
                        <i class="fas fa-chart-bar mr-2"></i>ç›¸å†Œç»Ÿè®¡
                    </h3>
                    <div class="space-y-2 text-white">
                        <div class="flex justify-between">
                            <span>æ€»å›¾ç‰‡:</span>
                            <span id="totalImages">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span>å·²æ ‡è®°:</span>
                            <span id="taggedImages">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span>æ€»æ ‡ç­¾:</span>
                            <span id="totalTags">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span>é…ç½®çŠ¶æ€:</span>
                            <span id="configStatus">
                                <i class="fas fa-times-circle text-red-400"></i>
                            </span>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white bg-opacity-20 rounded-xl p-4">
                    <h3 class="text-white font-semibold mb-3">
                        <i class="fas fa-tools mr-2"></i>å¿«é€Ÿæ“ä½œ
                    </h3>
                    <div class="space-y-2">
                        <button onclick="testGitHubConnection()" 
                                class="w-full bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors">
                            <i class="fas fa-network-wired mr-2"></i>æµ‹è¯•è¿æ¥
                        </button>
                        <button onclick="loadGallery()" 
                                class="w-full bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition-colors">
                            <i class="fas fa-sync-alt mr-2"></i>åˆ·æ–°ç›¸å†Œ
                        </button>
                        <button onclick="exportData()" 
                                class="w-full bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg transition-colors">
                            <i class="fas fa-download mr-2"></i>å¯¼å‡ºæ•°æ®
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä¸Šä¼ åŒºåŸŸ -->
        <div class="glass-effect rounded-2xl p-6 mb-6">
            <div class="upload-area rounded-xl p-8 text-center" id="uploadArea">
                <div class="text-white text-opacity-80 mb-4">
                    <i class="fas fa-cloud-upload-alt text-6xl mb-4"></i>
                    <h3 class="text-2xl font-semibold mb-2">ä¸Šä¼ å›¾ç‰‡åˆ°GitHub</h3>
                    <p>ç‚¹å‡»é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„</p>
                    <p class="text-sm mt-2">æ”¯æŒ JPG, PNG, GIF, WebP æ ¼å¼ï¼Œæœ€å¤§25MB</p>
                </div>
                <input type="file" id="fileInput" multiple accept="image/*" class="hidden">
                <button onclick="document.getElementById('fileInput').click()" 
                        class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg transition-colors">
                    <i class="fas fa-plus mr-2"></i>é€‰æ‹©æ–‡ä»¶
                </button>
            </div>
            <div id="uploadProgress" class="mt-4 hidden">
                <div class="bg-white bg-opacity-20 rounded-lg p-4">
                    <div class="flex justify-between text-white mb-2">
                        <span>ä¸Šä¼ è¿›åº¦</span>
                        <span id="progressText">0%</span>
                    </div>
                    <div class="bg-white bg-opacity-20 rounded-full h-2">
                        <div class="progress-bar rounded-full h-2" id="progressBar"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æœç´¢å’Œè¿‡æ»¤ -->
        <div class="glass-effect rounded-2xl p-6 mb-6">
            <div class="flex flex-wrap gap-4 items-center">
                <div class="flex-1 min-w-64">
                    <input type="text" id="searchInput" placeholder="ğŸ” æœç´¢å›¾ç‰‡ã€æ ‡ç­¾æˆ–æè¿°..." 
                           class="w-full px-4 py-2 rounded-lg bg-white bg-opacity-20 text-white placeholder-gray-300 border border-white border-opacity-30">
                </div>
                <select id="sortSelect" class="px-4 py-2 rounded-lg bg-white bg-opacity-20 text-white border border-white border-opacity-30">
                    <option value="name">æŒ‰åç§°æ’åº</option>
                    <option value="date">æŒ‰æ—¥æœŸæ’åº</option>
                    <option value="size">æŒ‰å¤§å°æ’åº</option>
                </select>
                <button onclick="clearSearch()" 
                        class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors">
                    <i class="fas fa-times mr-2"></i>æ¸…é™¤
                </button>
            </div>
        </div>

        <!-- å›¾ç‰‡ç”»å»Š -->
        <div class="glass-effect rounded-2xl p-6">
            <h2 class="text-2xl font-semibold text-white mb-4">
                <i class="fas fa-images mr-2"></i>å›¾ç‰‡ç”»å»Š
            </h2>
            <div id="gallery" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <!-- å›¾ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
            </div>
            <div id="loadingSpinner" class="text-center py-8">
                <i class="fas fa-spinner fa-spin text-white text-3xl"></i>
                <p class="text-white mt-2">æ­£åœ¨åŠ è½½å›¾ç‰‡...</p>
            </div>
        </div>
    </div>

    <!-- å›¾ç‰‡ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div id="imageModal" class="modal">
        <div class="flex items-center justify-center w-full h-full p-4">
            <div class="bg-white rounded-2xl max-w-4xl w-full max-h-full overflow-auto">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-2xl font-semibold">ç¼–è¾‘å›¾ç‰‡ä¿¡æ¯</h3>
                        <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <img id="modalImage" class="w-full h-auto rounded-lg shadow-lg">
                            <div class="mt-4">
                                <h4 class="font-semibold mb-2">å›¾ç‰‡ä¿¡æ¯</h4>
                                <div class="text-sm text-gray-600">
                                    <p>æ–‡ä»¶å: <span id="modalFileName"></span></p>
                                    <p>ä¸Šä¼ æ—¶é—´: <span id="modalUploadTime"></span></p>
                                    <p>æ–‡ä»¶å¤§å°: <span id="modalFileSize"></span></p>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">è‡ªå®šä¹‰æ ‡ç­¾</label>
                                <div class="flex flex-wrap gap-2 mb-2" id="currentTags"></div>
                                <div class="flex gap-2">
                                    <input type="text" id="tagInput" placeholder="è¾“å…¥æ ‡ç­¾..." 
                                           class="flex-1 px-3 py-2 border border-gray-300 rounded-lg">
                                    <button onclick="addTag()" 
                                            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">å›¾ç‰‡æè¿°</label>
                                <textarea id="descriptionInput" rows="4" placeholder="è¾“å…¥å›¾ç‰‡æè¿°..." 
                                          class="w-full px-3 py-2 border border-gray-300 rounded-lg resize-none"></textarea>
                                <div class="text-sm text-gray-500 mt-1">
                                    å­—æ•°: <span id="charCount">0</span>
                                </div>
                            </div>
                            
                            <div class="flex gap-2">
                                <button onclick="saveImageData()" 
                                        class="flex-1 bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg">
                                    <i class="fas fa-save mr-2"></i>ä¿å­˜
                                </button>
                                <button onclick="deleteImage()" 
                                        class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg">
                                    <i class="fas fa-trash mr-2"></i>åˆ é™¤
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentConfig = {
            owner: '',
            repo: '',
            token: '',
            branch: 'main'
        };
        let currentImages = [];
        let currentEditingImage = null;
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadConfig();
            setupEventListeners();
            loadGallery();
        });

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // æ–‡ä»¶ä¸Šä¼ 
            const fileInput = document.getElementById('fileInput');
            const uploadArea = document.getElementById('uploadArea');
            
            fileInput.addEventListener('change', handleFileSelect);
            
            // æ‹–æ‹½ä¸Šä¼ 
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            uploadArea.addEventListener('drop', handleDrop);
            
            // æœç´¢
            document.getElementById('searchInput').addEventListener('input', handleSearch);
            document.getElementById('sortSelect').addEventListener('change', handleSort);
            
            // æ ‡ç­¾è¾“å…¥
            document.getElementById('tagInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addTag();
                }
            });
            
            // æè¿°è¾“å…¥
            document.getElementById('descriptionInput').addEventListener('input', function(e) {
                document.getElementById('charCount').textContent = e.target.value.length;
            });
        }

        // é…ç½®GitHub
        function configureGitHub() {
            const owner = document.getElementById('githubOwner').value.trim();
            const repo = document.getElementById('githubRepo').value.trim();
            const token = document.getElementById('githubToken').value.trim();
            
            if (!owner || !repo || !token) {
                showNotification('è¯·å¡«å†™å®Œæ•´çš„GitHubé…ç½®ä¿¡æ¯', 'error');
                return;
            }
            
            currentConfig = { owner, repo, token, branch: 'main' };
            localStorage.setItem('githubConfig', JSON.stringify(currentConfig));
            
            // éªŒè¯é…ç½®
            testGitHubConnection();
        }

        // æµ‹è¯•GitHubè¿æ¥
        async function testGitHubConnection() {
            if (!currentConfig.token) {
                showNotification('è¯·å…ˆé…ç½®GitHubä¿¡æ¯', 'error');
                return;
            }
            
            try {
                showNotification('æ­£åœ¨æµ‹è¯•è¿æ¥...', 'info');
                
                // æµ‹è¯•ç”¨æˆ·æƒé™
                const userResponse = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${currentConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'User-Agent': 'GitHub-Gallery-App'
                    }
                });
                
                if (!userResponse.ok) {
                    throw new Error(`ç”¨æˆ·éªŒè¯å¤±è´¥: ${userResponse.status} ${userResponse.statusText}`);
                }
                
                const userData = await userResponse.json();
                
                // æµ‹è¯•ä»“åº“è®¿é—®
                const repoResponse = await fetch(`https://api.github.com/repos/${currentConfig.owner}/${currentConfig.repo}`, {
                    headers: {
                        'Authorization': `token ${currentConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'User-Agent': 'GitHub-Gallery-App'
                    }
                });
                
                if (!repoResponse.ok) {
                    throw new Error(`ä»“åº“è®¿é—®å¤±è´¥: ${repoResponse.status} ${repoResponse.statusText}`);
                }
                
                const repoData = await repoResponse.json();
                
                // æµ‹è¯•å†™å…¥æƒé™
                const permissionsResponse = await fetch(`https://api.github.com/repos/${currentConfig.owner}/${currentConfig.repo}/collaborators/${userData.login}/permission`, {
                    headers: {
                        'Authorization': `token ${currentConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'User-Agent': 'GitHub-Gallery-App'
                    }
                });
                
                document.getElementById('configStatus').innerHTML = '<i class="fas fa-check-circle text-green-400"></i>';
                showNotification('GitHubè¿æ¥æµ‹è¯•æˆåŠŸï¼', 'success');
                
            } catch (error) {
                console.error('GitHubè¿æ¥æµ‹è¯•å¤±è´¥:', error);
                document.getElementById('configStatus').innerHTML = '<i class="fas fa-times-circle text-red-400"></i>';
                showNotification(`è¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // åŠ è½½é…ç½®
        function loadConfig() {
            const savedConfig = localStorage.getItem('githubConfig');
            if (savedConfig) {
                currentConfig = JSON.parse(savedConfig);
                document.getElementById('githubOwner').value = currentConfig.owner;
                document.getElementById('githubRepo').value = currentConfig.repo;
                document.getElementById('githubToken').value = currentConfig.token;
                
                if (currentConfig.token) {
                    testGitHubConnection();
                }
            }
        }

        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            handleFiles(files);
        }

        // å¤„ç†æ‹–æ‹½
        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');
        }

        function handleDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');
            
            const files = Array.from(event.dataTransfer.files);
            handleFiles(files);
        }

        // å¤„ç†æ–‡ä»¶
        function handleFiles(files) {
            const imageFiles = files.filter(file => file.type.startsWith('image/'));
            
            if (imageFiles.length === 0) {
                showNotification('è¯·é€‰æ‹©æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶', 'error');
                return;
            }
            
            if (imageFiles.length > 10) {
                showNotification('ä¸€æ¬¡æœ€å¤šä¸Šä¼ 10å¼ å›¾ç‰‡', 'error');
                return;
            }
            
            uploadFiles(imageFiles);
        }

        // ä¸Šä¼ æ–‡ä»¶åˆ°GitHub
        async function uploadFiles(files) {
            if (!currentConfig.token) {
                showNotification('è¯·å…ˆé…ç½®GitHubä¿¡æ¯', 'error');
                return;
            }
            
            const progressContainer = document.getElementById('uploadProgress');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            progressContainer.classList.remove('hidden');
            
            let completed = 0;
            const total = files.length;
            
            for (const file of files) {
                try {
                    await uploadSingleFile(file);
                    completed++;
                    
                    const progress = (completed / total) * 100;
                    progressBar.style.width = progress + '%';
                    progressText.textContent = Math.round(progress) + '%';
                    
                } catch (error) {
                    console.error('ä¸Šä¼ å¤±è´¥:', error);
                    showNotification(`ä¸Šä¼  ${file.name} å¤±è´¥: ${error.message}`, 'error');
                }
            }
            
            progressContainer.classList.add('hidden');
            
            if (completed > 0) {
                showNotification(`æˆåŠŸä¸Šä¼  ${completed} å¼ å›¾ç‰‡`, 'success');
                loadGallery();
            }
        }

        // ä¸Šä¼ å•ä¸ªæ–‡ä»¶
        async function uploadSingleFile(file) {
            // ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å
            const timestamp = new Date().getTime();
            const extension = file.name.split('.').pop();
            const fileName = `image_${timestamp}.${extension}`;
            
            // è½¬æ¢ä¸ºbase64
            const base64Content = await fileToBase64(file);
            
            // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨
            let sha = null;
            try {
                const existingResponse = await fetch(`https://api.github.com/repos/${currentConfig.owner}/${currentConfig.repo}/contents/images/${fileName}`, {
                    headers: {
                        'Authorization': `token ${currentConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'User-Agent': 'GitHub-Gallery-App'
                    }
                });
                
                if (existingResponse.ok) {
                    const existingData = await existingResponse.json();
                    sha = existingData.sha;
                }
            } catch (error) {
                // æ–‡ä»¶ä¸å­˜åœ¨ï¼Œç»§ç»­ä¸Šä¼ 
            }
            
            // ä¸Šä¼ æ–‡ä»¶
            const uploadData = {
                message: `Upload image: ${fileName}`,
                content: base64Content,
                branch: currentConfig.branch
            };
            
            if (sha) {
                uploadData.sha = sha;
            }
            
            const uploadResponse = await fetch(`https://api.github.com/repos/${currentConfig.owner}/${currentConfig.repo}/contents/images/${fileName}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${currentConfig.token}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'User-Agent': 'GitHub-Gallery-App',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(uploadData)
            });
            
            if (!uploadResponse.ok) {
                const errorData = await uploadResponse.json();
                throw new Error(`${uploadResponse.status}: ${errorData.message || uploadResponse.statusText}`);
            }
            
            return fileName;
        }

        // æ–‡ä»¶è½¬base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // åŠ è½½å›¾ç‰‡ç”»å»Š
        async function loadGallery() {
            if (!currentConfig.token) {
                document.getElementById('loadingSpinner').innerHTML = '<p class="text-white">è¯·å…ˆé…ç½®GitHubä¿¡æ¯</p>';
                return;
            }
            
            try {
                const response = await fetch(`https://api.github.com/repos/${currentConfig.owner}/${currentConfig.repo}/contents/images`, {
                    headers: {
                        'Authorization': `token ${currentConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'User-Agent': 'GitHub-Gallery-App'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
                }
                
                const files = await response.json();
                const imageFiles = files.filter(file => 
                    file.type === 'file' && /\.(jpg|jpeg|png|gif|webp)$/i.test(file.name)
                );
                
                currentImages = imageFiles;
                renderGallery(imageFiles);
                updateStats();
                
            } catch (error) {
                console.error('åŠ è½½å›¾ç‰‡å¤±è´¥:', error);
                document.getElementById('loadingSpinner').innerHTML = '<p class="text-white text-red-400">åŠ è½½å¤±è´¥: ' + error.message + '</p>';
            }
        }

        // æ¸²æŸ“å›¾ç‰‡ç”»å»Š
        function renderGallery(images) {
            const gallery = document.getElementById('gallery');
            const loadingSpinner = document.getElementById('loadingSpinner');
            
            loadingSpinner.style.display = 'none';
            
            if (images.length === 0) {
                gallery.innerHTML = '<div class="col-span-full text-center text-white text-opacity-60 py-8"><i class="fas fa-images text-4xl mb-4"></i><p>æš‚æ— å›¾ç‰‡</p></div>';
                return;
            }
            
            gallery.innerHTML = images.map(image => `
                <div class="image-card bg-white rounded-xl shadow-lg overflow-hidden cursor-pointer" onclick="openImageModal('${image.name}', '${image.download_url}')">
                    <div class="aspect-w-16 aspect-h-12">
                        <img src="${image.download_url}" alt="${image.name}" class="w-full h-48 object-cover">
                    </div>
                    <div class="p-4">
                        <h3 class="font-semibold text-gray-800 truncate">${image.name}</h3>
                        <p class="text-sm text-gray-600 mt-1">å¤§å°: ${formatFileSize(image.size)}</p>
                        <div class="flex flex-wrap gap-1 mt-2" id="tags-${image.name}">
                            ${getImageTags(image.name).map(tag => `<span class="tag-input custom">${tag}</span>`).join('')}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // æ‰“å¼€å›¾ç‰‡ç¼–è¾‘æ¨¡æ€æ¡†
        function openImageModal(fileName, downloadUrl) {
            currentEditingImage = fileName;
            
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            const modalFileName = document.getElementById('modalFileName');
            const modalUploadTime = document.getElementById('modalUploadTime');
            const modalFileSize = document.getElementById('modalFileSize');
            const descriptionInput = document.getElementById('descriptionInput');
            const currentTags = document.getElementById('currentTags');
            
            // è®¾ç½®å›¾ç‰‡ä¿¡æ¯
            modalImage.src = downloadUrl;
            modalFileName.textContent = fileName;
            modalUploadTime.textContent = 'æœªçŸ¥';
            modalFileSize.textContent = 'æœªçŸ¥';
            
            // åŠ è½½ç°æœ‰æ ‡ç­¾å’Œæè¿°
            const imageData = getImageData(fileName);
            descriptionInput.value = imageData.description || '';
            document.getElementById('charCount').textContent = descriptionInput.value.length;
            
            // æ˜¾ç¤ºç°æœ‰æ ‡ç­¾
            renderCurrentTags(imageData.tags || []);
            
            modal.classList.add('active');
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('imageModal').classList.remove('active');
            currentEditingImage = null;
        }

        // æ¸²æŸ“å½“å‰æ ‡ç­¾
        function renderCurrentTags(tags) {
            const container = document.getElementById('currentTags');
            container.innerHTML = tags.map(tag => `
                <span class="tag-input custom">
                    ${tag}
                    <button onclick="removeTag('${tag}')" class="ml-1 text-red-300 hover:text-red-100">
                        <i class="fas fa-times"></i>
                    </button>
                </span>
            `).join('');
        }

        // æ·»åŠ æ ‡ç­¾
        function addTag() {
            const tagInput = document.getElementById('tagInput');
            const tagValue = tagInput.value.trim();
            
            if (!tagValue) return;
            
            const imageData = getImageData(currentEditingImage);
            if (!imageData.tags) imageData.tags = [];
            
            if (!imageData.tags.includes(tagValue)) {
                imageData.tags.push(tagValue);
                saveImageData();
                renderCurrentTags(imageData.tags);
            }
            
            tagInput.value = '';
        }

        // åˆ é™¤æ ‡ç­¾
        function removeTag(tag) {
            const imageData = getImageData(currentEditingImage);
            if (imageData.tags) {
                imageData.tags = imageData.tags.filter(t => t !== tag);
                saveImageData();
                renderCurrentTags(imageData.tags);
            }
        }

        // ä¿å­˜å›¾ç‰‡æ•°æ®
        function saveImageData() {
            if (!currentEditingImage) return;
            
            const description = document.getElementById('descriptionInput').value;
            const imageData = getImageData(currentEditingImage);
            
            imageData.description = description;
            imageData.lastModified = new Date().toISOString();
            
            const allData = JSON.parse(localStorage.getItem('imageData') || '{}');
            allData[currentEditingImage] = imageData;
            localStorage.setItem('imageData', JSON.stringify(allData));
            
            // æ›´æ–°ç”»å»Šæ˜¾ç¤º
            const tagsContainer = document.getElementById(`tags-${currentEditingImage}`);
            if (tagsContainer) {
                tagsContainer.innerHTML = imageData.tags.map(tag => `<span class="tag-input custom">${tag}</span>`).join('');
            }
            
            showNotification('å›¾ç‰‡ä¿¡æ¯å·²ä¿å­˜', 'success');
            updateStats();
        }

        // åˆ é™¤å›¾ç‰‡
        async function deleteImage() {
            if (!currentEditingImage) return;
            
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™å¼ å›¾ç‰‡å—ï¼Ÿ')) return;
            
            try {
                // ä»GitHubåˆ é™¤æ–‡ä»¶
                const fileResponse = await fetch(`https://api.github.com/repos/${currentConfig.owner}/${currentConfig.repo}/contents/images/${currentEditingImage}`, {
                    headers: {
                        'Authorization': `token ${currentConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'User-Agent': 'GitHub-Gallery-App'
                    }
                });
                
                if (fileResponse.ok) {
                    const fileData = await fileResponse.json();
                    
                    const deleteResponse = await fetch(`https://api.github.com/repos/${currentConfig.owner}/${currentConfig.repo}/contents/images/${currentEditingImage}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `token ${currentConfig.token}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'User-Agent': 'GitHub-Gallery-App',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: `Delete image: ${currentEditingImage}`,
                            sha: fileData.sha,
                            branch: currentConfig.branch
                        })
                    });
                    
                    if (deleteResponse.ok) {
                        // åˆ é™¤æœ¬åœ°æ•°æ®
                        const allData = JSON.parse(localStorage.getItem('imageData') || '{}');
                        delete allData[currentEditingImage];
                        localStorage.setItem('imageData', JSON.stringify(allData));
                        
                        closeModal();
                        loadGallery();
                        showNotification('å›¾ç‰‡å·²åˆ é™¤', 'success');
                    }
                }
            } catch (error) {
                console.error('åˆ é™¤å¤±è´¥:', error);
                showNotification('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        // è·å–å›¾ç‰‡æ•°æ®
        function getImageData(fileName) {
            const allData = JSON.parse(localStorage.getItem('imageData') || '{}');
            return allData[fileName] || { tags: [], description: '' };
        }

        // è·å–å›¾ç‰‡æ ‡ç­¾
        function getImageTags(fileName) {
            const imageData = getImageData(fileName);
            return imageData.tags || [];
        }

        // å¤„ç†æœç´¢
        function handleSearch() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filteredImages = currentImages.filter(image => {
                const imageData = getImageData(image.name);
                return image.name.toLowerCase().includes(searchTerm) ||
                       (imageData.description && imageData.description.toLowerCase().includes(searchTerm)) ||
                       (imageData.tags && imageData.tags.some(tag => tag.toLowerCase().includes(searchTerm)));
            });
            
            renderGallery(filteredImages);
        }

        // å¤„ç†æ’åº
        function handleSort() {
            const sortBy = document.getElementById('sortSelect').value;
            const sortedImages = [...currentImages].sort((a, b) => {
                switch (sortBy) {
                    case 'name':
                        return a.name.localeCompare(b.name);
                    case 'size':
                        return b.size - a.size;
                    case 'date':
                        return new Date(b.last_modified || 0) - new Date(a.last_modified || 0);
                    default:
                        return 0;
                }
            });
            
            renderGallery(sortedImages);
        }

        // æ¸…é™¤æœç´¢
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('sortSelect').value = 'name';
            renderGallery(currentImages);
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            const allData = JSON.parse(localStorage.getItem('imageData') || '{}');
            const allTags = new Set();
            let taggedCount = 0;
            
            Object.values(allData).forEach(data => {
                if (data.tags && data.tags.length > 0) {
                    taggedCount++;
                    data.tags.forEach(tag => allTags.add(tag));
                }
            });
            
            document.getElementById('totalImages').textContent = currentImages.length;
            document.getElementById('taggedImages').textContent = taggedCount;
            document.getElementById('totalTags').textContent = allTags.size;
        }

        // å¯¼å‡ºæ•°æ®
        function exportData() {
            const allData = JSON.parse(localStorage.getItem('imageData') || '{}');
            const dataStr = JSON.stringify(allData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `gallery_data_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showNotification('æ•°æ®å·²å¯¼å‡º', 'success');
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            
            notification.className = `notification ${type}`;
            notificationText.textContent = message;
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // æ¨¡æ€æ¡†å¤–éƒ¨ç‚¹å‡»å…³é—­
        document.getElementById('imageModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
    </script>
</body>
</html>