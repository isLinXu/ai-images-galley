<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIæ™ºèƒ½ç›¸å†Œç³»ç»Ÿ - ä¼˜åŒ–ç‰ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Inter', sans-serif;
        }

        :root {
            --primary-color: #3B82F6;
            --secondary-color: #10B981;
            --accent-color: #F59E0B;
            --background-color: rgba(255, 255, 255, 0.95);
            --surface-color: rgba(255, 255, 255, 0.9);
            --text-color: #1F2937;
            --text-secondary: #6B7280;
            --border-color: #E5E7EB;
            --shadow-color: rgba(0, 0, 0, 0.1);
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text-color);
            transition: background 0.5s ease;
        }

        .glass-effect {
            backdrop-filter: blur(10px);
            background: var(--surface-color);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .high-contrast-text {
            color: #000 !important;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
        }

        .ai-badge {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .confidence-bar {
            background: linear-gradient(90deg, #10B981 0%, #F59E0B 50%, #EF4444 100%);
            height: 4px;
            border-radius: 2px;
            overflow: hidden;
        }

        .tag-item {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: white;
            font-weight: 500;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .tag-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .image-card {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .image-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            border-color: var(--primary-color);
        }

        .image-container {
            position: relative;
            width: 100%;
            height: 240px;
            overflow: hidden;
            border-radius: 0.75rem;
            background: linear-gradient(45deg, #f0f0f0, #e0e0e0);
        }

        .image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .image-container:hover img {
            transform: scale(1.1);
        }

        .image-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #6B7280;
        }

        .ai-analysis-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.9), rgba(16, 185, 129, 0.9));
            backdrop-filter: blur(8px);
            opacity: 0;
            transition: opacity 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .image-card:hover .ai-analysis-overlay {
            opacity: 1;
        }

        .ai-progress-ring {
            width: 60px;
            height: 60px;
            transform: rotate(-90deg);
        }

        .ai-progress-ring circle {
            fill: none;
            stroke: rgba(255, 255, 255, 0.3);
            stroke-width: 4;
        }

        .ai-progress-ring .progress {
            stroke: white;
            stroke-dasharray: 157;
            stroke-dashoffset: 157;
            transition: stroke-dashoffset 0.3s ease;
        }

        .modal-overlay {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            transition: all 0.3s ease;
        }

        .modal-content {
            transform: scale(0.8);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 95vh;
            overflow-y: auto;
        }

        .modal-overlay:not(.hidden) .modal-content {
            transform: scale(1);
            opacity: 1;
        }

        .modal-image-container {
            position: relative;
            max-height: 70vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 1rem;
        }

        .modal-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 0.5rem;
        }

        .modal-nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            z-index: 10;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-color);
        }

        .modal-nav-btn:hover {
            background: rgba(255, 255, 255, 1);
            transform: translateY(-50%) scale(1.1);
        }

        .theme-btn {
            background: var(--surface-color);
            border: 2px solid var(--border-color);
            color: var(--text-color);
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .theme-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }

        .admin-btn {
            background: linear-gradient(45deg, #EF4444, #F59E0B);
            color: white;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid white;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .gradient-text {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
        }

        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #E5E7EB;
            border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            z-index: 50;
            max-height: 200px;
            overflow-y: auto;
        }

        .search-suggestion-item {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #F3F4F6;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .search-suggestion-item:hover {
            background: #F3F4F6;
        }

        .stats-card {
            background: var(--surface-color);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .stats-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .ai-analysis-item {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(16, 185, 129, 0.1));
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
        }

        .ai-analysis-item:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(16, 185, 129, 0.2));
            transform: translateX(4px);
        }

        .pulse-animation {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .slide-in {
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
            padding: 1rem;
        }

        .smart-crop {
            object-fit: cover;
            object-position: center;
        }

        .quality-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .quality-high {
            background: linear-gradient(45deg, #10B981, #34D399);
            color: white;
        }

        .quality-medium {
            background: linear-gradient(45deg, #F59E0B, #FBBF24);
            color: white;
        }

        .quality-low {
            background: linear-gradient(45deg, #EF4444, #F87171);
            color: white;
        }

        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.875rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1000;
        }

        .tooltip.show {
            opacity: 1;
        }

        @media (max-width: 768px) {
            .image-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .modal-content {
                max-width: 95vw;
                margin: 1rem;
            }
            
            .modal-image-container {
                max-height: 50vh;
            }
        }

        /* PDFä¼˜åŒ–æ ·å¼ */
        @media print {
            body {
                background: white !important;
                color: black !important;
                font-size: 12px;
            }
            
            .modal-overlay {
                display: none !important;
            }
            
            .image-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 1rem;
            }
            
            .image-container {
                height: 200px;
            }
            
            .glass-effect {
                background: white;
                border: 1px solid #ccc;
            }
            
            .high-contrast-text {
                color: black !important;
                text-shadow: none !important;
            }
            
            .ai-badge, .tag-item {
                background: #f0f0f0 !important;
                color: black !important;
                border: 1px solid #ccc !important;
            }
        }
    </style>
</head>
<body>
    <nav class="glass-effect sticky top-0 z-50 border-b border-white/20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-4">
                    <h1 class="text-2xl font-bold gradient-text">
                        <i class="fas fa-brain mr-2"></i>AIæ™ºèƒ½ç›¸å†Œ
                    </h1>
                    <span class="ai-badge px-3 py-1 rounded-full text-sm">
                        <i class="fas fa-robot mr-1"></i>æ™ºèƒ½åˆ†æ
                    </span>
                </div>
                <div class="flex items-center space-x-3">
                    <button id="theme-toggle" class="theme-btn px-4 py-2 rounded-lg">
                        <i class="fas fa-palette mr-2"></i>ä¸»é¢˜
                    </button>
                    <div id="user-status" class="flex items-center space-x-2">
                        <span class="high-contrast-text font-medium">æ¸¸å®¢æ¨¡å¼</span>
                        <button id="admin-login-btn" class="theme-btn px-4 py-2 rounded-lg">
                            <i class="fas fa-sign-in-alt mr-2"></i>ç®¡ç†å‘˜ç™»å½•
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <div class="glass-effect rounded-xl p-4 mb-6">
            <div class="flex flex-wrap gap-3 justify-center">
                <button onclick="showTab('gallery')" class="tab-btn theme-btn px-6 py-3 rounded-lg active">
                    <i class="fas fa-images mr-2"></i>å›¾ç‰‡æµè§ˆ
                </button>
                <button onclick="showTab('ai-analysis')" class="tab-btn theme-btn px-6 py-3 rounded-lg">
                    <i class="fas fa-brain mr-2"></i>AIåˆ†æ
                </button>
                <button onclick="showTab('settings')" class="tab-btn theme-btn px-6 py-3 rounded-lg">
                    <i class="fas fa-cog mr-2"></i>è®¾ç½®
                </button>
            </div>
        </div>

        <div class="glass-effect rounded-xl p-6 mb-6">
            <div class="flex flex-col lg:flex-row gap-4">
                <div class="flex-1 relative">
                    <input type="text" id="search-input" placeholder="ğŸ” æœç´¢å›¾ç‰‡ã€æ ‡ç­¾æˆ–æè¿°..." 
                           class="w-full px-4 py-3 rounded-lg border-2 border-gray-200 focus:border-blue-500 focus:outline-none high-contrast-text bg-white/90">
                    <div id="search-suggestions" class="search-suggestions hidden"></div>
                </div>
                <div class="flex gap-3">
                    <select id="tag-filter" class="px-4 py-3 rounded-lg border-2 border-gray-200 focus:border-blue-500 focus:outline-none high-contrast-text bg-white/90">
                        <option value="">æ‰€æœ‰æ ‡ç­¾</option>
                    </select>
                    <select id="sort-option" class="px-4 py-3 rounded-lg border-2 border-gray-200 focus:border-blue-500 focus:outline-none high-contrast-text bg-white/90">
                        <option value="newest">æœ€æ–°</option>
                        <option value="oldest">æœ€æ—§</option>
                        <option value="name">åç§°</option>
                        <option value="ai-score">AIè¯„åˆ†</option>
                        <option value="relevance">ç›¸å…³æ€§</option>
                    </select>
                    <button onclick="refreshGallery()" class="theme-btn px-6 py-3 rounded-lg">
                        <i class="fas fa-sync-alt mr-2"></i>åˆ·æ–°
                    </button>
                </div>
            </div>
        </div>
    </div>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-8">
        <div id="gallery-tab" class="tab-content">
            <div id="loading-indicator" class="glass-effect rounded-xl p-8 text-center mb-6">
                <div class="loading-spinner mx-auto mb-4"></div>
                <p class="high-contrast-text text-lg font-medium">æ­£åœ¨åŠ è½½å›¾ç‰‡...</p>
            </div>

            <div id="gallery-stats" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6" style="display: none;">
                <div class="stats-card rounded-xl p-4 text-center">
                    <i class="fas fa-images text-3xl text-blue-500 mb-2"></i>
                    <h3 class="high-contrast-text text-lg font-semibold">æ€»å›¾ç‰‡æ•°</h3>
                    <p id="total-images" class="text-2xl font-bold text-blue-500">0</p>
                </div>
                <div class="stats-card rounded-xl p-4 text-center">
                    <i class="fas fa-brain text-3xl text-green-500 mb-2"></i>
                    <h3 class="high-contrast-text text-lg font-semibold">å·²åˆ†æ</h3>
                    <p id="analyzed-images" class="text-2xl font-bold text-green-500">0</p>
                </div>
                <div class="stats-card rounded-xl p-4 text-center">
                    <i class="fas fa-tags text-3xl text-yellow-500 mb-2"></i>
                    <h3 class="high-contrast-text text-lg font-semibold">æ™ºèƒ½æ ‡ç­¾</h3>
                    <p id="total-tags" class="text-2xl font-bold text-yellow-500">0</p>
                </div>
                <div class="stats-card rounded-xl p-4 text-center">
                    <i class="fas fa-star text-3xl text-purple-500 mb-2"></i>
                    <h3 class="high-contrast-text text-lg font-semibold">å¹³å‡è¯„åˆ†</h3>
                    <p id="avg-score" class="text-2xl font-bold text-purple-500">0</p>
                </div>
            </div>

            <div id="images-grid" class="image-grid" style="display: none;"></div>
            
            <div id="no-images" class="glass-effect rounded-xl p-12 text-center" style="display: none;">
                <i class="fas fa-images text-6xl text-gray-400 mb-4"></i>
                <h3 class="high-contrast-text text-xl font-semibold mb-2">æš‚æ— å›¾ç‰‡</h3>
                <p class="high-contrast-text opacity-75">è¯·å°†å›¾ç‰‡æ·»åŠ åˆ° images æ–‡ä»¶å¤¹</p>
            </div>
        </div>

        <div id="ai-analysis-tab" class="tab-content hidden">
            <div class="glass-effect rounded-xl p-6">
                <h2 class="text-2xl font-bold high-contrast-text mb-6">
                    <i class="fas fa-brain mr-3"></i>AIåˆ†æç»Ÿè®¡
                </h2>
                <div id="ai-analysis-details" class="space-y-6"></div>
            </div>
        </div>

        <div id="settings-tab" class="tab-content hidden">
            <div class="glass-effect rounded-xl p-6">
                <h2 class="text-2xl font-bold high-contrast-text mb-6">
                    <i class="fas fa-cog mr-3"></i>ç³»ç»Ÿè®¾ç½®
                </h2>
                <div class="space-y-6">
                    <div>
                        <h3 class="high-contrast-text text-lg font-semibold mb-4">ä¸»é¢˜è®¾ç½®</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="theme-options"></div>
                    </div>
                    <div>
                        <h3 class="high-contrast-text text-lg font-semibold mb-4">AIåˆ†æè®¾ç½®</h3>
                        <div class="space-y-3">
                            <label class="flex items-center space-x-3">
                                <input type="checkbox" id="auto-analyze" class="w-4 h-4 text-blue-600 rounded">
                                <span class="high-contrast-text">è‡ªåŠ¨åˆ†ææ–°å›¾ç‰‡</span>
                            </label>
                            <label class="flex items-center space-x-3">
                                <input type="checkbox" id="smart-preload" class="w-4 h-4 text-blue-600 rounded" checked>
                                <span class="high-contrast-text">æ™ºèƒ½é¢„åŠ è½½</span>
                            </label>
                            <label class="flex items-center space-x-3">
                                <input type="checkbox" id="quality-analysis" class="w-4 h-4 text-blue-600 rounded" checked>
                                <span class="high-contrast-text">å›¾ç‰‡è´¨é‡åˆ†æ</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="image-detail-modal" class="fixed inset-0 modal-overlay z-50 hidden flex items-center justify-center p-4">
        <div class="glass-effect rounded-2xl max-w-6xl w-full modal-content">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="modal-title" class="text-2xl font-bold high-contrast-text">å›¾ç‰‡è¯¦æƒ…</h2>
                    <button onclick="closeImageModal()" class="text-gray-500 hover:text-gray-700 text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="grid lg:grid-cols-2 gap-8">
                    <div class="modal-image-container">
                        <button onclick="navigateImage(-1)" class="modal-nav-btn left-4">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <img id="modal-image" class="modal-image" alt="">
                        <button onclick="navigateImage(1)" class="modal-nav-btn right-4">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    
                    <div class="space-y-6">
                        <div>
                            <h3 class="high-contrast-text text-lg font-semibold mb-4">
                                <i class="fas fa-info-circle mr-2"></i>å›¾ç‰‡ä¿¡æ¯
                            </h3>
                            <div id="modal-image-info" class="space-y-2"></div>
                        </div>
                        
                        <div>
                            <h3 class="high-contrast-text text-lg font-semibold mb-4">
                                <i class="fas fa-brain mr-2"></i>AIåˆ†æç»“æœ
                            </h3>
                            <div id="modal-ai-analysis" class="space-y-4"></div>
                        </div>
                        
                        <div>
                            <h3 class="high-contrast-text text-lg font-semibold mb-4">
                                <i class="fas fa-tags mr-2"></i>æ™ºèƒ½æ ‡ç­¾
                            </h3>
                            <div id="modal-tags" class="flex flex-wrap gap-2"></div>
                        </div>
                        
                        <div class="flex gap-3">
                            <button onclick="downloadCurrentImage()" class="theme-btn px-6 py-3 rounded-lg">
                                <i class="fas fa-download mr-2"></i>ä¸‹è½½
                            </button>
                            <button onclick="shareCurrentImage()" class="theme-btn px-6 py-3 rounded-lg">
                                <i class="fas fa-share mr-2"></i>åˆ†äº«
                            </button>
                            <button onclick="analyzeCurrentImage()" class="theme-btn px-6 py-3 rounded-lg">
                                <i class="fas fa-brain mr-2"></i>é‡æ–°åˆ†æ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="admin-login-modal" class="fixed inset-0 modal-overlay z-50 hidden flex items-center justify-center p-4">
        <div class="glass-effect rounded-2xl max-w-md w-full p-6 modal-content">
            <h2 class="text-2xl font-bold high-contrast-text mb-6 text-center">
                <i class="fas fa-key mr-2"></i>ç®¡ç†å‘˜ç™»å½•
            </h2>
            <div class="mb-4">
                <label class="block high-contrast-text text-sm font-semibold mb-2">GitHub Personal Access Token:</label>
                <input type="password" id="github-token" placeholder="è¾“å…¥æ‚¨çš„GitHub Token..." 
                       class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:border-blue-500 focus:outline-none high-contrast-text bg-white/90">
            </div>
            <div class="flex gap-3">
                <button onclick="handleAdminLogin()" class="flex-1 admin-btn px-6 py-3 rounded-lg font-semibold">
                    <i class="fas fa-sign-in-alt mr-2"></i>ç™»å½•
                </button>
                <button onclick="closeAdminModal()" class="flex-1 theme-btn px-6 py-3 rounded-lg">
                    å–æ¶ˆ
                </button>
            </div>
        </div>
    </div>

    <div id="tooltip" class="tooltip"></div>

    <script>
        // å…¨å±€å˜é‡
        let currentImages = [];
        let currentImageIndex = 0;
        let aiAnalysisResults = new Map();
        let isAdmin = false;
        let analysisQueue = [];
        let isAnalyzing = false;
        let searchSuggestions = [];
        let preloadedImages = new Set();

        // å¢å¼ºçš„AIåˆ†æå¼•æ“
        class EnhancedAIEngine {
            constructor() {
                this.analysisCache = new Map();
                this.analysisQueue = [];
                this.isProcessing = false;
                this.workers = 2; // å¹¶å‘åˆ†ææ•°
            }

            async analyzeImage(imageFile, imageElement, priority = 'normal') {
                const cacheKey = imageFile?.name || imageElement.src;
                
                if (this.analysisCache.has(cacheKey)) {
                    return this.analysisCache.get(cacheKey);
                }

                return new Promise((resolve) => {
                    this.analysisQueue.push({
                        imageFile,
                        imageElement,
                        cacheKey,
                        priority,
                        resolve
                    });
                    
                    this.processQueue();
                });
            }

            async processQueue() {
                if (this.isProcessing || this.analysisQueue.length === 0) return;
                
                this.isProcessing = true;
                
                // æŒ‰ä¼˜å…ˆçº§æ’åº
                this.analysisQueue.sort((a, b) => {
                    const priorityOrder = { 'high': 0, 'normal': 1, 'low': 2 };
                    return priorityOrder[a.priority] - priorityOrder[b.priority];
                });

                const batch = this.analysisQueue.splice(0, this.workers);
                
                const promises = batch.map(async (item) => {
                    try {
                        const result = await this.performAnalysis(item.imageFile, item.imageElement);
                        this.analysisCache.set(item.cacheKey, result);
                        item.resolve(result);
                        this.updateImageAnalysis(item.cacheKey, result);
                    } catch (error) {
                        console.error('åˆ†æå¤±è´¥:', error);
                        const defaultResult = this.getDefaultAnalysis();
                        this.analysisCache.set(item.cacheKey, defaultResult);
                        item.resolve(defaultResult);
                    }
                });

                await Promise.all(promises);
                this.isProcessing = false;
                
                if (this.analysisQueue.length > 0) {
                    setTimeout(() => this.processQueue(), 100);
                }
            }

            async performAnalysis(imageFile, imageElement) {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // è‡ªé€‚åº”ç”»å¸ƒå°ºå¯¸
                const maxSize = 512;
                let { width, height } = imageElement;
                
                if (width > maxSize || height > maxSize) {
                    const ratio = Math.min(maxSize / width, maxSize / height);
                    width *= ratio;
                    height *= ratio;
                }
                
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(imageElement, 0, 0, width, height);

                const imageData = ctx.getImageData(0, 0, width, height);
                
                const analysis = {
                    objects: await this.detectObjects(imageData),
                    scenes: await this.classifyScene(imageData),
                    emotions: await this.analyzeEmotions(imageData),
                    colors: await this.extractColors(imageData),
                    quality: await this.analyzeQuality(imageData),
                    composition: await this.analyzeComposition(imageData),
                    smartTags: [],
                    confidence: 0,
                    timestamp: Date.now()
                };

                analysis.smartTags = this.generateSmartTags(analysis);
                analysis.confidence = this.calculateOverallConfidence(analysis);

                return analysis;
            }

            async detectObjects(imageData) {
                const data = imageData.data;
                const width = imageData.width;
                const height = imageData.height;
                
                const objects = [];
                
                // åˆ†æé¢œè‰²åˆ†å¸ƒ
                const colorStats = this.analyzeColorDistribution(data);
                
                // åŸºäºé¢œè‰²å’Œçº¹ç†çš„ç‰©ä½“æ£€æµ‹
                if (colorStats.skin > 0.15) {
                    objects.push({ 
                        label: 'äººç‰©', 
                        confidence: Math.min(0.95, colorStats.skin * 2),
                        category: 'person',
                        bbox: this.estimateBoundingBox(data, 'skin')
                    });
                }
                
                if (colorStats.green > 0.4) {
                    objects.push({ 
                        label: 'æ¤ç‰©', 
                        confidence: Math.min(0.90, colorStats.green * 1.5),
                        category: 'nature' 
                    });
                }
                
                if (colorStats.blue > 0.3) {
                    objects.push({ 
                        label: 'å¤©ç©º/æ°´é¢', 
                        confidence: Math.min(0.88, colorStats.blue * 1.8),
                        category: 'nature' 
                    });
                }
                
                if (colorStats.gray > 0.5) {
                    objects.push({ 
                        label: 'å»ºç­‘ç‰©', 
                        confidence: Math.min(0.85, colorStats.gray * 1.3),
                        category: 'architecture' 
                    });
                }

                // è¾¹ç¼˜æ£€æµ‹
                const edgeInfo = this.detectEdges(data, width, height);
                if (edgeInfo.strongEdges > 0.3) {
                    objects.push({ 
                        label: 'å‡ ä½•å½¢çŠ¶', 
                        confidence: Math.min(0.80, edgeInfo.strongEdges),
                        category: 'geometric' 
                    });
                }

                return objects;
            }

            async classifyScene(imageData) {
                const data = imageData.data;
                const brightness = this.calculateBrightness(data);
                const contrast = this.calculateContrast(data);
                const colorComplexity = this.calculateColorComplexity(data);
                
                const scenes = [];
                
                // åœºæ™¯åˆ†ç±»è§„åˆ™
                if (brightness > 150 && colorComplexity > 0.6) {
                    scenes.push({ label: 'æˆ·å¤–é£æ™¯', confidence: 0.90 });
                }
                
                if (contrast > 60 && brightness < 100) {
                    scenes.push({ label: 'å®¤å†…åœºæ™¯', confidence: 0.85 });
                }
                
                if (colorComplexity < 0.3) {
                    scenes.push({ label: 'ç®€çº¦åœºæ™¯', confidence: 0.80 });
                }
                
                if (brightness > 200) {
                    scenes.push({ label: 'æ˜äº®åœºæ™¯', confidence: 0.85 });
                }
                
                if (brightness < 60) {
                    scenes.push({ label: 'å¤œæ™¯/æš—å…‰', confidence: 0.80 });
                }

                return scenes;
            }

            async analyzeEmotions(imageData) {
                const data = imageData.data;
                const colorTone = this.analyzeColorTone(data);
                const brightness = this.calculateBrightness(data);
                const contrast = this.calculateContrast(data);
                
                const emotions = [];
                
                if (colorTone.warm > 0.6 && brightness > 130) {
                    emotions.push({ 
                        label: 'æ¸©æš–', 
                        confidence: 0.85, 
                        color: '#FF6B35' 
                    });
                }
                
                if (colorTone.cool > 0.6) {
                    emotions.push({ 
                        label: 'å¹³é™', 
                        confidence: 0.80, 
                        color: '#4A90E2' 
                    });
                }
                
                if (brightness > 180) {
                    emotions.push({ 
                        label: 'æ„‰æ‚¦', 
                        confidence: 0.75, 
                        color: '#FFD700' 
                    });
                }
                
                if (contrast > 80) {
                    emotions.push({ 
                        label: 'æˆå‰§æ€§', 
                        confidence: 0.70, 
                        color: '#8B008B' 
                    });
                }

                return emotions;
            }

            async extractColors(imageData) {
                const data = imageData.data;
                const colorCounts = {};
                
                // é™é‡‡æ ·æé«˜æ€§èƒ½
                for (let i = 0; i < data.length; i += 16) {
                    const r = Math.round(data[i] / 32) * 32;
                    const g = Math.round(data[i + 1] / 32) * 32;
                    const b = Math.round(data[i + 2] / 32) * 32;
                    const key = `${r},${g},${b}`;
                    colorCounts[key] = (colorCounts[key] || 0) + 1;
                }

                const dominantColors = Object.entries(colorCounts)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 5)
                    .map(([rgb, count]) => {
                        const [r, g, b] = rgb.split(',').map(Number);
                        return {
                            rgb: `rgb(${r},${g},${b})`,
                            hex: this.rgbToHex(r, g, b),
                            count: count,
                            percentage: Math.round((count / (data.length / 16)) * 100),
                            name: this.getColorName(r, g, b),
                            brightness: Math.round((r + g + b) / 3)
                        };
                    });

                return dominantColors;
            }

            async analyzeQuality(imageData) {
                const data = imageData.data;
                const width = imageData.width;
                const height = imageData.height;
                
                const quality = {
                    sharpness: this.calculateSharpness(data, width, height),
                    noise: this.calculateNoise(data),
                    exposure: this.calculateExposure(data),
                    overall: 0
                };
                
                quality.overall = (quality.sharpness + (1 - quality.noise) + quality.exposure) / 3;
                
                return quality;
            }

            async analyzeComposition(imageData) {
                const data = imageData.data;
                const width = imageData.width;
                const height = imageData.height;
                
                return {
                    symmetry: this.calculateSymmetry(data, width, height),
                    ruleOfThirds: this.analyzeRuleOfThirds(data, width, height),
                    balance: this.calculateBalance(data, width, height)
                };
            }

            // è¾…åŠ©æ–¹æ³•
            calculateBrightness(data) {
                let sum = 0;
                for (let i = 0; i < data.length; i += 4) {
                    sum += (data[i] + data[i + 1] + data[i + 2]) / 3;
                }
                return sum / (data.length / 4);
            }

            calculateContrast(data) {
                const values = [];
                for (let i = 0; i < data.length; i += 4) {
                    values.push((data[i] + data[i + 1] + data[i + 2]) / 3);
                }
                const mean = values.reduce((a, b) => a + b) / values.length;
                const variance = values.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / values.length;
                return Math.sqrt(variance);
            }

            calculateColorComplexity(data) {
                const colors = new Set();
                for (let i = 0; i < data.length; i += 16) {
                    const r = Math.round(data[i] / 64) * 64;
                    const g = Math.round(data[i + 1] / 64) * 64;
                    const b = Math.round(data[i + 2] / 64) * 64;
                    colors.add(`${r},${g},${b}`);
                }
                return Math.min(colors.size / 64, 1);
            }

            analyzeColorDistribution(data) {
                let green = 0, blue = 0, skin = 0, gray = 0, total = 0;

                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];
                    
                    if (g > r && g > b && g > 100) green++;
                    if (b > r && b > g && b > 100) blue++;
                    if (r > 95 && g > 40 && b > 20 && r > g && r > b) skin++;
                    if (Math.abs(r - g) < 15 && Math.abs(g - b) < 15) gray++;
                    total++;
                }

                return {
                    green: green / total,
                    blue: blue / total,
                    skin: skin / total,
                    gray: gray / total
                };
            }

            analyzeColorTone(data) {
                let warm = 0, cool = 0, vibrant = 0, total = 0;

                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];

                    if (r > b) warm++;
                    if (b > r) cool++;
                    if (Math.max(r, g, b) - Math.min(r, g, b) > 100) vibrant++;
                    total++;
                }

                return {
                    warm: warm / total,
                    cool: cool / total,
                    vibrant: vibrant / total
                };
            }

            calculateSharpness(data, width, height) {
                let sharpness = 0;
                for (let y = 1; y < height - 1; y++) {
                    for (let x = 1; x < width - 1; x++) {
                        const idx = (y * width + x) * 4;
                        const current = (data[idx] + data[idx + 1] + data[idx + 2]) / 3;
                        const right = (data[idx + 4] + data[idx + 5] + data[idx + 6]) / 3;
                        const bottom = (data[idx + width * 4] + data[idx + width * 4 + 1] + data[idx + width * 4 + 2]) / 3;
                        sharpness += Math.abs(current - right) + Math.abs(current - bottom);
                    }
                }
                return Math.min(sharpness / (width * height * 255), 1);
            }

            calculateNoise(data) {
                let noise = 0;
                const sampleSize = Math.min(data.length / 4, 10000);
                
                for (let i = 0; i < sampleSize; i++) {
                    const idx = (Math.floor(Math.random() * data.length / 4)) * 4;
                    const r = data[idx];
                    const g = data[idx + 1];
                    const b = data[idx + 2];
                    
                    const avg = (r + g + b) / 3;
                    noise += Math.abs(r - avg) + Math.abs(g - avg) + Math.abs(b - avg);
                }
                
                return Math.min(noise / (sampleSize * 255), 1);
            }

            calculateExposure(data) {
                let overexposed = 0;
                let underexposed = 0;
                const total = data.length / 4;
                
                for (let i = 0; i < data.length; i += 4) {
                    const brightness = (data[i] + data[i + 1] + data[i + 2]) / 3;
                    if (brightness > 240) overexposed++;
                    if (brightness < 15) underexposed++;
                }
                
                const exposureProblems = (overexposed + underexposed) / total;
                return Math.max(0, 1 - exposureProblems * 2);
            }

            detectEdges(data, width, height) {
                let strongEdges = 0;
                const total = width * height;
                
                for (let y = 1; y < height - 1; y++) {
                    for (let x = 1; x < width - 1; x++) {
                        const idx = (y * width + x) * 4;
                        const current = (data[idx] + data[idx + 1] + data[idx + 2]) / 3;
                        
                        const neighbors = [
                            data[idx - 4], data[idx + 4],
                            data[idx - width * 4], data[idx + width * 4]
                        ];
                        
                        const maxDiff = Math.max(...neighbors.map(n => Math.abs(current - n)));
                        if (maxDiff > 50) strongEdges++;
                    }
                }
                
                return { strongEdges: strongEdges / total };
            }

            generateSmartTags(analysis) {
                const tags = new Set();

                // åŸºäºæ£€æµ‹ç»“æœçš„æ ‡ç­¾
                analysis.objects.forEach(obj => {
                    if (obj.confidence > 0.7) {
                        tags.add(obj.label);
                        if (obj.category) tags.add(obj.category);
                    }
                });

                analysis.scenes.forEach(scene => {
                    if (scene.confidence > 0.75) {
                        tags.add(scene.label);
                    }
                });

                analysis.emotions.forEach(emotion => {
                    if (emotion.confidence > 0.65) {
                        tags.add(emotion.label);
                    }
                });

                // åŸºäºé¢œè‰²çš„æ ‡ç­¾
                analysis.colors.forEach(color => {
                    if (color.percentage > 15) {
                        tags.add(color.name);
                        if (color.brightness > 200) tags.add('æ˜äº®');
                        if (color.brightness < 60) tags.add('æš—è°ƒ');
                    }
                });

                // åŸºäºè´¨é‡çš„æ ‡ç­¾
                if (analysis.quality.overall > 0.8) {
                    tags.add('é«˜è´¨é‡');
                } else if (analysis.quality.overall < 0.5) {
                    tags.add('ä½è´¨é‡');
                }

                return Array.from(tags);
            }

            calculateOverallConfidence(analysis) {
                const confidences = [
                    ...analysis.objects.map(o => o.confidence),
                    ...analysis.scenes.map(s => s.confidence),
                    ...analysis.emotions.map(e => e.confidence)
                ];
                
                if (confidences.length === 0) return 0;
                return confidences.reduce((a, b) => a + b) / confidences.length;
            }

            rgbToHex(r, g, b) {
                return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
            }

            getColorName(r, g, b) {
                const colorMap = {
                    red: [255, 0, 0], green: [0, 255, 0], blue: [0, 0, 255],
                    yellow: [255, 255, 0], purple: [128, 0, 128], orange: [255, 165, 0],
                    pink: [255, 192, 203], brown: [165, 42, 42], black: [0, 0, 0],
                    white: [255, 255, 255], gray: [128, 128, 128]
                };

                let closestColor = 'unknown';
                let minDistance = Infinity;

                for (const [name, [cr, cg, cb]] of Object.entries(colorMap)) {
                    const distance = Math.sqrt(Math.pow(r - cr, 2) + Math.pow(g - cg, 2) + Math.pow(b - cb, 2));
                    if (distance < minDistance) {
                        minDistance = distance;
                        closestColor = name;
                    }
                }

                return closestColor;
            }

            getDefaultAnalysis() {
                return {
                    objects: [],
                    scenes: [],
                    emotions: [],
                    colors: [],
                    quality: { overall: 0.5, sharpness: 0.5, noise: 0.5, exposure: 0.5 },
                    composition: { symmetry: 0.5, ruleOfThirds: 0.5, balance: 0.5 },
                    smartTags: ['å›¾ç‰‡'],
                    confidence: 0.5,
                    timestamp: Date.now()
                };
            }

            updateImageAnalysis(cacheKey, analysis) {
                // æ›´æ–°ç•Œé¢ä¸­å¯¹åº”çš„å›¾ç‰‡åˆ†æç»“æœ
                const imageCard = document.querySelector(`[data-cache-key="${cacheKey}"]`);
                if (imageCard) {
                    updateImageCardAnalysis(imageCard, analysis);
                }
            }
        }

        // å›¾ç‰‡åŠ è½½å™¨
        class SmartImageLoader {
            constructor() {
                this.aiEngine = new EnhancedAIEngine();
                this.loadedImages = new Set();
                this.preloadQueue = [];
            }

            async loadAllImages() {
                console.log('ğŸ” å¼€å§‹æ™ºèƒ½åŠ è½½å›¾ç‰‡...');
                
                const strategies = [
                    this.loadFromGitHubAPI(),
                    this.loadFromDirectoryIndex(),
                    this.loadWithProbing(),
                    this.loadExampleImages()
                ];

                const results = await Promise.allSettled(strategies);
                let allImages = [];

                results.forEach((result, index) => {
                    if (result.status === 'fulfilled' && result.value.length > 0) {
                        console.log(`ç­–ç•¥ ${index + 1} åŠ è½½äº† ${result.value.length} å¼ å›¾ç‰‡`);
                        allImages = allImages.concat(result.value);
                    }
                });

                const uniqueImages = this.removeDuplicates(allImages);
                console.log(`æ€»å…±åŠ è½½äº† ${uniqueImages.length} å¼ å›¾ç‰‡`);

                return uniqueImages;
            }

            async loadFromGitHubAPI() {
                try {
                    const response = await fetch('https://api.github.com/repos/isLinXu/ai-images-galley/contents/images');
                    if (!response.ok) throw new Error('GitHub APIè¯·æ±‚å¤±è´¥');

                    const files = await response.json();
                    const imageFiles = files.filter(file => 
                        file.type === 'file' && 
                        /\.(jpg|jpeg|png|gif|webp|bmp|svg)$/i.test(file.name)
                    );

                    return imageFiles.map(file => ({
                        id: file.sha,
                        name: file.name,
                        url: `images/${file.name}`,
                        downloadUrl: file.download_url,
                        size: file.size,
                        loadMethod: 'GitHub API'
                    }));
                } catch (error) {
                    console.log('GitHub APIåŠ è½½å¤±è´¥');
                    return [];
                }
            }

            async loadFromDirectoryIndex() {
                try {
                    const response = await fetch('images/');
                    if (!response.ok) throw new Error('ç›®å½•ç´¢å¼•ä¸å¯ç”¨');

                    const html = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const links = doc.querySelectorAll('a[href]');

                    const imageFiles = [];
                    links.forEach(link => {
                        const href = link.getAttribute('href');
                        if (href && /\.(jpg|jpeg|png|gif|webp|bmp|svg)$/i.test(href)) {
                            imageFiles.push({
                                id: href,
                                name: href,
                                url: `images/${href}`,
                                loadMethod: 'Directory Index'
                            });
                        }
                    });

                    return imageFiles;
                } catch (error) {
                    console.log('ç›®å½•ç´¢å¼•åŠ è½½å¤±è´¥');
                    return [];
                }
            }

            async loadWithProbing() {
                const commonNames = [
                    'photo1.jpg', 'photo2.jpg', 'photo3.jpg', 'photo4.jpg', 'photo5.jpg',
                    'image1.png', 'image2.png', 'image3.png', 'image4.png', 'image5.png',
                    'pic1.jpg', 'pic2.jpg', 'pic3.jpg'
                ];

                const validImages = [];
                const promises = commonNames.map(name => this.checkImageExists(name));
                const results = await Promise.allSettled(promises);

                results.forEach(result => {
                    if (result.status === 'fulfilled' && result.value) {
                        validImages.push(result.value);
                    }
                });

                return validImages;
            }

            async loadExampleImages() {
                const exampleImages = [
                    {
                        id: 'example1',
                        name: 'ç¤ºä¾‹å›¾ç‰‡1.jpg',
                        url: 'https://picsum.photos/400/300?random=1',
                        loadMethod: 'åœ¨çº¿ç¤ºä¾‹'
                    },
                    {
                        id: 'example2',
                        name: 'ç¤ºä¾‹å›¾ç‰‡2.jpg',
                        url: 'https://picsum.photos/400/300?random=2',
                        loadMethod: 'åœ¨çº¿ç¤ºä¾‹'
                    },
                    {
                        id: 'example3',
                        name: 'ç¤ºä¾‹å›¾ç‰‡3.jpg',
                        url: 'https://picsum.photos/400/300?random=3',
                        loadMethod: 'åœ¨çº¿ç¤ºä¾‹'
                    },
                    {
                        id: 'example4',
                        name: 'ç¤ºä¾‹å›¾ç‰‡4.jpg',
                        url: 'https://picsum.photos/400/300?random=4',
                        loadMethod: 'åœ¨çº¿ç¤ºä¾‹'
                    }
                ];

                return exampleImages;
            }

            async checkImageExists(filename) {
                return new Promise((resolve) => {
                    const img = new Image();
                    const timeout = setTimeout(() => {
                        resolve(null);
                    }, 3000);

                    img.onload = () => {
                        clearTimeout(timeout);
                        resolve({
                            id: filename,
                            name: filename,
                            url: `images/${filename}`,
                            loadMethod: 'æ–‡ä»¶æ¢æµ‹'
                        });
                    };
                    img.onerror = () => {
                        clearTimeout(timeout);
                        resolve(null);
                    };
                    img.src = `images/${filename}`;
                });
            }

            removeDuplicates(images) {
                const seen = new Set();
                return images.filter(img => {
                    if (seen.has(img.name)) return false;
                    seen.add(img.name);
                    return true;
                });
            }

            // æ™ºèƒ½é¢„åŠ è½½
            async preloadImage(imageUrl) {
                if (this.loadedImages.has(imageUrl)) return;

                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => {
                        this.loadedImages.add(imageUrl);
                        resolve(img);
                    };
                    img.onerror = () => resolve(null);
                    img.src = imageUrl;
                });
            }
        }

        // åˆå§‹åŒ–
        const imageLoader = new SmartImageLoader();

        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ğŸš€ åˆå§‹åŒ–AIæ™ºèƒ½ç›¸å†Œ...');
            
            initializeUI();
            await loadImages();
            bindEvents();
            
            console.log('âœ… åˆå§‹åŒ–å®Œæˆ');
        });

        function initializeUI() {
            checkAdminStatus();
            initializeThemes();
            initializeSettings();
        }

        function checkAdminStatus() {
            const token = localStorage.getItem('github_token');
            const adminStatus = localStorage.getItem('admin_status');
            if (token && adminStatus === 'true') {
                setAdminMode(true);
            }
        }

        function setAdminMode(admin) {
            isAdmin = admin;
            const userStatus = document.getElementById('user-status');

            userStatus.innerHTML = admin ? `
                <span class="high-contrast-text font-medium">ç®¡ç†å‘˜æ¨¡å¼</span>
                <button onclick="logout()" class="admin-btn px-4 py-2 rounded-lg">
                    <i class="fas fa-sign-out-alt mr-2"></i>é€€å‡ºç™»å½•
                </button>
            ` : `
                <span class="high-contrast-text font-medium">æ¸¸å®¢æ¨¡å¼</span>
                <button onclick="showAdminLogin()" class="theme-btn px-4 py-2 rounded-lg">
                    <i class="fas fa-sign-in-alt mr-2"></i>ç®¡ç†å‘˜ç™»å½•
                </button>
            `;
        }

        function showAdminLogin() {
            document.getElementById('admin-login-modal').classList.remove('hidden');
        }

        function closeAdminModal() {
            document.getElementById('admin-login-modal').classList.add('hidden');
            document.getElementById('github-token').value = '';
        }

        async function handleAdminLogin() {
            const token = document.getElementById('github-token').value.trim();
            if (!token) {
                alert('è¯·è¾“å…¥GitHub Token');
                return;
            }

            try {
                const response = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (response.ok) {
                    localStorage.setItem('github_token', token);
                    localStorage.setItem('admin_status', 'true');
                    setAdminMode(true);
                    closeAdminModal();
                    showTooltip('âœ… ç®¡ç†å‘˜ç™»å½•æˆåŠŸï¼');
                } else {
                    showTooltip('âŒ GitHub TokenéªŒè¯å¤±è´¥');
                }
            } catch (error) {
                showTooltip('âŒ ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        function logout() {
            localStorage.removeItem('github_token');
            localStorage.removeItem('admin_status');
            setAdminMode(false);
            showTooltip('å·²é€€å‡ºç®¡ç†å‘˜æ¨¡å¼');
        }

        async function loadImages() {
            const loadingIndicator = document.getElementById('loading-indicator');
            const imagesGrid = document.getElementById('images-grid');
            const noImages = document.getElementById('no-images');
            const galleryStats = document.getElementById('gallery-stats');

            loadingIndicator.style.display = 'block';
            imagesGrid.style.display = 'none';
            noImages.style.display = 'none';
            galleryStats.style.display = 'none';

            try {
                currentImages = await imageLoader.loadAllImages();
                
                if (currentImages.length > 0) {
                    renderImages(currentImages);
                    updateGalleryStats();
                    imagesGrid.style.display = 'grid';
                    galleryStats.style.display = 'grid';
                    initializeTagFilter();
                } else {
                    noImages.style.display = 'block';
                }
            } catch (error) {
                console.error('åŠ è½½å›¾ç‰‡å¤±è´¥:', error);
                noImages.style.display = 'block';
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }

        function renderImages(images) {
            const grid = document.getElementById('images-grid');
            grid.innerHTML = '';

            // åˆ›å»ºè§‚å¯Ÿå™¨ç”¨äºæ‡’åŠ è½½
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target.querySelector('img');
                        const cacheKey = img.dataset.cacheKey;
                        
                        loadImageWithAnalysis(img, cacheKey);
                        observer.unobserve(entry.target);
                    }
                });
            }, { 
                rootMargin: '100px',
                threshold: 0.1
            });

            images.forEach((image, index) => {
                const imageCard = createImageCard(image, index);
                grid.appendChild(imageCard);
                observer.observe(imageCard);
            });
        }

        function createImageCard(image, index) {
            const card = document.createElement('div');
            card.className = 'image-card glass-effect rounded-xl overflow-hidden cursor-pointer slide-in';
            card.dataset.cacheKey = image.id;
            card.onclick = () => openImageModal(index);

            card.innerHTML = `
                <div class="image-container">
                    <img data-src="${image.url}" 
                         data-cache-key="${image.id}"
                         src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 300'%3E%3Crect width='400' height='300' fill='%23f0f0f0'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='%23666'%3EåŠ è½½ä¸­...%3C/text%3E%3C/svg%3E"
                         alt="${image.name}" 
                         class="smart-crop">
                    <div class="image-loading">
                        <div class="loading-spinner"></div>
                    </div>
                    <div class="ai-analysis-overlay">
                        <svg class="ai-progress-ring">
                            <circle cx="30" cy="30" r="25"></circle>
                            <circle cx="30" cy="30" r="25" class="progress"></circle>
                        </svg>
                        <p class="text-white font-semibold mt-2">AIåˆ†æä¸­...</p>
                    </div>
                    <div class="quality-badge quality-medium" style="display: none;">
                        <i class="fas fa-star mr-1"></i>
                        <span class="quality-text">åˆ†æä¸­</span>
                    </div>
                </div>
                <div class="p-4">
                    <h3 class="high-contrast-text font-semibold text-lg mb-2 truncate">${image.name}</h3>
                    <div class="flex items-center justify-between text-sm mb-2">
                        <span class="high-contrast-text opacity-75">${image.loadMethod}</span>
                        <div class="flex items-center space-x-2">
                            <button onclick="event.stopPropagation(); downloadImage('${image.url}', '${image.name}')" 
                                    class="text-blue-500 hover:text-blue-700 transition-colors">
                                <i class="fas fa-download"></i>
                            </button>
                            <button onclick="event.stopPropagation(); shareImage('${image.id}')" 
                                    class="text-green-500 hover:text-green-700 transition-colors">
                                <i class="fas fa-share"></i>
                            </button>
                        </div>
                    </div>
                    <div class="ai-info-container">
                        <div class="text-xs high-contrast-text opacity-75">
                            <i class="fas fa-brain mr-1"></i>AIåˆ†æä¸­...
                        </div>
                    </div>
                </div>
            `;

            return card;
        }

        async function loadImageWithAnalysis(imgElement, cacheKey) {
            const imageCard = imgElement.closest('.image-card');
            const loadingIndicator = imageCard.querySelector('.image-loading');
            const analysisOverlay = imageCard.querySelector('.ai-analysis-overlay');
            
            // åŠ è½½å›¾ç‰‡
            imgElement.onload = async () => {
                loadingIndicator.style.display = 'none';
                
                // æ™ºèƒ½é¢„åŠ è½½ç›¸é‚»å›¾ç‰‡
                preloadNearbyImages(cacheKey);
                
                // å¼€å§‹AIåˆ†æ
                if (shouldAnalyzeImage(cacheKey)) {
                    analysisOverlay.style.display = 'flex';
                    
                    try {
                        const analysis = await imageLoader.aiEngine.analyzeImage(null, imgElement, 'normal');
                        aiAnalysisResults.set(cacheKey, analysis);
                        updateImageCardAnalysis(imageCard, analysis);
                        updateGalleryStats();
                    } catch (error) {
                        console.error('AIåˆ†æå¤±è´¥:', error);
                        analysisOverlay.style.display = 'none';
                    }
                }
            };

            imgElement.onerror = () => {
                loadingIndicator.innerHTML = '<i class="fas fa-exclamation-triangle text-red-500"></i>';
                analysisOverlay.style.display = 'none';
            };

            imgElement.src = imgElement.dataset.src;
        }

        function shouldAnalyzeImage(cacheKey) {
            const settings = getSettings();
            return settings.autoAnalyze || !aiAnalysisResults.has(cacheKey);
        }

        function preloadNearbyImages(currentCacheKey) {
            const settings = getSettings();
            if (!settings.smartPreload) return;

            const currentIndex = currentImages.findIndex(img => img.id === currentCacheKey);
            const preloadRange = 2; // é¢„åŠ è½½å‰å2å¼ å›¾ç‰‡

            for (let i = Math.max(0, currentIndex - preloadRange); 
                 i <= Math.min(currentImages.length - 1, currentIndex + preloadRange); 
                 i++) {
                if (i !== currentIndex) {
                    imageLoader.preloadImage(currentImages[i].url);
                }
            }
        }

        function updateImageCardAnalysis(imageCard, analysis) {
            const analysisOverlay = imageCard.querySelector('.ai-analysis-overlay');
            const qualityBadge = imageCard.querySelector('.quality-badge');
            const qualityText = imageCard.querySelector('.quality-text');
            const aiInfoContainer = imageCard.querySelector('.ai-info-container');

            // éšè—åˆ†æè¦†ç›–å±‚
            analysisOverlay.style.display = 'none';

            // æ›´æ–°è´¨é‡å¾½ç« 
            if (analysis.quality && analysis.quality.overall) {
                const quality = analysis.quality.overall;
                qualityBadge.style.display = 'block';
                
                if (quality > 0.8) {
                    qualityBadge.className = 'quality-badge quality-high';
                    qualityText.textContent = 'é«˜è´¨é‡';
                } else if (quality > 0.6) {
                    qualityBadge.className = 'quality-badge quality-medium';
                    qualityText.textContent = 'ä¸­ç­‰';
                } else {
                    qualityBadge.className = 'quality-badge quality-low';
                    qualityText.textContent = 'ä½è´¨é‡';
                }
            }

            // æ›´æ–°AIä¿¡æ¯
            aiInfoContainer.innerHTML = `
                <div class="space-y-1">
                    <div class="text-xs high-contrast-text opacity-75">
                        <i class="fas fa-brain mr-1"></i>AI: ${Math.round(analysis.confidence * 100)}%
                    </div>
                    ${analysis.objects.length > 0 ? `
                        <div class="text-xs high-contrast-text opacity-75">
                            <i class="fas fa-eye mr-1"></i>${analysis.objects[0].label}
                        </div>
                    ` : ''}
                    ${analysis.smartTags.length > 0 ? `
                        <div class="flex flex-wrap gap-1 mt-2">
                            ${analysis.smartTags.slice(0, 3).map(tag => `
                                <span class="tag-item px-2 py-1 rounded text-xs">${tag}</span>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function updateGalleryStats() {
            const totalImages = currentImages.length;
            const analyzedImages = aiAnalysisResults.size;
            const allTags = new Set();
            let totalScore = 0;

            aiAnalysisResults.forEach(analysis => {
                analysis.smartTags.forEach(tag => allTags.add(tag));
                totalScore += analysis.confidence;
            });

            const avgScore = analyzedImages > 0 ? Math.round((totalScore / analyzedImages) * 100) : 0;

            document.getElementById('total-images').textContent = totalImages;
            document.getElementById('analyzed-images').textContent = analyzedImages;
            document.getElementById('total-tags').textContent = allTags.size;
            document.getElementById('avg-score').textContent = avgScore + '%';
        }

        function openImageModal(index) {
            currentImageIndex = index;
            const image = currentImages[index];
            const analysis = aiAnalysisResults.get(image.id);

            document.getElementById('modal-title').textContent = image.name;
            document.getElementById('modal-image').src = image.url;

            updateModalImageInfo(image);
            updateModalAIAnalysis(analysis);
            updateModalTags(analysis ? analysis.smartTags : []);

            document.getElementById('image-detail-modal').classList.remove('hidden');
            
            // å¦‚æœè¿˜æ²¡æœ‰åˆ†æç»“æœï¼Œç«‹å³å¼€å§‹åˆ†æ
            if (!analysis) {
                analyzeCurrentImage();
            }
        }

        function updateModalImageInfo(image) {
            const container = document.getElementById('modal-image-info');
            container.innerHTML = `
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span class="high-contrast-text font-medium">æ–‡ä»¶å:</span>
                        <span class="high-contrast-text">${image.name}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="high-contrast-text font-medium">æ¥æº:</span>
                        <span class="high-contrast-text">${image.loadMethod}</span>
                    </div>
                    ${image.size ? `
                        <div class="flex justify-between">
                            <span class="high-contrast-text font-medium">å¤§å°:</span>
                            <span class="high-contrast-text">${formatFileSize(image.size)}</span>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function updateModalAIAnalysis(analysis) {
            const container = document.getElementById('modal-ai-analysis');
            
            if (!analysis) {
                container.innerHTML = `
                    <div class="glass-effect rounded-lg p-4 text-center">
                        <div class="loading-spinner mx-auto mb-4"></div>
                        <p class="high-contrast-text">æ­£åœ¨è¿›è¡ŒAIåˆ†æ...</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="space-y-4">
                    <div class="ai-analysis-item">
                        <div class="flex items-center justify-between mb-2">
                            <span class="high-contrast-text font-semibold">æ•´ä½“ç½®ä¿¡åº¦</span>
                            <span class="high-contrast-text font-bold">${Math.round(analysis.confidence * 100)}%</span>
                        </div>
                        <div class="confidence-bar">
                            <div class="h-full bg-blue-500 rounded transition-all duration-500" 
                                 style="width: ${analysis.confidence * 100}%"></div>
                        </div>
                    </div>
                    
                    ${analysis.objects.length > 0 ? `
                        <div class="ai-analysis-item">
                            <h4 class="high-contrast-text font-semibold mb-3">
                                <i class="fas fa-eye mr-2"></i>æ£€æµ‹åˆ°çš„ç‰©ä½“
                            </h4>
                            <div class="space-y-2">
                                ${analysis.objects.map(obj => `
                                    <div class="flex items-center justify-between">
                                        <span class="high-contrast-text">${obj.label}</span>
                                        <span class="text-sm high-contrast-text opacity-75">${Math.round(obj.confidence * 100)}%</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${analysis.scenes.length > 0 ? `
                        <div class="ai-analysis-item">
                            <h4 class="high-contrast-text font-semibold mb-3">
                                <i class="fas fa-landscape mr-2"></i>åœºæ™¯åˆ†æ
                            </h4>
                            <div class="space-y-2">
                                ${analysis.scenes.map(scene => `
                                    <div class="flex items-center justify-between">
                                        <span class="high-contrast-text">${scene.label}</span>
                                        <span class="text-sm high-contrast-text opacity-75">${Math.round(scene.confidence * 100)}%</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${analysis.quality ? `
                        <div class="ai-analysis-item">
                            <h4 class="high-contrast-text font-semibold mb-3">
                                <i class="fas fa-award mr-2"></i>å›¾ç‰‡è´¨é‡
                            </h4>
                            <div class="space-y-2">
                                <div class="flex items-center justify-between">
                                    <span class="high-contrast-text">æ¸…æ™°åº¦</span>
                                    <span class="text-sm high-contrast-text opacity-75">${Math.round(analysis.quality.sharpness * 100)}%</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="high-contrast-text">å™ªç‚¹æ§åˆ¶</span>
                                    <span class="text-sm high-contrast-text opacity-75">${Math.round((1 - analysis.quality.noise) * 100)}%</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="high-contrast-text">æ›å…‰</span>
                                    <span class="text-sm high-contrast-text opacity-75">${Math.round(analysis.quality.exposure * 100)}%</span>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function updateModalTags(tags) {
            const container = document.getElementById('modal-tags');
            container.innerHTML = tags.map(tag => `
                <span class="tag-item px-3 py-1 rounded-lg text-sm">${tag}</span>
            `).join('');
        }

        function navigateImage(direction) {
            const newIndex = currentImageIndex + direction;
            if (newIndex >= 0 && newIndex < currentImages.length) {
                openImageModal(newIndex);
            }
        }

        function closeImageModal() {
            document.getElementById('image-detail-modal').classList.add('hidden');
        }

        async function analyzeCurrentImage() {
            if (currentImageIndex < 0 || currentImageIndex >= currentImages.length) return;

            const image = currentImages[currentImageIndex];
            const modalImage = document.getElementById('modal-image');
            
            updateModalAIAnalysis(null); // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            
            try {
                const analysis = await imageLoader.aiEngine.analyzeImage(null, modalImage, 'high');
                aiAnalysisResults.set(image.id, analysis);
                updateModalAIAnalysis(analysis);
                updateModalTags(analysis.smartTags);
                updateGalleryStats();
                
                // æ›´æ–°å¯¹åº”çš„å›¾ç‰‡å¡ç‰‡
                const imageCard = document.querySelector(`[data-cache-key="${image.id}"]`);
                if (imageCard) {
                    updateImageCardAnalysis(imageCard, analysis);
                }
            } catch (error) {
                console.error('AIåˆ†æå¤±è´¥:', error);
                updateModalAIAnalysis(imageLoader.aiEngine.getDefaultAnalysis());
            }
        }

        function downloadImage(url, filename) {
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function shareImage(imageId) {
            const image = currentImages.find(img => img.id === imageId);
            if (!image) return;

            if (navigator.share) {
                navigator.share({
                    title: image.name,
                    url: image.url
                });
            } else {
                navigator.clipboard.writeText(image.url).then(() => {
                    showTooltip('å›¾ç‰‡é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                });
            }
        }

        function downloadCurrentImage() {
            if (currentImageIndex >= 0 && currentImageIndex < currentImages.length) {
                const image = currentImages[currentImageIndex];
                downloadImage(image.url, image.name);
            }
        }

        function shareCurrentImage() {
            if (currentImageIndex >= 0 && currentImageIndex < currentImages.length) {
                const image = currentImages[currentImageIndex];
                shareImage(image.id);
            }
        }

        async function refreshGallery() {
            await loadImages();
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });

            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('admin-btn');
                btn.classList.add('theme-btn');
            });

            const targetTab = document.getElementById(tabName + '-tab');
            if (targetTab) {
                targetTab.classList.remove('hidden');
            }

            const activeBtn = document.querySelector(`.tab-btn[onclick="showTab('${tabName}')"]`);
            if (activeBtn) {
                activeBtn.classList.remove('theme-btn');
                activeBtn.classList.add('admin-btn');
            }

            // ç‰¹æ®Šå¤„ç†AIåˆ†ææ ‡ç­¾é¡µ
            if (tabName === 'ai-analysis') {
                updateAIAnalysisTab();
            }
        }

        function updateAIAnalysisTab() {
            const container = document.getElementById('ai-analysis-details');
            
            if (aiAnalysisResults.size === 0) {
                container.innerHTML = `
                    <div class="glass-effect rounded-xl p-12 text-center">
                        <i class="fas fa-brain text-6xl text-gray-400 mb-4"></i>
                        <h3 class="high-contrast-text text-xl font-semibold mb-2">æš‚æ— AIåˆ†ææ•°æ®</h3>
                        <p class="high-contrast-text opacity-75">è¯·å…ˆæµè§ˆå›¾ç‰‡ä»¥å¼€å§‹AIåˆ†æ</p>
                    </div>
                `;
                return;
            }

            // ç»Ÿè®¡åˆ†æç»“æœ
            const stats = {
                objects: {},
                scenes: {},
                emotions: {},
                colors: {}
            };

            aiAnalysisResults.forEach(analysis => {
                analysis.objects.forEach(obj => {
                    stats.objects[obj.label] = (stats.objects[obj.label] || 0) + 1;
                });
                analysis.scenes.forEach(scene => {
                    stats.scenes[scene.label] = (stats.scenes[scene.label] || 0) + 1;
                });
                analysis.emotions.forEach(emotion => {
                    stats.emotions[emotion.label] = (stats.emotions[emotion.label] || 0) + 1;
                });
                analysis.colors.forEach(color => {
                    stats.colors[color.name] = (stats.colors[color.name] || 0) + 1;
                });
            });

            container.innerHTML = `
                <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="glass-effect rounded-xl p-6">
                        <h3 class="high-contrast-text text-lg font-semibold mb-4">
                            <i class="fas fa-fire mr-2"></i>çƒ­é—¨ç‰©ä½“
                        </h3>
                        <div class="space-y-2">
                            ${Object.entries(stats.objects)
                                .sort(([,a], [,b]) => b - a)
                                .slice(0, 5)
                                .map(([object, count]) => `
                                    <div class="flex justify-between items-center">
                                        <span class="high-contrast-text">${object}</span>
                                        <span class="ai-badge px-2 py-1 rounded text-sm">${count}</span>
                                    </div>
                                `).join('')}
                        </div>
                    </div>
                    
                    <div class="glass-effect rounded-xl p-6">
                        <h3 class="high-contrast-text text-lg font-semibold mb-4">
                            <i class="fas fa-mountain mr-2"></i>çƒ­é—¨åœºæ™¯
                        </h3>
                        <div class="space-y-2">
                            ${Object.entries(stats.scenes)
                                .sort(([,a], [,b]) => b - a)
                                .slice(0, 5)
                                .map(([scene, count]) => `
                                    <div class="flex justify-between items-center">
                                        <span class="high-contrast-text">${scene}</span>
                                        <span class="ai-badge px-2 py-1 rounded text-sm">${count}</span>
                                    </div>
                                `).join('')}
                        </div>
                    </div>
                    
                    <div class="glass-effect rounded-xl p-6">
                        <h3 class="high-contrast-text text-lg font-semibold mb-4">
                            <i class="fas fa-heart mr-2"></i>æƒ…æ„Ÿåˆ†å¸ƒ
                        </h3>
                        <div class="space-y-2">
                            ${Object.entries(stats.emotions)
                                .sort(([,a], [,b]) => b - a)
                                .slice(0, 5)
                                .map(([emotion, count]) => `
                                    <div class="flex justify-between items-center">
                                        <span class="high-contrast-text">${emotion}</span>
                                        <span class="ai-badge px-2 py-1 rounded text-sm">${count}</span>
                                    </div>
                                `).join('')}
                        </div>
                    </div>
                    
                    <div class="glass-effect rounded-xl p-6">
                        <h3 class="high-contrast-text text-lg font-semibold mb-4">
                            <i class="fas fa-palette mr-2"></i>ä¸»è¦é¢œè‰²
                        </h3>
                        <div class="space-y-2">
                            ${Object.entries(stats.colors)
                                .sort(([,a], [,b]) => b - a)
                                .slice(0, 5)
                                .map(([color, count]) => `
                                    <div class="flex justify-between items-center">
                                        <span class="high-contrast-text">${color}</span>
                                        <span class="ai-badge px-2 py-1 rounded text-sm">${count}</span>
                                    </div>
                                `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function initializeThemes() {
            const themeOptions = document.getElementById('theme-options');
            const themes = [
                { name: 'é»˜è®¤ä¸»é¢˜', bg: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' },
                { name: 'æµ·æ´‹ä¸»é¢˜', bg: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' },
                { name: 'æ£®æ—ä¸»é¢˜', bg: 'linear-gradient(135deg, #134e5e 0%, #71b280 100%)' },
                { name: 'æ—¥è½ä¸»é¢˜', bg: 'linear-gradient(135deg, #ff6b6b 0%, #feca57 50%, #ff9ff3 100%)' }
            ];

            themeOptions.innerHTML = themes.map((theme, index) => `
                <div class="theme-option cursor-pointer" onclick="applyTheme(${index})">
                    <div class="w-full h-16 rounded-lg mb-2 transition-transform hover:scale-105" 
                         style="background: ${theme.bg}"></div>
                    <p class="high-contrast-text text-sm text-center">${theme.name}</p>
                </div>
            `).join('');

            const savedTheme = localStorage.getItem('selected_theme');
            if (savedTheme) {
                applyTheme(parseInt(savedTheme));
            }
        }

        function applyTheme(themeIndex) {
            const themes = [
                'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                'linear-gradient(135deg, #134e5e 0%, #71b280 100%)',
                'linear-gradient(135deg, #ff6b6b 0%, #feca57 50%, #ff9ff3 100%)'
            ];

            document.body.style.background = themes[themeIndex];
            localStorage.setItem('selected_theme', themeIndex);
            showTooltip('ä¸»é¢˜å·²æ›´æ–°');
        }

        function initializeSettings() {
            const settings = getSettings();
            
            document.getElementById('auto-analyze').checked = settings.autoAnalyze;
            document.getElementById('smart-preload').checked = settings.smartPreload;
            document.getElementById('quality-analysis').checked = settings.qualityAnalysis;
        }

        function getSettings() {
            const defaultSettings = {
                autoAnalyze: false,
                smartPreload: true,
                qualityAnalysis: true
            };
            
            return {
                ...defaultSettings,
                ...JSON.parse(localStorage.getItem('gallery_settings') || '{}')
            };
        }

        function saveSettings() {
            const settings = {
                autoAnalyze: document.getElementById('auto-analyze').checked,
                smartPreload: document.getElementById('smart-preload').checked,
                qualityAnalysis: document.getElementById('quality-analysis').checked
            };
            
            localStorage.setItem('gallery_settings', JSON.stringify(settings));
        }

        function initializeTagFilter() {
            const tagFilter = document.getElementById('tag-filter');
            const tags = new Set();
            
            aiAnalysisResults.forEach(analysis => {
                analysis.smartTags.forEach(tag => tags.add(tag));
            });

            tagFilter.innerHTML = '<option value="">æ‰€æœ‰æ ‡ç­¾</option>' + 
                Array.from(tags).sort().map(tag => `<option value="${tag}">${tag}</option>`).join('');
        }

        function bindEvents() {
            const searchInput = document.getElementById('search-input');
            const tagFilter = document.getElementById('tag-filter');
            const sortOption = document.getElementById('sort-option');
            const searchSuggestions = document.getElementById('search-suggestions');

            // æœç´¢åŠŸèƒ½
            searchInput.addEventListener('input', debounce((e) => {
                const query = e.target.value.toLowerCase();
                
                if (query.length > 0) {
                    showSearchSuggestions(query);
                    filterImages(query);
                } else {
                    hideSearchSuggestions();
                    renderImages(currentImages);
                }
            }, 300));

            searchInput.addEventListener('focus', () => {
                if (searchInput.value.length > 0) {
                    showSearchSuggestions(searchInput.value.toLowerCase());
                }
            });

            searchInput.addEventListener('blur', () => {
                setTimeout(() => hideSearchSuggestions(), 200);
            });

            // æ ‡ç­¾è¿‡æ»¤
            tagFilter.addEventListener('change', () => {
                const selectedTag = tagFilter.value;
                const filteredImages = selectedTag ? 
                    currentImages.filter(image => {
                        const analysis = aiAnalysisResults.get(image.id);
                        return analysis && analysis.smartTags.includes(selectedTag);
                    }) : 
                    currentImages;
                renderImages(filteredImages);
            });

            // æ’åº
            sortOption.addEventListener('change', () => {
                const sortValue = sortOption.value;
                let sortedImages = [...currentImages];

                switch (sortValue) {
                    case 'newest':
                        sortedImages.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                        break;
                    case 'oldest':
                        sortedImages.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
                        break;
                    case 'name':
                        sortedImages.sort((a, b) => a.name.localeCompare(b.name));
                        break;
                    case 'ai-score':
                        sortedImages.sort((a, b) => {
                            const scoreA = aiAnalysisResults.get(a.id)?.confidence || 0;
                            const scoreB = aiAnalysisResults.get(b.id)?.confidence || 0;
                            return scoreB - scoreA;
                        });
                        break;
                }

                renderImages(sortedImages);
            });

            // é”®ç›˜å¯¼èˆª
            document.addEventListener('keydown', (event) => {
                if (!document.getElementById('image-detail-modal').classList.contains('hidden')) {
                    if (event.key === 'ArrowLeft') navigateImage(-1);
                    if (event.key === 'ArrowRight') navigateImage(1);
                    if (event.key === 'Escape') closeImageModal();
                }
            });

            // è®¾ç½®å˜æ›´ç›‘å¬
            document.querySelectorAll('#settings-tab input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', saveSettings);
            });

            // çª—å£å¤§å°å˜æ›´æ—¶é‡æ–°è°ƒæ•´
            window.addEventListener('resize', debounce(() => {
                adjustImageSize();
            }, 150));
        }

        function showSearchSuggestions(query) {
            const suggestions = generateSearchSuggestions(query);
            const container = document.getElementById('search-suggestions');
            
            if (suggestions.length > 0) {
                container.innerHTML = suggestions.map(suggestion => `
                    <div class="search-suggestion-item" onclick="selectSearchSuggestion('${suggestion}')">
                        <i class="fas fa-search mr-2"></i>${suggestion}
                    </div>
                `).join('');
                container.classList.remove('hidden');
            } else {
                hideSearchSuggestions();
            }
        }

        function hideSearchSuggestions() {
            document.getElementById('search-suggestions').classList.add('hidden');
        }

        function generateSearchSuggestions(query) {
            const suggestions = new Set();
            
            // ä»å›¾ç‰‡åç§°ä¸­æå–å»ºè®®
            currentImages.forEach(image => {
                if (image.name.toLowerCase().includes(query)) {
                    suggestions.add(image.name);
                }
            });

            // ä»æ ‡ç­¾ä¸­æå–å»ºè®®
            aiAnalysisResults.forEach(analysis => {
                analysis.smartTags.forEach(tag => {
                    if (tag.toLowerCase().includes(query)) {
                        suggestions.add(tag);
                    }
                });
            });

            return Array.from(suggestions).slice(0, 5);
        }

        function selectSearchSuggestion(suggestion) {
            document.getElementById('search-input').value = suggestion;
            hideSearchSuggestions();
            filterImages(suggestion.toLowerCase());
        }

        function filterImages(query) {
            const filteredImages = currentImages.filter(image => {
                const analysis = aiAnalysisResults.get(image.id);
                return image.name.toLowerCase().includes(query) ||
                       (analysis && analysis.smartTags.some(tag => tag.toLowerCase().includes(query)));
            });
            renderImages(filteredImages);
        }

        function adjustImageSize() {
            const modalImage = document.getElementById('modal-image');
            const container = document.querySelector('.modal-image-container');
            if (modalImage && container) {
                const maxHeight = window.innerHeight * 0.7;
                container.style.maxHeight = `${maxHeight}px`;
                modalImage.style.maxHeight = `${maxHeight}px`;
            }
        }

        function showTooltip(message) {
            const tooltip = document.getElementById('tooltip');
            tooltip.textContent = message;
            tooltip.classList.add('show');
            tooltip.style.left = '50%';
            tooltip.style.top = '20px';
            tooltip.style.transform = 'translateX(-50%)';
            
            setTimeout(() => {
                tooltip.classList.remove('show');
            }, 3000);
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // åˆå§‹åŒ–é»˜è®¤æ ‡ç­¾é¡µ
        showTab('gallery');
    </script>
</body>
</html>