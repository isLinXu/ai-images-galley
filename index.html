<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIæ™ºèƒ½ç›¸å†Œç³»ç»Ÿ - ä¼˜åŒ–ç‰ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.15.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.1/dist/mobilenet.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.2/dist/coco-ssd.min.js"></script>
    <style>
        * {
            font-family: 'Inter', sans-serif;
        }

        :root {
            --primary-color: #3B82F6;
            --secondary-color: #10B981;
            --accent-color: #F59E0B;
            --background-color: rgba(255, 255, 255, 0.95);
            --surface-color: rgba(255, 255, 255, 0.9);
            --text-color: #1F2937;
            --text-secondary: #6B7280;
            --border-color: #E5E7EB;
            --shadow-color: rgba(0, 0, 0, 0.1);
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text-color);
            transition: background 0.5s ease;
        }

        .glass-effect {
            backdrop-filter: blur(10px);
            background: var(--surface-color);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .high-contrast-text {
            color: #000 !important;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
        }

        .ai-badge {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .confidence-bar {
            background: linear-gradient(90deg, #10B981 0%, #F59E0B 50%, #EF4444 100%);
            height: 4px;
            border-radius: 2px;
            overflow: hidden;
        }

        .tag-item {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: white;
            font-weight: 500;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        .tag-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .tag-item.removable {
            position: relative;
            padding-right: 2rem;
        }

        .tag-item .remove-tag {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            opacity: 0.7;
        }

        .tag-item .remove-tag:hover {
            opacity: 1;
        }

        .image-card {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .image-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            border-color: var(--primary-color);
        }

        .image-container {
            position: relative;
            width: 100%;
            height: 240px;
            overflow: hidden;
            border-radius: 0.75rem;
            background: linear-gradient(45deg, #f0f0f0, #e0e0e0);
        }

        .image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .image-container:hover img {
            transform: scale(1.1);
        }

        .image-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #6B7280;
        }

        .ai-analysis-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.9), rgba(16, 185, 129, 0.9));
            backdrop-filter: blur(8px);
            opacity: 0;
            transition: opacity 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .image-card:hover .ai-analysis-overlay {
            opacity: 1;
        }

        .ai-progress-ring {
            width: 60px;
            height: 60px;
            transform: rotate(-90deg);
        }

        .ai-progress-ring circle {
            fill: none;
            stroke: rgba(255, 255, 255, 0.3);
            stroke-width: 4;
        }

        .ai-progress-ring .progress {
            stroke: white;
            stroke-dasharray: 157;
            stroke-dashoffset: 157;
            transition: stroke-dashoffset 0.3s ease;
        }

        .modal-overlay {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            transition: all 0.3s ease;
        }

        .modal-content {
            transform: scale(0.8);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 95vh;
            overflow-y: auto;
        }

        .modal-overlay:not(.hidden) .modal-content {
            transform: scale(1);
            opacity: 1;
        }

        .modal-image-container {
            position: relative;
            max-height: 70vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 1rem;
        }

        .modal-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 0.5rem;
        }

        .modal-nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            z-index: 10;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-color);
        }

        .modal-nav-btn:hover {
            background: rgba(255, 255, 255, 1);
            transform: translateY(-50%) scale(1.1);
        }

        .theme-btn {
            background: var(--surface-color);
            border: 2px solid var(--border-color);
            color: var(--text-color);
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .theme-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }

        .admin-btn {
            background: linear-gradient(45deg, #EF4444, #F59E0B);
            color: white;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid white;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .gradient-text {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
        }

        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #E5E7EB;
            border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            z-index: 50;
            max-height: 200px;
            overflow-y: auto;
        }

        .search-suggestion-item {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #F3F4F6;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .search-suggestion-item:hover {
            background: #F3F4F6;
        }

        .stats-card {
            background: var(--surface-color);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .stats-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .ai-analysis-item {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(16, 185, 129, 0.1));
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
        }

        .ai-analysis-item:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(16, 185, 129, 0.2));
            transform: translateX(4px);
        }

        .pulse-animation {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .slide-in {
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
            padding: 1rem;
        }

        .smart-crop {
            object-fit: cover;
            object-position: center;
        }

        .quality-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .quality-high {
            background: linear-gradient(45deg, #10B981, #34D399);
            color: white;
        }

        .quality-medium {
            background: linear-gradient(45deg, #F59E0B, #FBBF24);
            color: white;
        }

        .quality-low {
            background: linear-gradient(45deg, #EF4444, #F87171);
            color: white;
        }

        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.875rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1000;
        }

        .tooltip.show {
            opacity: 1;
        }

        .notes-section {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
        }

        .notes-textarea {
            width: 100%;
            min-height: 100px;
            padding: 0.75rem;
            border: 1px solid #E5E7EB;
            border-radius: 0.5rem;
            background: rgba(255, 255, 255, 0.9);
            color: #1F2937;
            resize: vertical;
            font-family: inherit;
        }

        .notes-textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .custom-tags-section {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
        }

        .tag-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #E5E7EB;
            border-radius: 0.5rem;
            background: rgba(255, 255, 255, 0.9);
            color: #1F2937;
            font-family: inherit;
        }

        .tag-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .custom-tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .lazy-image {
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .lazy-image.loaded {
            opacity: 1;
        }

        .preload-indicator {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(16, 185, 129, 0.8);
            color: white;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        #image-upload-section {
            transition: all 0.3s ease;
        }

        #image-upload-input {
            background: rgba(255, 255, 255, 0.9);
        }

        #upload-status .loading-spinner {
            display: inline-block;
            vertical-align: middle;
        }

        @media (max-width: 768px) {
            .image-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .modal-content {
                max-width: 95vw;
                margin: 1rem;
            }
            
            .modal-image-container {
                max-height: 50vh;
            }
        }

        @media print {
            body {
                background: white !important;
                color: black !important;
                font-size: 12px;
            }
            
            .modal-overlay {
                display: none !important;
            }
            
            .image-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 1rem;
            }
            
            .image-container {
                height: 200px;
            }
            
            .glass-effect {
                background: white;
                border: 1px solid #ccc;
            }
            
            .high-contrast-text {
                color: black !important;
                text-shadow: none !important;
            }
            
            .ai-badge, .tag-item {
                background: #f0f0f0 !important;
                color: black !important;
                border: 1px solid #ccc !important;
            }
        }
    </style>
</head>
<body>
    <nav class="glass-effect sticky top-0 z-50 border-b border-white/20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-4">
                    <h1 class="text-2xl font-bold gradient-text">
                        <i class="fas fa-brain mr-2"></i>AIæ™ºèƒ½ç›¸å†Œ
                    </h1>
                    <span class="ai-badge px-3 py-1 rounded-full text-sm">
                        <i class="fas fa-robot mr-1"></i>TensorFlow.js
                    </span>
                </div>
                <div class="flex items-center space-x-3">
                    <button id="theme-toggle" class="theme-btn px-4 py-2 rounded-lg">
                        <i class="fas fa-palette mr-2"></i>ä¸»é¢˜
                    </button>
                    <div id="user-status" class="flex items-center space-x-2">
                        <span class="high-contrast-text font-medium">æ¸¸å®¢æ¨¡å¼</span>
                        <button id="admin-login-btn" class="theme-btn px-4 py-2 rounded-lg">
                            <i class="fas fa-sign-in-alt mr-2"></i>ç®¡ç†å‘˜ç™»å½•
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <div class="glass-effect rounded-xl p-4 mb-6">
            <div class="flex flex-wrap gap-3 justify-center">
                <button onclick="showTab('gallery')" class="tab-btn theme-btn px-6 py-3 rounded-lg active">
                    <i class="fas fa-images mr-2"></i>å›¾ç‰‡æµè§ˆ
                </button>
                <button onclick="showTab('ai-analysis')" class="tab-btn theme-btn px-6 py-3 rounded-lg">
                    <i class="fas fa-brain mr-2"></i>AIåˆ†æ
                </button>
                <button onclick="showTab('settings')" class="tab-btn theme-btn px-6 py-3 rounded-lg">
                    <i class="fas fa-cog mr-2"></i>è®¾ç½®
                </button>
            </div>
        </div>

        <div class="glass-effect rounded-xl p-6 mb-6">
            <div class="flex flex-col lg:flex-row gap-4">
                <div class="flex-1 relative">
                    <input type="text" id="search-input" placeholder="ğŸ” æœç´¢å›¾ç‰‡ã€æ ‡ç­¾æˆ–æè¿°..." 
                           class="w-full px-4 py-3 rounded-lg border-2 border-gray-200 focus:border-blue-500 focus:outline-none high-contrast-text bg-white/90">
                    <div id="search-suggestions" class="search-suggestions hidden"></div>
                </div>
                <div class="flex gap-3">
                    <select id="tag-filter" class="px-4 py-3 rounded-lg border-2 border-gray-200 focus:border-blue-500 focus:outline-none high-contrast-text bg-white/90">
                        <option value="">æ‰€æœ‰æ ‡ç­¾</option>
                    </select>
                    <select id="sort-option" class="px-4 py-3 rounded-lg border-2 border-gray-200 focus:border-blue-500 focus:outline-none high-contrast-text bg-white/90">
                        <option value="newest">æœ€æ–°</option>
                        <option value="oldest">æœ€æ—§</option>
                        <option value="name">åç§°</option>
                        <option value="ai-score">AIè¯„åˆ†</option>
                        <option value="relevance">ç›¸å…³æ€§</option>
                    </select>
                    <button onclick="refreshGallery()" class="theme-btn px-6 py-3 rounded-lg">
                        <i class="fas fa-sync-alt mr-2"></i>åˆ·æ–°
                    </button>
                </div>
            </div>
        </div>
    </div>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-8">
        <div id="gallery-tab" class="tab-content">
            <div id="image-upload-section" class="glass-effect rounded-xl p-6 mb-6 hidden">
                <h3 class="high-contrast-text text-lg font-semibold mb-4">
                    <i class="fas fa-upload mr-2"></i>ä¸Šä¼ å›¾ç‰‡åˆ°GitHub
                </h3>
                <div class="flex flex-col gap-4">
                    <input type="file" id="image-upload-input" accept="image/*" multiple
                           class="px-4 py-3 rounded-lg border-2 border-gray-200 focus:border-blue-500 focus:outline-none high-contrast-text bg-white/90">
                    <div class="flex gap-3">
                        <button onclick="uploadImagesToGitHub()" class="admin-btn px-6 py-3 rounded-lg">
                            <i class="fas fa-cloud-upload-alt mr-2"></i>ä¸Šä¼ 
                        </button>
                        <div id="upload-status" class="text-sm high-contrast-text"></div>
                    </div>
                    <div class="flex items-center space-x-3 mt-3">
                        <input type="checkbox" id="auto-refresh-after-upload" class="w-4 h-4 text-blue-600 rounded" checked>
                        <span class="high-contrast-text">ä¸Šä¼ åè‡ªåŠ¨åˆ·æ–°å›¾åº“</span>
                    </div>
                </div>
            </div>

            <div id="loading-indicator" class="glass-effect rounded-xl p-8 text-center mb-6">
                <div class="loading-spinner mx-auto mb-4"></div>
                <p class="high-contrast-text text-lg font-medium">æ­£åœ¨åŠ è½½TensorFlow.jsæ¨¡å‹...</p>
                <div id="model-loading-progress" class="mt-4">
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <p class="text-sm high-contrast-text mt-2">æ¨¡å‹åŠ è½½ä¸­...</p>
                </div>
            </div>

            <div id="gallery-stats" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6" style="display: none;">
                <div class="stats-card rounded-xl p-4 text-center">
                    <i class="fas fa-images text-3xl text-blue-500 mb-2"></i>
                    <h3 class="high-contrast-text text-lg font-semibold">æ€»å›¾ç‰‡æ•°</h3>
                    <p id="total-images" class="text-2xl font-bold text-blue-500">0</p>
                </div>
                <div class="stats-card rounded-xl p-4 text-center">
                    <i class="fas fa-brain text-3xl text-green-500 mb-2"></i>
                    <h3 class="high-contrast-text text-lg font-semibold">å·²åˆ†æ</h3>
                    <p id="analyzed-images" class="text-2xl font-bold text-green-500">0</p>
                </div>
                <div class="stats-card rounded-xl p-4 text-center">
                    <i class="fas fa-tags text-3xl text-yellow-500 mb-2"></i>
                    <h3 class="high-contrast-text text-lg font-semibold">æ™ºèƒ½æ ‡ç­¾</h3>
                    <p id="total-tags" class="text-2xl font-bold text-yellow-500">0</p>
                </div>
                <div class="stats-card rounded-xl p-4 text-center">
                    <i class="fas fa-star text-3xl text-purple-500 mb-2"></i>
                    <h3 class="high-contrast-text text-lg font-semibold">å¹³å‡è¯„åˆ†</h3>
                    <p id="avg-score" class="text-2xl font-bold text-purple-500">0</p>
                </div>
            </div>

            <div id="images-grid" class="image-grid" style="display: none;"></div>
            
            <div id="no-images" class="glass-effect rounded-xl p-12 text-center" style="display: none;">
                <i class="fas fa-images text-6xl text-gray-400 mb-4"></i>
                <h3 class="high-contrast-text text-xl font-semibold mb-2">æš‚æ— å›¾ç‰‡</h3>
                <p class="high-contrast-text opacity-75">è¯·å°†å›¾ç‰‡æ·»åŠ åˆ° images æ–‡ä»¶å¤¹</p>
            </div>
        </div>

        <div id="ai-analysis-tab" class="tab-content hidden">
            <div class="glass-effect rounded-xl p-6">
                <h2 class="text-2xl font-bold high-contrast-text mb-6">
                    <i class="fas fa-brain mr-3"></i>AIåˆ†æç»Ÿè®¡
                </h2>
                <div id="ai-analysis-details" class="space-y-6"></div>
            </div>
        </div>

        <div id="settings-tab" class="tab-content hidden">
            <div class="glass-effect rounded-xl p-6">
                <h2 class="text-2xl font-bold high-contrast-text mb-6">
                    <i class="fas fa-cog mr-3"></i>ç³»ç»Ÿè®¾ç½®
                </h2>
                <div class="space-y-6">
                    <div>
                        <h3 class="high-contrast-text text-lg font-semibold mb-4">ä¸»é¢˜è®¾ç½®</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="theme-options"></div>
                    </div>
                    <div>
                        <h3 class="high-contrast-text text-lg font-semibold mb-4">AIåˆ†æè®¾ç½®</h3>
                        <div class="space-y-3">
                            <label class="flex items-center space-x-3">
                                <input type="checkbox" id="auto-analyze" class="w-4 h-4 text-blue-600 rounded">
                                <span class="high-contrast-text">è‡ªåŠ¨åˆ†ææ–°å›¾ç‰‡</span>
                            </label>
                            <label class="flex items-center space-x-3">
                                <input type="checkbox" id="smart-preload" class="w-4 h-4 text-blue-600 rounded" checked>
                                <span class="high-contrast-text">æ™ºèƒ½é¢„åŠ è½½</span>
                            </label>
                            <label class="flex items-center space-x-3">
                                <input type="checkbox" id="quality-analysis" class="w-4 h-4 text-blue-600 rounded" checked>
                                <span class="high-contrast-text">å›¾ç‰‡è´¨é‡åˆ†æ</span>
                            </label>
                            <label class="flex items-center space-x-3">
                                <input type="checkbox" id="tensorflow-analysis" class="w-4 h-4 text-blue-600 rounded" checked>
                                <span class="high-contrast-text">ä½¿ç”¨TensorFlow.jsåˆ†æ</span>
                            </label>
                        </div>
                    </div>
                    <div>
                        <h3 class="high-contrast-text text-lg font-semibold mb-4">æ€§èƒ½è®¾ç½®</h3>
                        <div class="space-y-3">
                            <label class="flex items-center space-x-3">
                                <input type="checkbox" id="image-compression" class="w-4 h-4 text-blue-600 rounded" checked>
                                <span class="high-contrast-text">å›¾ç‰‡å‹ç¼©</span>
                            </label>
                            <label class="flex items-center space-x-3">
                                <input type="checkbox" id="lazy-loading" class="w-4 h-4 text-blue-600 rounded" checked>
                                <span class="high-contrast-text">æ‡’åŠ è½½</span>
                            </label>
                            <div class="flex items-center space-x-3">
                                <span class="high-contrast-text">é¢„åŠ è½½æ•°é‡:</span>
                                <input type="range" id="preload-count" min="1" max="10" value="3" class="flex-1">
                                <span id="preload-count-value" class="high-contrast-text font-semibold">3</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="image-detail-modal" class="fixed inset-0 modal-overlay z-50 hidden flex items-center justify-center p-4">
        <div class="glass-effect rounded-2xl max-w-6xl w-full modal-content">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="modal-title" class="text-2xl font-bold high-contrast-text">å›¾ç‰‡è¯¦æƒ…</h2>
                    <button onclick="closeImageModal()" class="text-gray-500 hover:text-gray-700 text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="grid lg:grid-cols-2 gap-8">
                    <div class="modal-image-container">
                        <button onclick="navigateImage(-1)" class="modal-nav-btn left-4">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <img id="modal-image" class="modal-image" alt="">
                        <button onclick="navigateImage(1)" class="modal-nav-btn right-4">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    
                    <div class="space-y-6">
                        <div>
                            <h3 class="high-contrast-text text-lg font-semibold mb-4">
                                <i class="fas fa-info-circle mr-2"></i>å›¾ç‰‡ä¿¡æ¯
                            </h3>
                            <div id="modal-image-info" class="space-y-2"></div>
                        </div>
                        
                        <div>
                            <h3 class="high-contrast-text text-lg font-semibold mb-4">
                                <i class="fas fa-brain mr-2"></i>AIåˆ†æç»“æœ
                            </h3>
                            <div id="modal-ai-analysis" class="space-y-4"></div>
                        </div>
                        
                        <div>
                            <h3 class="high-contrast-text text-lg font-semibold mb-4">
                                <i class="fas fa-tags mr-2"></i>æ™ºèƒ½æ ‡ç­¾
                            </h3>
                            <div id="modal-tags" class="flex flex-wrap gap-2"></div>
                        </div>

                        <div class="notes-section">
                            <h3 class="high-contrast-text text-lg font-semibold mb-3">
                                <i class="fas fa-sticky-note mr-2"></i>å¤‡æ³¨
                            </h3>
                            <textarea id="image-notes" class="notes-textarea" placeholder="ä¸ºè¿™å¼ å›¾ç‰‡æ·»åŠ å¤‡æ³¨..."></textarea>
                            <div class="flex gap-2 mt-3">
                                <button onclick="saveImageNotes()" class="theme-btn px-4 py-2 rounded-lg text-sm">
                                    <i class="fas fa-save mr-1"></i>ä¿å­˜å¤‡æ³¨
                                </button>
                                <button onclick="clearImageNotes()" class="theme-btn px-4 py-2 rounded-lg text-sm">
                                    <i class="fas fa-trash mr-1"></i>æ¸…é™¤
                                </button>
                            </div>
                        </div>

                        <div class="custom-tags-section">
                            <h3 class="high-contrast-text text-lg font-semibold mb-3">
                                <i class="fas fa-tag mr-2"></i>è‡ªå®šä¹‰æ ‡ç­¾
                            </h3>
                            <div class="flex gap-2 mb-3">
                                <input type="text" id="custom-tag-input" class="tag-input flex-1" placeholder="è¾“å…¥è‡ªå®šä¹‰æ ‡ç­¾..." onkeypress="handleTagInputKeyPress(event)">
                                <button onclick="addCustomTag()" class="theme-btn px-4 py-2 rounded-lg text-sm">
                                    <i class="fas fa-plus mr-1"></i>æ·»åŠ 
                                </button>
                            </div>
                            <div id="custom-tags-container" class="custom-tags-container"></div>
                        </div>
                        
                        <div class="flex gap-3">
                            <button onclick="downloadCurrentImage()" class="theme-btn px-6 py-3 rounded-lg">
                                <i class="fas fa-download mr-2"></i>ä¸‹è½½
                            </button>
                            <button onclick="shareCurrentImage()" class="theme-btn px-6 py-3 rounded-lg">
                                <i class="fas fa-share mr-2"></i>åˆ†äº«
                            </button>
                            <button onclick="analyzeCurrentImage()" class="theme-btn px-6 py-3 rounded-lg">
                                <i class="fas fa-brain mr-2"></i>é‡æ–°åˆ†æ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="admin-login-modal" class="fixed inset-0 modal-overlay z-50 hidden flex items-center justify-center p-4">
        <div class="glass-effect rounded-2xl max-w-md w-full p-6 modal-content">
            <h2 class="text-2xl font-bold high-contrast-text mb-6 text-center">
                <i class="fas fa-key mr-2"></i>ç®¡ç†å‘˜ç™»å½•
            </h2>
            <div class="mb-4">
                <label class="block high-contrast-text text-sm font-semibold mb-2">GitHub Personal Access Token:</label>
                <input type="password" id="github-token" placeholder="è¾“å…¥æ‚¨çš„GitHub Token..." 
                       class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:border-blue-500 focus:outline-none high-contrast-text bg-white/90">
            </div>
            <div class="flex gap-3">
                <button onclick="handleAdminLogin()" class="flex-1 admin-btn px-6 py-3 rounded-lg font-semibold">
                    <i class="fas fa-sign-in-alt mr-2"></i>ç™»å½•
                </button>
                <button onclick="closeAdminModal()" class="flex-1 theme-btn px-6 py-3 rounded-lg">
                    å–æ¶ˆ
                </button>
            </div>
        </div>
    </div>

    <div id="tooltip" class="tooltip"></div>

    <script>
        // å…¨å±€å˜é‡
        let currentImages = [];
        let currentImageIndex = 0;
        let aiAnalysisResults = new Map();
        let imageNotes = new Map();
        let customTags = new Map();
        let isAdmin = false;
        let analysisQueue = [];
        let isAnalyzing = false;
        let searchSuggestions = [];
        let preloadedImages = new Set();
        let tensorflowModels = {};
        let isModelLoaded = false;

        // TensorFlow.js æ¨¡å‹ç®¡ç†å™¨
        class TensorFlowModelManager {
            constructor() {
                this.models = {};
                this.loadingProgress = 0;
            }

            async loadModels() {
                try {
                    this.updateProgress(10, 'æ­£åœ¨åŠ è½½MobileNetæ¨¡å‹...');
                    this.models.mobilenet = await mobilenet.load();
                    
                    this.updateProgress(60, 'æ­£åœ¨åŠ è½½COCO-SSDæ¨¡å‹...');
                    this.models.cocoSsd = await cocoSsd.load();
                    
                    this.updateProgress(100, 'æ¨¡å‹åŠ è½½å®Œæˆï¼');
                    isModelLoaded = true;
                    
                    setTimeout(() => {
                        document.getElementById('loading-indicator').style.display = 'none';
                        loadImages();
                    }, 1000);
                    
                } catch (error) {
                    console.error('æ¨¡å‹åŠ è½½å¤±è´¥:', error);
                    this.updateProgress(0, 'æ¨¡å‹åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨åŸºç¡€åˆ†æ');
                    setTimeout(() => {
                        document.getElementById('loading-indicator').style.display = 'none';
                        loadImages();
                    }, 2000);
                }
            }

            updateProgress(percentage, message) {
                const progressBar = document.getElementById('progress-bar');
                const progressText = document.querySelector('#model-loading-progress p');
                
                if (progressBar) {
                    progressBar.style.width = `${percentage}%`;
                }
                if (progressText) {
                    progressText.textContent = message;
                }
            }

            async classifyImage(imageElement) {
                if (!this.models.mobilenet) return [];
                
                try {
                    const predictions = await this.models.mobilenet.classify(imageElement);
                    return predictions.map(pred => ({
                        label: pred.className,
                        confidence: pred.probability,
                        category: 'classification'
                    }));
                } catch (error) {
                    console.error('å›¾åƒåˆ†ç±»å¤±è´¥:', error);
                    return [];
                }
            }

            async detectObjects(imageElement) {
                if (!this.models.cocoSsd) return [];
                
                try {
                    const predictions = await this.models.cocoSsd.detect(imageElement);
                    return predictions.map(pred => ({
                        label: pred.class,
                        confidence: pred.score,
                        category: 'detection',
                        bbox: pred.bbox
                    }));
                } catch (error) {
                    console.error('ç‰©ä½“æ£€æµ‹å¤±è´¥:', error);
                    return [];
                }
            }
        }

        // å¢å¼ºçš„AIåˆ†æå¼•æ“ï¼ˆé›†æˆTensorFlow.jsï¼‰
        class EnhancedAIEngine {
            constructor() {
                this.analysisCache = new Map();
                this.analysisQueue = [];
                this.isProcessing = false;
                this.workers = 2;
                this.tensorflowManager = new TensorFlowModelManager();
            }

            async analyzeImage(imageFile, imageElement, priority = 'normal') {
                const cacheKey = imageFile?.name || imageElement.src;
                
                if (this.analysisCache.has(cacheKey)) {
                    return this.analysisCache.get(cacheKey);
                }

                return new Promise((resolve) => {
                    this.analysisQueue.push({
                        imageFile,
                        imageElement,
                        cacheKey,
                        priority,
                        resolve
                    });
                    
                    this.processQueue();
                });
            }

            async processQueue() {
                if (this.isProcessing || this.analysisQueue.length === 0) return;
                
                this.isProcessing = true;
                
                this.analysisQueue.sort((a, b) => {
                    const priorityOrder = { 'high': 0, 'normal': 1, 'low': 2 };
                    return priorityOrder[a.priority] - priorityOrder[b.priority];
                });

                const batch = this.analysisQueue.splice(0, this.workers);
                
                const promises = batch.map(async (item) => {
                    try {
                        const result = await this.performAnalysis(item.imageFile, item.imageElement);
                        this.analysisCache.set(item.cacheKey, result);
                        item.resolve(result);
                        this.updateImageAnalysis(item.cacheKey, result);
                    } catch (error) {
                        console.error('åˆ†æå¤±è´¥:', error);
                        const defaultResult = this.getDefaultAnalysis();
                        this.analysisCache.set(item.cacheKey, defaultResult);
                        item.resolve(defaultResult);
                    }
                });

                await Promise.all(promises);
                this.isProcessing = false;
                
                if (this.analysisQueue.length > 0) {
                    setTimeout(() => this.processQueue(), 100);
                }
            }

            async performAnalysis(imageFile, imageElement) {
                const settings = getSettings();
                let analysis = {
                    objects: [],
                    scenes: [],
                    emotions: [],
                    colors: [],
                    quality: null,
                    composition: null,
                    smartTags: [],
                    confidence: 0,
                    timestamp: Date.now(),
                    method: 'basic'
                };

                // ä½¿ç”¨TensorFlow.jsè¿›è¡Œåˆ†æ
                if (settings.tensorflowAnalysis && isModelLoaded) {
                    try {
                        analysis.method = 'tensorflow';
                        
                        // å›¾åƒåˆ†ç±»
                        const classifications = await this.tensorflowManager.classifyImage(imageElement);
                        analysis.objects = analysis.objects.concat(classifications);
                        
                        // ç‰©ä½“æ£€æµ‹
                        const detections = await this.tensorflowManager.detectObjects(imageElement);
                        analysis.objects = analysis.objects.concat(detections);
                        
                    } catch (error) {
                        console.error('TensorFlow.jsåˆ†æå¤±è´¥ï¼Œå›é€€åˆ°åŸºç¡€åˆ†æ:', error);
                        analysis.method = 'basic_fallback';
                    }
                }

                // åŸºç¡€åˆ†æï¼ˆé¢œè‰²ã€è´¨é‡ç­‰ï¼‰
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                const maxSize = 512;
                let { width, height } = imageElement;
                
                if (width > maxSize || height > maxSize) {
                    const ratio = Math.min(maxSize / width, maxSize / height);
                    width *= ratio;
                    height *= ratio;
                }
                
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(imageElement, 0, 0, width, height);

                const imageData = ctx.getImageData(0, 0, width, height);
                
                // åŸºç¡€åˆ†æ
                if (analysis.objects.length === 0) {
                    analysis.objects = await this.detectObjectsBasic(imageData);
                }
                analysis.scenes = await this.classifyScene(imageData);
                analysis.emotions = await this.analyzeEmotions(imageData);
                analysis.colors = await this.extractColors(imageData);
                
                if (settings.qualityAnalysis) {
                    analysis.quality = await this.analyzeQuality(imageData);
                    analysis.composition = await this.analyzeComposition(imageData);
                }

                analysis.smartTags = this.generateSmartTags(analysis);
                analysis.confidence = this.calculateOverallConfidence(analysis);

                return analysis;
            }

            async detectObjectsBasic(imageData) {
                const data = imageData.data;
                const width = imageData.width;
                const height = imageData.height;
                
                const objects = [];
                const colorStats = this.analyzeColorDistribution(data);
                
                if (colorStats.skin > 0.15) {
                    objects.push({ 
                        label: 'äººç‰©', 
                        confidence: Math.min(0.95, colorStats.skin * 2),
                        category: 'person',
                        bbox: this.estimateBoundingBox(data, 'skin')
                    });
                }
                
                if (colorStats.green > 0.4) {
                    objects.push({ 
                        label: 'æ¤ç‰©', 
                        confidence: Math.min(0.90, colorStats.green * 1.5),
                        category: 'nature' 
                    });
                }
                
                if (colorStats.blue > 0.3) {
                    objects.push({ 
                        label: 'å¤©ç©º/æ°´é¢', 
                        confidence: Math.min(0.88, colorStats.blue * 1.8),
                        category: 'nature' 
                    });
                }
                
                if (colorStats.gray > 0.5) {
                    objects.push({ 
                        label: 'å»ºç­‘ç‰©', 
                        confidence: Math.min(0.85, colorStats.gray * 1.3),
                        category: 'architecture' 
                    });
                }

                const edgeInfo = this.detectEdges(data, width, height);
                if (edgeInfo.strongEdges > 0.3) {
                    objects.push({ 
                        label: 'å‡ ä½•å½¢çŠ¶', 
                        confidence: Math.min(0.80, edgeInfo.strongEdges),
                        category: 'geometric' 
                    });
                }

                return objects;
            }

            async classifyScene(imageData) {
                const data = imageData.data;
                const brightness = this.calculateBrightness(data);
                const contrast = this.calculateContrast(data);
                const colorComplexity = this.calculateColorComplexity(data);
                
                const scenes = [];
                
                if (brightness > 150 && colorComplexity > 0.6) {
                    scenes.push({ label: 'æˆ·å¤–é£æ™¯', confidence: 0.90 });
                }
                
                if (contrast > 60 && brightness < 100) {
                    scenes.push({ label: 'å®¤å†…åœºæ™¯', confidence: 0.85 });
                }
                
                if (colorComplexity < 0.3) {
                    scenes.push({ label: 'ç®€çº¦åœºæ™¯', confidence: 0.80 });
                }
                
                if (brightness > 200) {
                    scenes.push({ label: 'æ˜äº®åœºæ™¯', confidence: 0.85 });
                }
                
                if (brightness < 60) {
                    scenes.push({ label: 'å¤œæ™¯/æš—å…‰', confidence: 0.80 });
                }

                return scenes;
            }

            async analyzeEmotions(imageData) {
                const data = imageData.data;
                const colorTone = this.analyzeColorTone(data);
                const brightness = this.calculateBrightness(data);
                const contrast = this.calculateContrast(data);
                
                const emotions = [];
                
                if (colorTone.warm > 0.6 && brightness > 130) {
                    emotions.push({ 
                        label: 'æ¸©æš–', 
                        confidence: 0.85, 
                        color: '#FF6B35' 
                    });
                }
                
                if (colorTone.cool > 0.6) {
                    emotions.push({ 
                        label: 'å¹³é™', 
                        confidence: 0.80, 
                        color: '#4A90E2' 
                    });
                }
                
                if (brightness > 180) {
                    emotions.push({ 
                        label: 'æ„‰æ‚¦', 
                        confidence: 0.75, 
                        color: '#FFD700' 
                    });
                }
                
                if (contrast > 80) {
                    emotions.push({ 
                        label: 'æˆå‰§æ€§', 
                        confidence: 0.70, 
                        color: '#8B008B' 
                    });
                }

                return emotions;
            }

            async extractColors(imageData) {
                const data = imageData.data;
                const colorCounts = {};
                
                for (let i = 0; i < data.length; i += 16) {
                    const r = Math.round(data[i] / 32) * 32;
                    const g = Math.round(data[i + 1] / 32) * 32;
                    const b = Math.round(data[i + 2] / 32) * 32;
                    const key = `${r},${g},${b}`;
                    colorCounts[key] = (colorCounts[key] || 0) + 1;
                }

                const dominantColors = Object.entries(colorCounts)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 5)
                    .map(([rgb, count]) => {
                        const [r, g, b] = rgb.split(',').map(Number);
                        return {
                            rgb: `rgb(${r},${g},${b})`,
                            hex: this.rgbToHex(r, g, b),
                            count: count,
                            percentage: Math.round((count / (data.length / 16)) * 100),
                            name: this.getColorName(r, g, b),
                            brightness: Math.round((r + g + b) / 3)
                        };
                    });

                return dominantColors;
            }

            async analyzeQuality(imageData) {
                const data = imageData.data;
                const width = imageData.width;
                const height = imageData.height;
                
                const quality = {
                    sharpness: this.calculateSharpness(data, width, height),
                    noise: this.calculateNoise(data),
                    exposure: this.calculateExposure(data),
                    overall: 0
                };
                
                quality.overall = (quality.sharpness + (1 - quality.noise) + quality.exposure) / 3;
                
                return quality;
            }

            async analyzeComposition(imageData) {
                const data = imageData.data;
                const width = imageData.width;
                const height = imageData.height;
                
                return {
                    symmetry: this.calculateSymmetry(data, width, height),
                    ruleOfThirds: this.analyzeRuleOfThirds(data, width, height),
                    balance: this.calculateBalance(data, width, height)
                };
            }

            calculateBrightness(data) {
                let sum = 0;
                for (let i = 0; i < data.length; i += 4) {
                    sum += (data[i] + data[i + 1] + data[i + 2]) / 3;
                }
                return sum / (data.length / 4);
            }

            calculateContrast(data) {
                const values = [];
                for (let i = 0; i < data.length; i += 4) {
                    values.push((data[i] + data[i + 1] + data[i + 2]) / 3);
                }
                const mean = values.reduce((a, b) => a + b) / values.length;
                const variance = values.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / values.length;
                return Math.sqrt(variance);
            }

            calculateColorComplexity(data) {
                const colors = new Set();
                for (let i = 0; i < data.length; i += 16) {
                    const r = Math.round(data[i] / 64) * 64;
                    const g = Math.round(data[i + 1] / 64) * 64;
                    const b = Math.round(data[i + 2] / 64) * 64;
                    colors.add(`${r},${g},${b}`);
                }
                return Math.min(colors.size / 64, 1);
            }

            analyzeColorDistribution(data) {
                let green = 0, blue = 0, skin = 0, gray = 0, total = 0;

                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];
                    
                    if (g > r && g > b && g > 100) green++;
                    if (b > r && b > g && b > 100) blue++;
                    if (r > 95 && g > 40 && b > 20 && r > g && r > b) skin++;
                    if (Math.abs(r - g) < 15 && Math.abs(g - b) < 15) gray++;
                    total++;
                }

                return {
                    green: green / total,
                    blue: blue / total,
                    skin: skin / total,
                    gray: gray / total
                };
            }

            analyzeColorTone(data) {
                let warm = 0, cool = 0, vibrant = 0, total = 0;

                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];

                    if (r > b) warm++;
                    if (b > r) cool++;
                    if (Math.max(r, g, b) - Math.min(r, g, b) > 100) vibrant++;
                    total++;
                }

                return {
                    warm: warm / total,
                    cool: cool / total,
                    vibrant: vibrant / total
                };
            }

            calculateSharpness(data, width, height) {
                let sharpness = 0;
                for (let y = 1; y < height - 1; y++) {
                    for (let x = 1; x < width - 1; x++) {
                        const idx = (y * width + x) * 4;
                        const current = (data[idx] + data[idx + 1] + data[idx + 2]) / 3;
                        const right = (data[idx + 4] + data[idx + 5] + data[idx + 6]) / 3;
                        const bottom = (data[idx + width * 4] + data[idx + width * 4 + 1] + data[idx + width * 4 + 2]) / 3;
                        sharpness += Math.abs(current - right) + Math.abs(current - bottom);
                    }
                }
                return Math.min(sharpness / (width * height * 255), 1);
            }

            calculateNoise(data) {
                let noise = 0;
                const sampleSize = Math.min(data.length / 4, 10000);
                
                for (let i = 0; i < sampleSize; i++) {
                    const idx = (Math.floor(Math.random() * data.length / 4)) * 4;
                    const r = data[idx];
                    const g = data[idx + 1];
                    const b = data[idx + 2];
                    
                    const avg = (r + g + b) / 3;
                    noise += Math.abs(r - avg) + Math.abs(g - avg) + Math.abs(b - avg);
                }
                
                return Math.min(noise / (sampleSize * 255), 1);
            }

            calculateExposure(data) {
                let overexposed = 0;
                let underexposed = 0;
                const total = data.length / 4;
                
                for (let i = 0; i < data.length; i += 4) {
                    const brightness = (data[i] + data[i + 1] + data[i + 2]) / 3;
                    if (brightness > 240) overexposed++;
                    if (brightness < 15) underexposed++;
                }
                
                const exposureProblems = (overexposed + underexposed) / total;
                return Math.max(0, 1 - exposureProblems * 2);
            }

            detectEdges(data, width, height) {
                let strongEdges = 0;
                const total = width * height;
                
                for (let y = 1; y < height - 1; y++) {
                    for (let x = 1; x < width - 1; x++) {
                        const idx = (y * width + x) * 4;
                        const current = (data[idx] + data[idx + 1] + data[idx + 2]) / 3;
                        
                        const neighbors = [
                            data[idx - 4], data[idx + 4],
                            data[idx - width * 4], data[idx + width * 4]
                        ];
                        
                        const maxDiff = Math.max(...neighbors.map(n => Math.abs(current - n)));
                        if (maxDiff > 50) strongEdges++;
                    }
                }
                
                return { strongEdges: strongEdges / total };
            }

            calculateSymmetry(data, width, height) {
                let symmetry = 0;
                const halfWidth = Math.floor(width / 2);
                
                for (let y = 0; y < height; y++) {
                    for (let x = 0; x < halfWidth; x++) {
                        const leftIdx = (y * width + x) * 4;
                        const rightIdx = (y * width + (width - x - 1)) * 4;
                        
                        const leftValue = (data[leftIdx] + data[leftIdx + 1] + data[leftIdx + 2]) / 3;
                        const rightValue = (data[rightIdx] + data[rightIdx + 1] + data[rightIdx + 2]) / 3;
                        
                        symmetry += 1 - Math.abs(leftValue - rightValue) / 255;
                    }
                }
                
                return symmetry / (halfWidth * height);
            }

            analyzeRuleOfThirds(data, width, height) {
                const thirdWidth = width / 3;
                const thirdHeight = height / 3;
                
                let focalPoints = 0;
                let totalPoints = 0;
                
                for (let y = thirdHeight; y < 2 * thirdHeight; y++) {
                    for (let x = thirdWidth; x < 2 * thirdWidth; x++) {
                        const idx = (y * width + x) * 4;
                        const value = (data[idx] + data[idx + 1] + data[idx + 2]) / 3;
                        
                        if (value > 100) focalPoints++;
                        totalPoints++;
                    }
                }
                
                return focalPoints / totalPoints;
            }

            calculateBalance(data, width, height) {
                const quadrants = [
                    { x: 0, y: 0, width: width / 2, height: height / 2 },
                    { x: width / 2, y: 0, width: width / 2, height: height / 2 },
                    { x: 0, y: height / 2, width: width / 2, height: height / 2 },
                    { x: width / 2, y: height / 2, width: width / 2, height: height / 2 }
                ];
                
                const brightnesses = quadrants.map(q => {
                    let sum = 0;
                    let count = 0;
                    
                    for (let y = q.y; y < q.y + q.height; y++) {
                        for (let x = q.x; x < q.x + q.width; x++) {
                            const idx = (y * width + x) * 4;
                            sum += (data[idx] + data[idx + 1] + data[idx + 2]) / 3;
                            count++;
                        }
                    }
                    return sum / count;
                });
                
                const mean = brightnesses.reduce((a, b) => a + b) / brightnesses.length;
                const variance = brightnesses.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / brightnesses.length;
                
                return 1 - Math.min(Math.sqrt(variance) / 255, 1);
            }

            generateSmartTags(analysis) {
                const tags = new Set();

                analysis.objects.forEach(obj => {
                    if (obj.confidence > 0.7) {
                        tags.add(obj.label);
                        if (obj.category) tags.add(obj.category);
                    }
                });

                analysis.scenes.forEach(scene => {
                    if (scene.confidence > 0.75) {
                        tags.add(scene.label);
                    }
                });

                analysis.emotions.forEach(emotion => {
                    if (emotion.confidence > 0.65) {
                        tags.add(emotion.label);
                    }
                });

                analysis.colors.forEach(color => {
                    if (color.percentage > 15) {
                        tags.add(color.name);
                        if (color.brightness > 200) tags.add('æ˜äº®');
                        if (color.brightness < 60) tags.add('æš—è°ƒ');
                    }
                });

                if (analysis.quality && analysis.quality.overall > 0.8) {
                    tags.add('é«˜è´¨é‡');
                } else if (analysis.quality && analysis.quality.overall < 0.5) {
                    tags.add('ä½è´¨é‡');
                }

                return Array.from(tags);
            }

            calculateOverallConfidence(analysis) {
                const confidences = [
                    ...analysis.objects.map(o => o.confidence || 0),
                    ...analysis.scenes.map(s => s.confidence || 0),
                    ...analysis.emotions.map(e => e.confidence || 0)
                ];
                
                if (confidences.length === 0) return 0;
                return confidences.reduce((a, b) => a + b) / confidences.length;
            }

            rgbToHex(r, g, b) {
                return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase();
            }

            getColorName(r, g, b) {
                const colorMap = {
                    red: [255, 0, 0], green: [0, 255, 0], blue: [0, 0, 255],
                    yellow: [255, 255, 0], purple: [128, 0, 128], orange: [255, 165, 0],
                    pink: [255, 192, 203], brown: [165, 42, 42], black: [0, 0, 0],
                    white: [255, 255, 255], gray: [128, 128, 128]
                };

                let closestColor = 'unknown';
                let minDistance = Infinity;

                for (const [name, [cr, cg, cb]] of Object.entries(colorMap)) {
                    const distance = Math.sqrt(Math.pow(r - cr, 2) + Math.pow(g - cg, 2) + Math.pow(b - cb, 2));
                    if (distance < minDistance) {
                        minDistance = distance;
                        closestColor = name;
                    }
                }

                return closestColor;
            }

            getDefaultAnalysis() {
                return {
                    objects: [],
                    scenes: [],
                    emotions: [],
                    colors: [],
                    quality: { overall: 0.5, sharpness: 0.5, noise: 0.5, exposure: 0.5 },
                    composition: { symmetry: 0.5, ruleOfThirds: 0.5, balance: 0.5 },
                    smartTags: ['å›¾ç‰‡'],
                    confidence: 0.5,
                    timestamp: Date.now(),
                    method: 'default'
                };
            }

            updateImageAnalysis(cacheKey, analysis) {
                const imageCard = document.querySelector(`[data-cache-key="${cacheKey}"]`);
                if (imageCard) {
                    updateImageCardAnalysis(imageCard, analysis);
                }
            }
        }

        // æ™ºèƒ½å›¾ç‰‡åŠ è½½å™¨ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
        class SmartImageLoader {
            constructor() {
                this.aiEngine = new EnhancedAIEngine();
                this.loadedImages = new Set();
                this.preloadQueue = [];
                this.compressionCanvas = document.createElement('canvas');
                this.compressionCtx = this.compressionCanvas.getContext('2d');
            }

            async loadAllImages() {
                console.log('ğŸ” å¼€å§‹æ™ºèƒ½åŠ è½½å›¾ç‰‡...');
                
                const strategies = [
                    this.loadFromGitHubAPI(),
                    this.loadFromDirectoryIndex(),
                    this.loadWithProbing(),
                    this.loadExampleImages()
                ];

                const results = await Promise.allSettled(strategies);
                let allImages = [];

                results.forEach((result, index) => {
                    if (result.status === 'fulfilled' && result.value.length > 0) {
                        console.log(`ç­–ç•¥ ${index + 1} åŠ è½½äº† ${result.value.length} å¼ å›¾ç‰‡`);
                        allImages = allImages.concat(result.value);
                    }
                });

                const uniqueImages = this.removeDuplicates(allImages);
                console.log(`æ€»å…±åŠ è½½äº† ${uniqueImages.length} å¼ å›¾ç‰‡`);

                return uniqueImages;
            }

            async loadFromGitHubAPI() {
                try {
                    const response = await fetch('https://api.github.com/repos/isLinXu/ai-images-galley/contents/images');
                    if (!response.ok) throw new Error('GitHub APIè¯·æ±‚å¤±è´¥');

                    const files = await response.json();
                    const imageFiles = files.filter(file => 
                        file.type === 'file' && 
                        /\.(jpg|jpeg|png|gif|webp|bmp|svg)$/i.test(file.name)
                    );

                    return imageFiles.map(file => ({
                        id: file.sha,
                        name: file.name,
                        url: `images/${file.name}`,
                        downloadUrl: file.download_url,
                        size: file.size,
                        loadMethod: 'GitHub API'
                    }));
                } catch (error) {
                    console.log('GitHub APIåŠ è½½å¤±è´¥');
                    return [];
                }
            }

            async loadFromDirectoryIndex() {
                try {
                    const response = await fetch('images/');
                    if (!response.ok) throw new Error('ç›®å½•ç´¢å¼•ä¸å¯ç”¨');

                    const html = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const links = doc.querySelectorAll('a[href]');

                    const imageFiles = [];
                    links.forEach(link => {
                        const href = link.getAttribute('href');
                        if (href && /\.(jpg|jpeg|png|gif|webp|bmp|svg)$/i.test(href)) {
                            imageFiles.push({
                                id: href,
                                name: href,
                                url: `images/${href}`,
                                loadMethod: 'Directory Index'
                            });
                        }
                    });

                    return imageFiles;
                } catch (error) {
                    console.log('ç›®å½•ç´¢å¼•åŠ è½½å¤±è´¥');
                    return [];
                }
            }

            async loadWithProbing() {
                const commonNames = [
                    'photo1.jpg', 'photo2.jpg', 'photo3.jpg', 'photo4.jpg', 'photo5.jpg',
                    'image1.png', 'image2.png', 'image3.png', 'image4.png', 'image5.png',
                    'pic1.jpg', 'pic2.jpg', 'pic3.jpg'
                ];

                const validImages = [];
                const promises = commonNames.map(name => this.checkImageExists(name));
                const results = await Promise.allSettled(promises);

                results.forEach(result => {
                    if (result.status === 'fulfilled' && result.value) {
                        validImages.push(result.value);
                    }
                });

                return validImages;
            }

            async loadExampleImages() {
                const exampleImages = [
                    {
                        id: 'example1',
                        name: 'ç¤ºä¾‹å›¾ç‰‡1.jpg',
                        url: 'https://picsum.photos/400/300?random=1',
                        loadMethod: 'åœ¨çº¿ç¤ºä¾‹'
                    },
                    {
                        id: 'example2',
                        name: 'ç¤ºä¾‹å›¾ç‰‡2.jpg',
                        url: 'https://picsum.photos/400/300?random=2',
                        loadMethod: 'åœ¨çº¿ç¤ºä¾‹'
                    },
                    {
                        id: 'example3',
                        name: 'ç¤ºä¾‹å›¾ç‰‡3.jpg',
                        url: 'https://picsum.photos/400/300?random=3',
                        loadMethod: 'åœ¨çº¿ç¤ºä¾‹'
                    },
                    {
                        id: 'example4',
                        name: 'ç¤ºä¾‹å›¾ç‰‡4.jpg',
                        url: 'https://picsum.photos/400/300?random=4',
                        loadMethod: 'åœ¨çº¿ç¤ºä¾‹'
                    }
                ];

                return exampleImages;
            }

            async checkImageExists(filename) {
                return new Promise((resolve) => {
                    const img = new Image();
                    const timeout = setTimeout(() => {
                        resolve(null);
                    }, 3000);

                    img.onload = () => {
                        clearTimeout(timeout);
                        resolve({
                            id: filename,
                            name: filename,
                            url: `images/${filename}`,
                            loadMethod: 'æ–‡ä»¶æ¢æµ‹'
                        });
                    };
                    img.onerror = () => {
                        clearTimeout(timeout);
                        resolve(null);
                    };
                    img.src = `images/${filename}`;
                });
            }

            removeDuplicates(images) {
                const seen = new Set();
                return images.filter(img => {
                    if (seen.has(img.name)) return false;
                    seen.add(img.name);
                    return true;
                });
            }

            async preloadImage(imageUrl, priority = 'low') {
                if (this.loadedImages.has(imageUrl)) return;

                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => {
                        this.loadedImages.add(imageUrl);
                        
                        const settings = getSettings();
                        if (settings.imageCompression) {
                            this.compressImage(img).then(resolve);
                        } else {
                            resolve(img);
                        }
                    };
                    img.onerror = () => resolve(null);
                    img.src = imageUrl;
                });
            }

            async compressImage(img, quality = 0.8) {
                const canvas = this.compressionCanvas;
                const ctx = this.compressionCtx;
                
                const maxWidth = 800;
                const maxHeight = 600;
                
                let { width, height } = img;
                
                if (width > maxWidth || height > maxHeight) {
                    const ratio = Math.min(maxWidth / width, maxHeight / height);
                    width *= ratio;
                    height *= ratio;
                }
                
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);
                
                return new Promise(resolve => {
                    canvas.toBlob(blob => {
                        const compressedImg = new Image();
                        compressedImg.onload = () => resolve(compressedImg);
                        compressedImg.src = URL.createObjectURL(blob);
                    }, 'image/jpeg', quality);
                });
            }

            async imageToFile(img, fileName) {
                return new Promise(resolve => {
                    this.compressionCanvas.toBlob(blob => {
                        resolve(new File([blob], fileName, { type: blob.type }));
                    }, 'image/jpeg', 0.8);
                });
            }
        }

        // åˆå§‹åŒ–
        const imageLoader = new SmartImageLoader();

        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ğŸš€ åˆå§‹åŒ–AIæ™ºèƒ½ç›¸å†Œ...');
            
            initializeUI();
            await imageLoader.aiEngine.tensorflowManager.loadModels();
            bindEvents();
            
            console.log('âœ… åˆå§‹åŒ–å®Œæˆ');
        });

        function initializeUI() {
            checkAdminStatus();
            initializeThemes();
            initializeSettings();
        }

        function checkAdminStatus() {
            const token = localStorage.getItem('github_token');
            const adminStatus = localStorage.getItem('admin_status');
            if (token && adminStatus === 'true') {
                setAdminMode(true);
            }
        }

        function setAdminMode(admin) {
            isAdmin = admin;
            const userStatus = document.getElementById('user-status');
            const uploadSection = document.getElementById('image-upload-section');

            userStatus.innerHTML = admin ? `
                <span class="high-contrast-text font-medium">ç®¡ç†å‘˜æ¨¡å¼</span>
                <button onclick="logout()" class="admin-btn px-4 py-2 rounded-lg">
                    <i class="fas fa-sign-out-alt mr-2"></i>é€€å‡ºç™»å½•
                </button>
            ` : `
                <span class="high-contrast-text font-medium">æ¸¸å®¢æ¨¡å¼</span>
                <button onclick="showAdminLogin()" class="theme-btn px-4 py-2 rounded-lg">
                    <i class="fas fa-sign-in-alt mr-2"></i>ç®¡ç†å‘˜ç™»å½•
                </button>
            `;
            
            uploadSection.classList.toggle('hidden', !admin);
        }

        function showAdminLogin() {
            document.getElementById('admin-login-modal').classList.remove('hidden');
        }

        function closeAdminModal() {
            document.getElementById('admin-login-modal').classList.add('hidden');
            document.getElementById('github-token').value = '';
        }

        async function handleAdminLogin() {
            const token = document.getElementById('github-token').value.trim();
            if (!token) {
                showTooltip('è¯·è¾“å…¥GitHub Token');
                return;
            }

            try {
                const response = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (response.ok) {
                    const scopesResponse = await fetch('https://api.github.com/rate_limit', {
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    const scopes = response.headers.get('X-OAuth-Scopes') || '';
                    if (!scopes.includes('repo')) {
                        showTooltip('Tokenç¼ºå°‘repoæƒé™ï¼Œè¯·æ£€æŸ¥');
                        return;
                    }

                    localStorage.setItem('github_token', token);
                    localStorage.setItem('admin_status', 'true');
                    setAdminMode(true);
                    closeAdminModal();
                    showTooltip('âœ… ç®¡ç†å‘˜ç™»å½•æˆåŠŸï¼');
                } else {
                    showTooltip('âŒ GitHub TokenéªŒè¯å¤±è´¥');
                }
            } catch (error) {
                showTooltip('âŒ ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        function logout() {
            localStorage.removeItem('github_token');
            localStorage.removeItem('admin_status');
            setAdminMode(false);
            showTooltip('å·²é€€å‡ºç®¡ç†å‘˜æ¨¡å¼');
        }

        async function uploadImagesToGitHub() {
            const input = document.getElementById('image-upload-input');
            const files = input.files;
            const uploadStatus = document.getElementById('upload-status');
            const token = localStorage.getItem('github_token');
            
            if (!isAdmin || !token) {
                showTooltip('è¯·å…ˆä»¥ç®¡ç†å‘˜èº«ä»½ç™»å½•');
                return;
            }

            if (files.length === 0) {
                showTooltip('è¯·é€‰æ‹©è‡³å°‘ä¸€å¼ å›¾ç‰‡');
                return;
            }

            uploadStatus.innerHTML = '<div class="loading-spinner inline-block mr-2"></div>æ­£åœ¨ä¸Šä¼ ...';
            
            const repo = 'isLinXu/ai-images-galley';
            const pathPrefix = 'images/';
            const newImages = [];

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                updateUploadProgress(i + 1, files.length);
                try {
                    // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
                    const checkResponse = await fetch(`https://api.github.com/repos/${repo}/contents/${pathPrefix}${file.name}`, {
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    if (checkResponse.ok) {
                        if (!confirm(`æ–‡ä»¶ ${file.name} å·²å­˜åœ¨ï¼Œæ˜¯å¦è¦†ç›–ï¼Ÿ`)) {
                            showTooltip(`å·²è·³è¿‡ ${file.name}`);
                            continue;
                        }
                    }

                    // å¯é€‰ï¼šå‹ç¼©å›¾ç‰‡
                    let uploadFile = file;
                    const settings = getSettings();
                    if (settings.imageCompression) {
                        const img = new Image();
                        img.src = URL.createObjectURL(file);
                        await new Promise(resolve => img.onload = resolve);
                        const compressedImg = await imageLoader.compressImage(img);
                        uploadFile = await imageLoader.imageToFile(compressedImg, file.name);
                    }

                    // ä¸Šä¼ å›¾ç‰‡
                    const base64Content = await fileToBase64(uploadFile);
                    const response = await fetch(`https://api.github.com/repos/${repo}/contents/${pathPrefix}${file.name}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        },
                        body: JSON.stringify({
                            message: `Upload ${file.name} via AI Gallery`,
                            content: base64Content.split(',')[1] // ç§»é™¤Base64å‰ç¼€
                        })
                    });

                    if (response.ok) {
                        newImages.push({
                            id: file.name,
                            name: file.name,
                            url: `images/${file.name}`,
                            loadMethod: 'GitHub Upload'
                        });
                        showTooltip(`âœ… ${file.name} ä¸Šä¼ æˆåŠŸ`);
                    } else {
                        const errorData = await response.json();
                        showTooltip(`âŒ ä¸Šä¼  ${file.name} å¤±è´¥: ${errorData.message}`);
                    }
                } catch (error) {
                    console.error(`ä¸Šä¼  ${file.name} å¤±è´¥:`, error);
                    showTooltip(`âŒ ä¸Šä¼  ${file.name} å¤±è´¥: ç½‘ç»œé”™è¯¯`);
                }
            }

            uploadStatus.innerHTML = newImages.length > 0 
                ? `<span class="text-green-500">æˆåŠŸä¸Šä¼  ${newImages.length}/${files.length} å¼ å›¾ç‰‡</span>`
                : '<span class="text-red-500">ä¸Šä¼ å¤±è´¥</span>';

            // è‡ªåŠ¨åˆ·æ–°å›¾åº“
            if (newImages.length > 0 && document.getElementById('auto-refresh-after-upload').checked) {
                currentImages = [...currentImages, ...newImages];
                await renderImages(currentImages);
                updateGalleryStats();
            }

            // æ¸…ç©ºè¾“å…¥
            input.value = '';
        }

        function updateUploadProgress(current, total) {
            const uploadStatus = document.getElementById('upload-status');
            uploadStatus.innerHTML = `
                <div class="loading-spinner inline-block mr-2"></div>
                æ­£åœ¨ä¸Šä¼  ${current}/${total}...
            `;
        }

        async function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // UIäº¤äº’åŠŸèƒ½
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.getElementById(`${tabId}-tab`).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`button[onclick="showTab('${tabId}')"]`).classList.add('active');

            if (tabId === 'ai-analysis') {
                renderAIAnalysisDetails();
            }
        }

        function initializeThemes() {
            const themes = [
                { name: 'é»˜è®¤', colors: { primary: '#3B82F6', secondary: '#10B981', accent: '#F59E0B' } },
                { name: 'å¤œé—´', colors: { primary: '#1E40AF', secondary: '#065F46', accent: '#B45309' } },
                { name: 'è‡ªç„¶', colors: { primary: '#059669', secondary: '#3B82F6', accent: '#D97706' } },
                { name: 'ç»å…¸', colors: { primary: '#7C3AED', secondary: '#DB2777', accent: '#EA580C' } }
            ];

            const themeOptions = document.getElementById('theme-options');
            themes.forEach(theme => {
                const button = document.createElement('button');
                button.className = 'theme-btn px-4 py-2 rounded-lg text-center';
                button.innerHTML = `
                    <div class="flex items-center justify-center space-x-2">
                        <div class="w-4 h-4 rounded-full" style="background: ${theme.colors.primary}"></div>
                        <span>${theme.name}</span>
                    </div>
                `;
                button.onclick = () => applyTheme(theme.colors);
                themeOptions.appendChild(button);
            });
        }

        function applyTheme(colors) {
            document.documentElement.style.setProperty('--primary-color', colors.primary);
            document.documentElement.style.setProperty('--secondary-color', colors.secondary);
            document.documentElement.style.setProperty('--accent-color', colors.accent);
            localStorage.setItem('theme', JSON.stringify(colors));
        }

        function initializeSettings() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                applyTheme(JSON.parse(savedTheme));
            }

            const settings = getSettings();
            document.getElementById('auto-analyze').checked = settings.autoAnalyze;
            document.getElementById('smart-preload').checked = settings.smartPreload;
            document.getElementById('quality-analysis').checked = settings.qualityAnalysis;
            document.getElementById('tensorflow-analysis').checked = settings.tensorflowAnalysis;
            document.getElementById('image-compression').checked = settings.imageCompression;
            document.getElementById('lazy-loading').checked = settings.lazyLoading;
            document.getElementById('preload-count').value = settings.preloadCount;
            document.getElementById('preload-count-value').textContent = settings.preloadCount;

            document.getElementById('preload-count').addEventListener('input', (e) => {
                document.getElementById('preload-count-value').textContent = e.target.value;
                saveSettings();
            });

            document.querySelectorAll('#settings-tab input[type="checkbox"]').forEach(input => {
                input.addEventListener('change', saveSettings);
            });
        }

        function getSettings() {
            return {
                autoAnalyze: document.getElementById('auto-analyze').checked,
                smartPreload: document.getElementById('smart-preload').checked,
                qualityAnalysis: document.getElementById('quality-analysis').checked,
                tensorflowAnalysis: document.getElementById('tensorflow-analysis').checked,
                imageCompression: document.getElementById('image-compression').checked,
                lazyLoading: document.getElementById('lazy-loading').checked,
                preloadCount: parseInt(document.getElementById('preload-count').value)
            };
        }

        function saveSettings() {
            const settings = getSettings();
            localStorage.setItem('settings', JSON.stringify(settings));
            if (!settings.tensorflowAnalysis && isModelLoaded) {
                imageLoader.aiEngine.tensorflowManager.models = {};
                isModelLoaded = false;
            }
        }

        async function loadImages() {
            document.getElementById('loading-indicator').style.display = 'block';
            currentImages = await imageLoader.loadAllImages();
            
            if (currentImages.length === 0) {
                document.getElementById('no-images').style.display = 'block';
                document.getElementById('images-grid').style.display = 'none';
                document.getElementById('gallery-stats').style.display = 'none';
                return;
            }

            document.getElementById('no-images').style.display = 'none';
            document.getElementById('images-grid').style.display = 'grid';
            document.getElementById('gallery-stats').style.display = 'grid';
            
            await renderImages(currentImages);
            updateGalleryStats();
            preloadImages();
        }

        async function renderImages(images) {
            const grid = document.getElementById('images-grid');
            grid.innerHTML = '';
            
            const settings = getSettings();
            const fragment = document.createDocumentFragment();
            
            for (const image of images) {
                const card = document.createElement('div');
                card.className = 'image-card rounded-xl p-4 glass-effect';
                card.dataset.cacheKey = image.url;
                card.dataset.imageId = image.id;
                
                const img = new Image();
                img.src = image.url;
                img.alt = image.name;
                img.className = 'smart-crop lazy-image';
                
                if (settings.lazyLoading) {
                    img.dataset.src = image.url;
                    img.src = 'data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==';
                }

                const container = document.createElement('div');
                container.className = 'image-container';
                container.innerHTML = '<div class="image-loading pulse-animation"><i class="fas fa-spinner fa-spin text-2xl"></i></div>';
                container.appendChild(img);

                const qualityBadge = document.createElement('div');
                qualityBadge.className = 'quality-badge hidden';

                const preloadIndicator = document.createElement('div');
                preloadIndicator.className = 'preload-indicator hidden';
                preloadIndicator.textContent = 'é¢„åŠ è½½';

                container.appendChild(qualityBadge);
                container.appendChild(preloadIndicator);

                const overlay = document.createElement('div');
                overlay.className = 'ai-analysis-overlay';
                overlay.innerHTML = `
                    <svg class="ai-progress-ring">
                        <circle cx="30" cy="30" r="25" />
                        <circle class="progress" cx="30" cy="30" r="25" />
                    </svg>
                    <p class="high-contrast-text font-semibold mt-2">AIåˆ†æä¸­...</p>
                `;

                container.appendChild(overlay);
                card.appendChild(container);

                const details = document.createElement('div');
                details.className = 'mt-4';
                details.innerHTML = `
                    <h3 class="high-contrast-text font-semibold truncate">${image.name}</h3>
                    <div class="tags flex flex-wrap gap-2 mt-2"></div>
                    <div class="confidence-bar mt-2"></div>
                `;

                card.appendChild(details);
                fragment.appendChild(card);

                img.onload = () => {
                    img.classList.add('loaded');
                    container.querySelector('.image-loading').remove();
                    if (settings.autoAnalyze) {
                        analyzeImage(image, img, card);
                    }
                };

                card.addEventListener('click', () => openImageModal(image, images.indexOf(image)));
            }

            grid.appendChild(fragment);
            
            if (settings.lazyLoading) {
                setupLazyLoading();
            }
        }

        async function analyzeImage(image, imgElement, card) {
            const settings = getSettings();
            if (!settings.autoAnalyze && !card.dataset.analyzed) return;

            card.querySelector('.ai-analysis-overlay').style.opacity = '1';
            const result = await imageLoader.aiEngine.analyzeImage(image, imgElement);
            card.dataset.analyzed = 'true';
            
            updateImageCardAnalysis(card, result);
            aiAnalysisResults.set(image.url, result);
            
            updateTagFilter();
            updateGalleryStats();
        }

        function updateImageCardAnalysis(card, analysis) {
            const tagsContainer = card.querySelector('.tags');
            tagsContainer.innerHTML = '';

            analysis.smartTags.forEach(tag => {
                const tagElement = document.createElement('span');
                tagElement.className = 'tag-item px-2 py-1 rounded-full text-sm';
                tagElement.textContent = tag;
                tagsContainer.appendChild(tagElement);
            });

            const confidenceBar = card.querySelector('.confidence-bar');
            confidenceBar.style.width = `${analysis.confidence * 100}%`;

            const qualityBadge = card.querySelector('.quality-badge');
            if (analysis.quality) {
                qualityBadge.classList.remove('hidden');
                qualityBadge.textContent = analysis.quality.overall > 0.8 ? 'é«˜è´¨é‡' :
                                        analysis.quality.overall > 0.5 ? 'ä¸­ç­‰' : 'ä½è´¨é‡';
                qualityBadge.className = `quality-badge ${analysis.quality.overall > 0.8 ? 'quality-high' : 
                                       analysis.quality.overall > 0.5 ? 'quality-medium' : 'quality-low'}`;
            }

            card.querySelector('.ai-analysis-overlay').style.opacity = '0';
            const progressCircle = card.querySelector('.ai-progress-ring .progress');
            progressCircle.style.strokeDashoffset = 157 - (157 * analysis.confidence);
        }

        function updateTagFilter() {
            const tagFilter = document.getElementById('tag-filter');
            const tags = new Set();

            aiAnalysisResults.forEach(result => {
                result.smartTags.forEach(tag => tags.add(tag));
            });

            tagFilter.innerHTML = '<option value="">æ‰€æœ‰æ ‡ç­¾</option>';
            tags.forEach(tag => {
                const option = document.createElement('option');
                option.value = tag;
                option.textContent = tag;
                tagFilter.appendChild(option);
            });
        }

        function updateGalleryStats() {
            const totalImages = currentImages.length;
            const analyzedImages = Array.from(aiAnalysisResults.values()).length;
            const totalTags = Array.from(aiAnalysisResults.values()).reduce((sum, result) => sum + result.smartTags.length, 0);
            const avgScore = analyzedImages > 0 
                ? (Array.from(aiAnalysisResults.values()).reduce((sum, result) => sum + result.confidence, 0) / analyzedImages).toFixed(2)
                : 0;

            document.getElementById('total-images').textContent = totalImages;
            document.getElementById('analyzed-images').textContent = analyzedImages;
            document.getElementById('total-tags').textContent = totalTags;
            document.getElementById('avg-score').textContent = avgScore;
        }

        function preloadImages() {
            const settings = getSettings();
            const preloadCount = settings.preloadCount;
            const visibleImages = document.querySelectorAll('.image-card:not(.preloaded)');

            visibleImages.forEach((card, index) => {
                if (index < preloadCount) {
                    const img = card.querySelector('img');
                    imageLoader.preloadImage(img.dataset.src || img.src, 'high').then(() => {
                        card.classList.add('preloaded');
                        card.querySelector('.preload-indicator').classList.remove('hidden');
                        setTimeout(() => card.querySelector('.preload-indicator').classList.add('hidden'), 2000);
                    });
                }
            });
        }

        function setupLazyLoading() {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        if (img.dataset.src) {
                            img.src = img.dataset.src;
                            img.classList.add('loaded');
                            observer.unobserve(img);
                        }
                    }
                });
            }, { rootMargin: '200px' });

            document.querySelectorAll('.lazy-image').forEach(img => observer.observe(img));
        }

        function openImageModal(image, index) {
            currentImageIndex = index;
            const modal = document.getElementById('image-detail-modal');
            modal.classList.remove('hidden');

            updateModalContent(image);
        }

        function closeImageModal() {
            document.getElementById('image-detail-modal').classList.add('hidden');
        }

        function updateModalContent(image) {
            const modalImage = document.getElementById('modal-image');
            modalImage.src = image.url;
            modalImage.alt = image.name;

            document.getElementById('modal-title').textContent = image.name;

            const infoContainer = document.getElementById('modal-image-info');
            infoContainer.innerHTML = `
                <p><strong>æ–‡ä»¶å:</strong> ${image.name}</p>
                <p><strong>åŠ è½½æ–¹å¼:</strong> ${image.loadMethod || 'æœªçŸ¥'}</p>
                <p><strong>å¤§å°:</strong> ${image.size ? (image.size / 1024).toFixed(2) + ' KB' : 'æœªçŸ¥'}</p>
                <p><strong>ä¸Šä¼ æ—¶é—´:</strong> ${new Date().toLocaleString()}</p>
            `;

            const analysis = aiAnalysisResults.get(image.url) || imageLoader.aiEngine.getDefaultAnalysis();
            const aiAnalysisContainer = document.getElementById('modal-ai-analysis');
            aiAnalysisContainer.innerHTML = `
                <div class="ai-analysis-item">
                    <h4 class="font-semibold">ç‰©ä½“æ£€æµ‹</h4>
                    ${analysis.objects.map(obj => `
                        <p>${obj.label}: ${(obj.confidence * 100).toFixed(1)}% 
                        ${obj.bbox ? `(ä½ç½®: ${obj.bbox.map(n => n.toFixed(0)).join(', ')})` : ''}</p>
                    `).join('')}
                </div>
                <div class="ai-analysis-item">
                    <h4 class="font-semibold">åœºæ™¯åˆ†ç±»</h4>
                    ${analysis.scenes.map(scene => `
                        <p>${scene.label}: ${(scene.confidence * 100).toFixed(1)}%</p>
                    `).join('')}
                </div>
                <div class="ai-analysis-item">
                    <h4 class="font-semibold">æƒ…æ„Ÿåˆ†æ</h4>
                    ${analysis.emotions.map(emotion => `
                        <p>${emotion.label}: ${(emotion.confidence * 100).toFixed(1)}%</p>
                    `).join('')}
                </div>
                <div class="ai-analysis-item">
                    <h4 class="font-semibold">é¢œè‰²åˆ†æ</h4>
                    ${analysis.colors.map(color => `
                        <p>
                            <span class="inline-block w-4 h-4 mr-2 rounded" style="background: ${color.hex}"></span>
                            ${color.name} (${color.percentage}%)
                        </p>
                    `).join('')}
                </div>
                ${analysis.quality ? `
                    <div class="ai-analysis-item">
                        <h4 class="font-semibold">è´¨é‡åˆ†æ</h4>
                        <p>æ€»ä½“è´¨é‡: ${(analysis.quality.overall * 100).toFixed(1)}%</p>
                        <p>é”åº¦: ${(analysis.quality.sharpness * 100).toFixed(1)}%</p>
                        <p>å™ªå£°: ${(analysis.quality.noise * 100).toFixed(1)}%</p>
                        <p>æ›å…‰: ${(analysis.quality.exposure * 100).toFixed(1)}%</p>
                    </div>
                ` : ''}
                ${analysis.composition ? `
                    <div class="ai-analysis-item">
                        <h4 class="font-semibold">æ„å›¾åˆ†æ</h4>
                        <p>å¯¹ç§°æ€§: ${(analysis.composition.symmetry * 100).toFixed(1)}%</p>
                        <p>ä¸‰åˆ†æ³•åˆ™: ${(analysis.composition.ruleOfThirds * 100).toFixed(1)}%</p>
                        <p>å¹³è¡¡æ€§: ${(analysis.composition.balance * 100).toFixed(1)}%</p>
                    </div>
                ` : ''}
            `;

            const tagsContainer = document.getElementById('modal-tags');
            tagsContainer.innerHTML = '';
            analysis.smartTags.forEach(tag => {
                const tagElement = document.createElement('span');
                tagElement.className = 'tag-item px-2 py-1 rounded-full text-sm removable';
                tagElement.innerHTML = `${tag} <i class="fas fa-times remove-tag"></i>`;
                tagElement.querySelector('.remove-tag').addEventListener('click', () => removeTag(image.url, tag));
                tagsContainer.appendChild(tagElement);
            });

            const notesTextarea = document.getElementById('image-notes');
            notesTextarea.value = imageNotes.get(image.url) || '';

            const customTagsContainer = document.getElementById('custom-tags-container');
            customTagsContainer.innerHTML = '';
            const customImageTags = customTags.get(image.url) || [];
            customImageTags.forEach(tag => {
                const tagElement = document.createElement('span');
                tagElement.className = 'tag-item px-2 py-1 rounded-full text-sm removable';
                tagElement.innerHTML = `${tag} <i class="fas fa-times remove-tag"></i>`;
                tagElement.querySelector('.remove-tag').addEventListener('click', () => removeCustomTag(image.url, tag));
                customTagsContainer.appendChild(tagElement);
            });
        }

        function navigateImage(direction) {
            currentImageIndex = (currentImageIndex + direction + currentImages.length) % currentImages.length;
            updateModalContent(currentImages[currentImageIndex]);
        }

        function saveImageNotes() {
            const image = currentImages[currentImageIndex];
            const notes = document.getElementById('image-notes').value;
            imageNotes.set(image.url, notes);
            showTooltip('âœ… å¤‡æ³¨å·²ä¿å­˜');
        }

        function clearImageNotes() {
            const image = currentImages[currentImageIndex];
            document.getElementById('image-notes').value = '';
            imageNotes.delete(image.url);
            showTooltip('âœ… å¤‡æ³¨å·²æ¸…é™¤');
        }

        function addCustomTag() {
            const image = currentImages[currentImageIndex];
            const tagInput = document.getElementById('custom-tag-input');
            const tag = tagInput.value.trim();
            if (tag) {
                const imageTags = customTags.get(image.url) || [];
                if (!imageTags.includes(tag)) {
                    imageTags.push(tag);
                    customTags.set(image.url, imageTags);
                    updateModalContent(image);
                    tagInput.value = '';
                    showTooltip('âœ… æ ‡ç­¾å·²æ·»åŠ ');
                } else {
                    showTooltip('âš ï¸ æ ‡ç­¾å·²å­˜åœ¨');
                }
            }
        }

        function handleTagInputKeyPress(event) {
            if (event.key === 'Enter') {
                addCustomTag();
            }
        }

        function removeTag(imageUrl, tag) {
            const analysis = aiAnalysisResults.get(imageUrl);
            if (analysis) {
                analysis.smartTags = analysis.smartTags.filter(t => t !== tag);
                aiAnalysisResults.set(imageUrl, analysis);
                updateModalContent(currentImages[currentImageIndex]);
                updateTagFilter();
            }
        }

        function removeCustomTag(imageUrl, tag) {
            const imageTags = customTags.get(imageUrl) || [];
            customTags.set(imageUrl, imageTags.filter(t => t !== tag));
            updateModalContent(currentImages[currentImageIndex]);
        }

        async function downloadCurrentImage() {
            const image = currentImages[currentImageIndex];
            try {
                const response = await fetch(image.url);
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = image.name;
                a.click();
                URL.revokeObjectURL(url);
                showTooltip('âœ… ä¸‹è½½å·²å¼€å§‹');
            } catch (error) {
                showTooltip('âŒ ä¸‹è½½å¤±è´¥');
            }
        }

        async function shareCurrentImage() {
            const image = currentImages[currentImageIndex];
            try {
                if (navigator.share) {
                    await navigator.share({
                        title: image.name,
                        url: image.url
                    });
                    showTooltip('âœ… åˆ†äº«æˆåŠŸ');
                } else {
                    navigator.clipboard.writeText(image.url);
                    showTooltip('âœ… é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                }
            } catch (error) {
                showTooltip('âŒ åˆ†äº«å¤±è´¥');
            }
        }

        async function analyzeCurrentImage() {
            const image = currentImages[currentImageIndex];
            const card = document.querySelector(`[data-cache-key="${image.url}"]`);
            const imgElement = card.querySelector('img');
            await analyzeImage(image, imgElement, card);
            updateModalContent(image);
            showTooltip('âœ… é‡æ–°åˆ†æå®Œæˆ');
        }

        function renderAIAnalysisDetails() {
            const detailsContainer = document.getElementById('ai-analysis-details');
            detailsContainer.innerHTML = '';

            aiAnalysisResults.forEach((analysis, url) => {
                const image = currentImages.find(img => img.url === url);
                if (!image) return;

                const div = document.createElement('div');
                div.className = 'ai-analysis-item';
                div.innerHTML = `
                    <div class="flex items-center space-x-4">
                        <img src="${image.url}" alt="${image.name}" class="w-24 h-24 object-cover rounded-lg">
                        <div>
                            <h3 class="high-contrast-text font-semibold">${image.name}</h3>
                            <p class="text-sm text-gray-500">ç½®ä¿¡åº¦: ${(analysis.confidence * 100).toFixed(1)}%</p>
                            <div class="flex flex-wrap gap-2 mt-2">
                                ${analysis.smartTags.map(tag => `
                                    <span class="tag-item px-2 py-1 rounded-full text-sm">${tag}</span>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
                detailsContainer.appendChild(div);
            });
        }

        async function refreshGallery() {
            document.getElementById('loading-indicator').style.display = 'block';
            aiAnalysisResults.clear();
            await loadImages();
            showTooltip('âœ… å›¾åº“å·²åˆ·æ–°');
        }

        function showTooltip(message, duration = 3000) {
            const tooltip = document.getElementById('tooltip');
            tooltip.textContent = message;
            tooltip.classList.add('show');
            tooltip.style.left = '50%';
            tooltip.style.top = '20px';
            tooltip.style.transform = 'translateX(-50%)';

            setTimeout(() => {
                tooltip.classList.remove('show');
            }, duration);
        }

        function bindEvents() {
            document.getElementById('search-input').addEventListener('input', handleSearch);
            document.getElementById('tag-filter').addEventListener('change', filterImages);
            document.getElementById('sort-option').addEventListener('change', sortImages);
            document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
        }

        function handleSearch(event) {
            const query = event.target.value.toLowerCase();
            const suggestionsContainer = document.getElementById('search-suggestions');
            suggestionsContainer.innerHTML = '';

            if (query.length < 2) {
                suggestionsContainer.classList.add('hidden');
                filterImages();
                return;
            }

            const suggestions = [];
            currentImages.forEach(image => {
                const analysis = aiAnalysisResults.get(image.url) || { smartTags: [] };
                if (image.name.toLowerCase().includes(query) ||
                    analysis.smartTags.some(tag => tag.toLowerCase().includes(query))) {
                    suggestions.push({ image, score: calculateSearchScore(image, query) });
                }
            });

            suggestions.sort((a, b) => b.score - a.score);
            suggestions.slice(0, 5).forEach(suggestion => {
                const div = document.createElement('div');
                div.className = 'search-suggestion-item';
                div.textContent = suggestion.image.name;
                div.addEventListener('click', () => {
                    document.getElementById('search-input').value = suggestion.image.name;
                    filterImages();
                    suggestionsContainer.classList.add('hidden');
                });
                suggestionsContainer.appendChild(div);
            });

            suggestionsContainer.classList.toggle('hidden', suggestions.length === 0);
            filterImages();
        }

        function calculateSearchScore(image, query) {
            let score = 0;
            if (image.name.toLowerCase().includes(query)) {
                score += 0.6;
            }
            const analysis = aiAnalysisResults.get(image.url);
            if (analysis && analysis.smartTags.some(tag => tag.toLowerCase().includes(query))) {
                score += 0.4;
            }
            return score;
        }

        function filterImages() {
            const query = document.getElementById('search-input').value.toLowerCase();
            const selectedTag = document.getElementById('tag-filter').value;
            
            const filteredImages = currentImages.filter(image => {
                const analysis = aiAnalysisResults.get(image.url) || { smartTags: [] };
                const matchesQuery = !query || 
                    image.name.toLowerCase().includes(query) ||
                    analysis.smartTags.some(tag => tag.toLowerCase().includes(query));
                const matchesTag = !selectedTag || analysis.smartTags.includes(selectedTag);
                return matchesQuery && matchesTag;
            });

            renderImages(filteredImages);
        }

        function sortImages() {
            const sortOption = document.getElementById('sort-option').value;
            let sortedImages = [...currentImages];

            switch (sortOption) {
                case 'newest':
                    sortedImages.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                    break;
                case 'oldest':
                    sortedImages.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
                    break;
                case 'name':
                    sortedImages.sort((a, b) => a.name.localeCompare(b.name));
                    break;
                case 'ai-score':
                    sortedImages.sort((a, b) => {
                        const scoreA = (aiAnalysisResults.get(a.url)?.confidence || 0);
                        const scoreB = (aiAnalysisResults.get(b.url)?.confidence || 0);
                        return scoreB - scoreA;
                    });
                    break;
                case 'relevance':
                    const query = document.getElementById('search-input').value.toLowerCase();
                    if (query) {
                        sortedImages.sort((a, b) => calculateSearchScore(b, query) - calculateSearchScore(a, query));
                    }
                    break;
            }

            renderImages(sortedImages);
        }

        function toggleTheme() {
            const currentTheme = JSON.parse(localStorage.getItem('theme') || '{}');
            const themes = [
                { primary: '#3B82F6', secondary: '#10B981', accent: '#F59E0B' },
                { primary: '#1E40AF', secondary: '#065F46', accent: '#B45309' }
            ];
            const nextTheme = themes[(themes.findIndex(t => t.primary === currentTheme.primary) + 1) % themes.length];
            applyTheme(nextTheme);
        }

    </script>
</body>
</html>